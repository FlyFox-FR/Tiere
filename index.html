<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<title>Tiere z√§hlen Ultimate v4.0 üêæ</title>
<meta name="theme-color" content="#121212">

<!-- LEAFLET MAP CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

<style>
:root{--bg:#f4f4f4;--card:#fff;--text:#000;--btn:#e0e0e0;--hover:#eee;--accent:#2196f3;--warn-bg:#fff3cd;--warn-text:#856404;--err-bg:#f8d7da;--err-text:#721c24;--sub:#666; --nav-height: 60px;}
body.dark{--bg:#121212;--card:#1e1e1e;--text:#fff;--btn:#333;--hover:#444;--accent:#64b5f6;--warn-bg:#3d3618;--warn-text:#e8c658;--err-bg:#4c1f24;--err-text:#ff8a96;--sub:#aaa}
body{font-family:system-ui,sans-serif;background:var(--bg);color:var(--text);max-width:980px;margin:auto;padding:16px;padding-bottom:calc(var(--nav-height) + 20px);position:relative; overflow-x:hidden;}

/* Utilities */
.hidden { display: none !important; }
.fade-in { animation: fadeIn 0.3s forwards; }
@keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

/* Header & Toggles */
.header-controls { position:absolute; top:16px; right:16px; display:flex; gap:8px; z-index: 100; }
.icon-btn-header { font-size:18px; background:var(--btn); color:var(--text); border-radius:50%; width:36px; height:36px; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; }
.icon-btn-header.info { background:var(--accent); color:#fff; }

h1 { margin-top: 0; margin-bottom: 20px; font-size: 1.5em; }

/* Views Container */
.view-section { display: none; }
.view-section.active { display: block; animation: fadeIn 0.2s ease-out; }

/* Sticky Bottom Nav */
.bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: var(--nav-height); background: var(--card); border-top: 1px solid var(--btn); display: flex; justify-content: space-around; align-items: center; z-index: 9000; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); padding-bottom: env(safe-area-inset-bottom); }
.nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--sub); cursor: pointer; transition: color 0.2s; font-size: 10px; background: none; border: none; padding: 0; }
.nav-item .nav-icon { font-size: 20px; margin-bottom: 2px; }
.nav-item.active { color: var(--accent); font-weight: bold; }

/* Floating Particles */
.particle { position: fixed; pointer-events: none; font-weight: bold; z-index: 9999; animation: floatUp 0.8s ease-out forwards; font-size: 20px; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
@keyframes floatUp { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; } 100% { transform: translate(-50%, -150px) scale(1.5); opacity: 0; } }

/* Tag Filters */
.tag-scroll { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 5px; scrollbar-width: none; }
.tag-scroll::-webkit-scrollbar { display: none; }
.tag-pill { background: var(--btn); padding: 6px 12px; border-radius: 20px; font-size: 13px; white-space: nowrap; cursor: pointer; border: 1px solid transparent; opacity: 0.7; }
.tag-pill.active { background: var(--accent); color: #fff; opacity: 1; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

/* List Controls (Search & Sort) */
.list-header { display:flex; gap:8px; margin-bottom:10px; }
.search-bar { flex:1; padding:8px 12px; border-radius:20px; border:1px solid var(--btn); background:var(--card); color:var(--text); font-size:14px; }
.sort-btn { padding:8px; border-radius:12px; border:none; background:var(--btn); cursor:pointer; }

/* Map Container */
#map { height: 60vh; width: 100%; border-radius: 12px; z-index: 1; margin-bottom: 20px; border: 2px solid var(--btn); }

/* Standard UI Elements */
button{font-size:16px;padding:8px 14px;border-radius:12px;border:none;background:var(--btn);color:var(--text);cursor:pointer; transition: background 0.2s, transform 0.1s}
button:active{transform: scale(0.95);}
button:hover{background:var(--hover)}
input,select,textarea{padding:10px;font-size:16px;border-radius:10px;border:1px solid #777;background:var(--card);color:var(--text); width: 100%; box-sizing: border-box; border-color: var(--btn); font-family: inherit;}

/* === GRID VIEW STYLES === */
.grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; padding-bottom: 20px; }
.grid-item { background: var(--card); border-radius: 16px; padding: 12px; display: flex; flex-direction: column; align-items: center; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); position: relative; transition: transform 0.1s; border: 1px solid transparent; }
.grid-item:active { transform: scale(0.98); }
.grid-img-wrap { width: 70px; height: 70px; border-radius: 35px; overflow: hidden; margin-bottom: 8px; border: 3px solid var(--bg); box-shadow: 0 4px 8px rgba(0,0,0,0.1); cursor: pointer; display:flex; align-items:center; justify-content:center; font-size:35px; background:var(--btn); }
.grid-img-wrap img { width: 100%; height: 100%; object-fit: cover; }
.grid-name { font-weight: bold; font-size: 14px; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }
.grid-count { background: var(--accent); color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: bold; margin-bottom: 8px; }
.grid-actions { display: flex; gap: 6px; width: 100%; justify-content: center; }
.grid-btn { padding: 8px; border-radius: 8px; background: var(--btn); font-size: 14px; flex: 1; display:flex; align-items:center; justify-content:center; }
.grid-btn.add { background: var(--accent); color: white; flex: 1.5; font-size: 18px; }

/* === LIST VIEW STYLES (Existing) === */
.row{display:flex;align-items:center;gap:6px;background:var(--card);padding:6px 8px;margin-bottom:6px;border-radius:12px;box-shadow: 0 2px 4px rgba(0,0,0,0.05); flex-wrap:nowrap;}
.animal-icon{font-size:24px;width:40px;height:40px;flex-shrink:0;text-align:center;display:flex;align-items:center;justify-content:center; overflow:hidden; border-radius:8px; cursor: pointer; transition: transform 0.2s; border: 1px solid transparent;}
.animal-icon:hover { transform: scale(1.1); border-color: var(--accent); }
.animal-icon img {width:100%; height:100%; object-fit:cover;}
.name{flex:1; font-weight:bold; font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-left: 4px;}
.count{width:30px; text-align:right; font-size:15px; font-weight:bold; margin-right: 6px; flex-shrink:0;}

.row-controls { display:flex; gap:4px; align-items:center; flex-shrink: 0; }
.row-controls button { padding: 0; width: 32px; height: 32px; font-size: 16px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
.row-controls select { width: 70px; padding: 0 4px; font-size: 11px; height: 32px; }

/* === CARD SECTIONS (ADMIN) === */
.card-section { background:var(--card); padding:15px; border-radius:12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
.card-section h3 { margin-top: 0; margin-bottom: 15px; font-size: 1.1em; border-bottom: 1px solid var(--btn); padding-bottom: 10px; }

.add{display:flex;gap:8px;align-items:center;justify-content:center;margin-bottom:10px; flex-wrap: wrap;}
.file-btn { font-size: 24px; cursor: pointer; padding: 0 5px; opacity: 0.8; transition: opacity 0.2s; }
.file-btn:hover { opacity: 1; }

/* === STATISTIK & BADGES STYLES === */
.level-card { background: linear-gradient(135deg, #2196f3, #673ab7); color: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; text-align: center; box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3); }
.level-title { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8; margin-bottom: 5px; }
.level-num { font-size: 36px; font-weight: bold; margin: 5px 0; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
.level-name { font-size: 18px; font-weight: bold; margin-bottom: 15px; }
.xp-bar-bg { background: rgba(255,255,255,0.2); height: 8px; border-radius: 4px; overflow: hidden; margin-top: 10px; }
.xp-bar-fill { background: #fff; height: 100%; width: 0%; transition: width 1s ease-out; box-shadow: 0 0 10px rgba(255,255,255,0.5); }
.xp-text { font-size: 11px; margin-top: 6px; opacity: 0.9; }

.chart-wrap { display: flex; align-items: flex-end; height: 140px; gap: 6px; padding-top: 25px; margin-top: 10px; }
.chart-col { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; }
.chart-bar { width: 100%; background: var(--accent); border-radius: 4px 4px 0 0; opacity: 0.9; min-height: 1px; }
.chart-val { font-size: 10px; margin-bottom: 2px; }
.chart-label { font-size: 10px; margin-top: 4px; transform: rotate(-45deg); height: 20px; text-align: center; }

.badge-grid { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
.badge { background: var(--btn); padding: 6px 10px; border-radius: 20px; font-size: 12px; display: flex; align-items: center; gap: 5px; opacity: 0.4; filter: grayscale(1); transition: all 0.3s; cursor: pointer; user-select: none; border: 1px solid transparent; }
.badge:active { transform: scale(0.95); }
.badge.earned { opacity: 1; filter: grayscale(0); background: rgba(33, 150, 243, 0.15); border-color: var(--accent); color: var(--accent); font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
.badge-icon { font-size: 16px; }

.heatmap-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; max-width: 320px; margin: 10px auto; }
.heat-cell { aspect-ratio: 1; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: transparent; background: var(--btn); }

.stat-kpi-row { display:flex; gap:10px; justify-content:space-around; margin-bottom:15px; text-align:center; }
.stat-kpi { background:var(--card); padding:10px; border-radius:8px; flex:1; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

.hbar-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 14px; }
.hbar-label { flex: 1; text-align: left; opacity: 0.9; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 0; }
.hbar-track { width: 40%; flex: none; background: var(--btn); height: 12px; border-radius: 6px; overflow: hidden; }
.hbar-fill { height: 100%; background: var(--accent); }
.hbar-val { font-size: 12px; width: 25px; text-align:right; font-weight:bold; flex:none; }

/* History List Styles */
.history-list { margin-top: 15px; border-top: 1px solid var(--btn); }
.hist-item { display: flex; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--btn); align-items: flex-start; }
.hist-date { font-size: 12px; opacity: 0.7; width: 70px; flex-shrink: 0; }
.hist-info { flex: 1; font-size: 14px; }
.hist-note { background: var(--btn); padding: 2px 6px; border-radius: 4px; font-size: 12px; display: inline-block; margin-top: 4px; }
.hist-actions { display: flex; gap: 4px; }
.icon-btn { padding: 4px 8px; font-size: 14px; background: var(--btn); border:none; border-radius:4px; cursor:pointer;}
.modal-header { text-align: center; border-bottom: 1px solid var(--btn); padding-bottom: 15px; margin-bottom: 15px; }
.modal-icon img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid var(--accent); }
.modal-icon { font-size: 60px; line-height: 1; display: block; margin-bottom: 10px; }
a.map-link, a.map-link:visited { color: var(--accent); text-decoration: none; border-bottom: 1px dotted currentColor; }

/* Accordion Details */
details { margin-bottom: 12px; border-bottom: 1px solid var(--btn); padding-bottom: 12px; background: var(--card); padding: 10px; border-radius: 8px; }
summary { font-weight: bold; cursor: pointer; list-style: none; display: flex; align-items: center; justify-content: space-between; padding: 4px 0; }
summary::after { content: '+'; font-size: 18px; opacity: 0.6; }
details[open] summary::after { content: '-'; }

/* Modals & Autocomplete */
.modal { display: none; position: fixed; z-index: 9995; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(5px); }
.modal-content { background-color: var(--card); margin: 15% auto; padding: 20px; border-radius: 16px; width: 90%; max-width: 600px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
.close-btn { position: absolute; top: 15px; right: 20px; color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
.autocomplete-container { flex: 1; position: relative; }
.autocomplete-results { position: absolute; top: 100%; left: 0; right: 0; background: var(--card); border: 1px solid #aaa; z-index: 1000; display: none; max-height: 200px; overflow-y: auto; }
.suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid var(--btn); font-size: 14px; }
.error-toast { position: fixed; bottom: 80px; right: 20px; background: var(--err-bg); color: var(--err-text); padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 9999; font-size: 14px; display: none; animation: fadeIn 0.3s; border: 1px solid var(--err-text);}

.info-box{display:none;background:var(--card);padding:16px;border-radius:12px;margin-bottom:16px; margin-top: 50px;}

/* Custom Import Modal Buttons */
.import-actions { display: flex; flex-direction: column; gap: 12px; margin-top: 20px; }
.btn-merge { background: var(--accent); color: white; padding: 12px; font-weight: bold; }
.btn-overwrite { background: var(--err-bg); color: var(--err-text); padding: 12px; border: 1px solid var(--err-text); }
.btn-cancel { background: var(--btn); color: var(--text); padding: 12px; }

/* Storage Bar */
.storage-wrap { margin-top: 15px; font-size: 11px; opacity: 0.8; }
.storage-track { width: 100%; height: 6px; background: var(--btn); border-radius: 3px; margin-top: 5px; overflow: hidden; }
.storage-fill { height: 100%; background: var(--accent); transition: width 0.5s; }

/* Switch */
.switch { position: relative; display: inline-block; width: 50px; height: 26px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
.slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: var(--accent); }
input:checked + .slider:before { transform: translateX(24px); }
</style>
</head>
<body>

<!-- Error Toast Container -->
<div id="errorToast" class="error-toast"></div>

<!-- HEADER: Buttons oben rechts -->
<div class="header-controls">
  <button class="icon-btn-header" onclick="safeRun(openNotifySettings)" title="Einstellungen & Erinnerungen">üîî</button>
  <button class="icon-btn-header" onclick="safeRun(toggleMute)" id="muteBtn" title="Ton an/aus">üîá</button>
  <button class="icon-btn-header info" onclick="safeRun(toggleInfo)" title="Hilfe anzeigen">‚ÑπÔ∏è</button>
</div>

<h1>Tiere z√§hlen Ult. üêæ</h1>

<!-- VEREINFACHTE INFO BOX F√úR ENDANWENDER -->
<div id="infoBox" class="info-box">
<h3>Willkommen! üêæ</h3>
<p>Hier kannst du ganz einfach deine Tierbeobachtungen festhalten.</p>
<ul style="line-height:1.6; padding-left:20px;">
<li><strong>‚ûï Tiere anlegen:</strong> Gehe unten auf "Verwalten", um neue Tiere zu deiner Liste hinzuzuf√ºgen.</li>
<li><strong>üî¢ Z√§hlen:</strong> Nutze nur das + in der Liste. Korrekturen √ºber das Diagramm-Icon üìà.</li>
<li><strong>üìù Notizen:</strong> Klicke auf das Stift-Symbol üìù, um Details zu notieren.</li>
<li><strong>üìà Verlauf & L√∂schen:</strong> Klicke auf das Diagramm-Symbol üìà, um den Verlauf zu sehen, zu korrigieren oder Tiere zu l√∂schen.</li>
<li><strong>üèÜ Erfolge:</strong> Schau in der "Statistik" vorbei!</li>
</ul>
</div>

<!-- === VIEW: LIST (Startseite) === -->
<div id="view-list" class="view-section active">
  <!-- Controls -->
  <div class="list-header">
      <input id="listSearch" class="search-bar" placeholder="üîç Tier suchen..." oninput="safeRun(render)">
      <!-- TOGGLE VIEW BUTTON -->
      <button class="sort-btn" onclick="safeRun(toggleViewMode)" id="viewToggleBtn" title="Ansicht wechseln">üìú</button>
      <button class="sort-btn" onclick="safeRun(cycleSort)" id="sortBtn" title="Sortieren">üî§</button>
  </div>

  <!-- Tag Filters -->
  <div id="tagFilterContainer" class="tag-scroll">
      <div class="tag-pill active" onclick="safeRun(filterTags, 'ALL')" id="tag-ALL">Alle</div>
      <!-- Dynamisch gef√ºllt -->
  </div>

  <div id="list"></div>
  <div id="emptyState" style="text-align:center; padding:40px; color:var(--sub); display:none;">
      <div style="font-size:40px; margin-bottom:10px">üêæ</div>
      Keine Tiere gefunden.<br>Lege unter "Verwalten" welche an!
  </div>
</div>

<!-- === VIEW: VERWALTEN (Ehemals Admin) === -->
<div id="view-admin" class="view-section">
  
  <!-- BUBBLE 1: NEUES TIER -->
  <div class="card-section">
    <h3>üêæ Neues Tier anlegen</h3>
    <div class="add">
      <label class="file-btn" for="fileUpload" title="Aus Galerie w√§hlen">üñºÔ∏è</label>
      <input type="file" id="fileUpload" hidden accept="image/*" onchange="safeRun(handleImageUpload, this)">
      <label class="file-btn" for="cameraUpload" title="Foto aufnehmen">üì∑</label>
      <input type="file" id="cameraUpload" hidden accept="image/*" capture="environment" onchange="safeRun(handleImageUpload, this)">
      
      <input id="emojiInput" placeholder="ü¶Å" size="3" style="width:50px; text-align:center">
      <input id="nameInput" placeholder="Name des Tiers" style="flex:2">
    </div>
    
    <div style="margin-bottom:10px">
        <input id="tagInput" placeholder="Kategorie (z.B. V√∂gel, S√§uger)..." list="tagSuggestions">
        <datalist id="tagSuggestions">
            <option value="V√∂gel">
            <option value="S√§ugetiere">
            <option value="Insekten">
            <option value="Fische">
        </datalist>
    </div>
    
    <button onclick="safeRun(addAnimal)" style="width:100%; background:var(--accent); color:#fff">Tier speichern ‚ûï</button>
    
    <div id="imgPreview" style="text-align:center; display:none; margin-top:10px;">
        <img id="previewEl" src="" style="width:50px; height:50px; border-radius:50%; object-fit:cover; border:2px solid var(--accent)">
        <br><small style="cursor:pointer; color:red" onclick="safeRun(clearImage)">Bild entfernen ‚úñ</small>
    </div>
  </div>

  <!-- BUBBLE 2: ORTE -->
  <div class="card-section">
    <h3>üìç Orte & Suche</h3>
    <p style="font-size:12px; opacity:0.7; margin-bottom:10px">Suche Orte oder nutze GPS, um die Adresse automatisch zu finden.</p>
    <div style="display:flex; gap:8px; align-items:flex-start; position:relative;">
        <div class="autocomplete-container">
          <input id="osmInput" placeholder="Ort suchen (z.B. Berlin Zoo)...">
          <div id="osmResults" class="autocomplete-results"></div>
        </div>
        <button onclick="safeRun(locateMe)" title="Mein Standort" style="background:var(--card); border:1px solid var(--btn); min-width:40px">üìç GPS</button>
        <button onclick="safeRun(addManualLocation)" style="min-width:40px;">üíæ</button>
    </div>
    <div style="margin-top:10px; font-size:13px; opacity:0.8">
        Gespeicherte Orte: <span id="locationListDisplay">Keine</span>
    </div>
  </div>

  <!-- BUBBLE 3: DATEN -->
  <div class="card-section">
    <h3>üíæ Daten & Sicherung</h3>
    <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-top:10px;">
        <button onclick="safeRun(toggleDarkMode)">üåô Design</button>
        <button onclick="safeRun(downloadBackup)">üíæ Backup</button>
        <button onclick="safeRun(exportCSV)">üì§ Liste (CSV)</button>
        <!-- IMPORT WITH MERGE -->
        <input type="file" id="importFile" accept="application/json" hidden onchange="safeRun(importBackup, event)">
        <button onclick="document.getElementById('importFile').click()">üìÇ Import</button>
    </div>
    
    <!-- Speicher Anzeige -->
    <div class="storage-wrap">
        <div style="display:flex; justify-content:space-between">
            <span>Browser Speicher:</span>
            <span id="storageText">0%</span>
        </div>
        <div class="storage-track"><div id="storageBar" class="storage-fill" style="width:0%"></div></div>
    </div>
  </div>

  <!-- GEFAHRENZONE -->
  <div style="margin-top:40px; border-top:2px dashed #ccc; padding-top:20px; text-align:center">
      <p style="color:red; font-weight:bold; font-size:12px; margin-bottom:10px">‚ö†Ô∏è GEFAHRENZONE</p>
      <button onclick="safeRun(hardReset)" style="background:#d32f2f; color:white; font-weight:bold; width:100%; padding:15px; border:2px solid #b71c1c;">
          üß® ALLE DATEN L√ñSCHEN
      </button>
  </div>
</div>

<!-- === VIEW: MAP (Karte) === -->
<div id="view-map" class="view-section">
    <h3>üåç Meine Karte</h3>
    <div id="map"></div>
    <div style="text-align:center; font-size:12px; opacity:0.7">
        Hier siehst du, wo du Tiere gez√§hlt hast.
    </div>
</div>

<!-- === VIEW: STATS (Statistik) === -->
<div id="view-stats" class="view-section">
  <div id="statsContainer">
    <div id="statsContent"></div>
    <div style="text-align:center; margin-top:20px">
        <button onclick="safeRun(generateShareCard)">üé® Bild teilen</button>
    </div>
  </div>
</div>

<!-- === BOTTOM NAV === -->
<div class="bottom-nav">
    <button class="nav-item active" onclick="safeRun(switchView, 'view-list', this)">
        <span class="nav-icon">üìã</span>
        <span>Liste</span>
    </button>
    <button class="nav-item" onclick="safeRun(switchView, 'view-admin', this)">
        <span class="nav-icon">‚öôÔ∏è</span>
        <span>Verwalten</span>
    </button>
    <button class="nav-item" onclick="safeRun(switchView, 'view-map', this)">
        <span class="nav-icon">üó∫Ô∏è</span>
        <span>Karte</span>
    </button>
    <button class="nav-item" onclick="safeRun(switchView, 'view-stats', this)">
        <span class="nav-icon">üìä</span>
        <span>Statistik</span>
    </button>
</div>

<!-- MODALS (Hidden) -->
<div id="detailModal" class="modal"><div class="modal-content"><span class="close-btn" onclick="closeModal('detailModal')">&times;</span><div id="modalBody"></div></div></div>

<div id="noteModal" class="modal">
  <div class="modal-content" style="max-width:400px">
    <span class="close-btn" onclick="closeModal('noteModal')">&times;</span>
    <h3 id="noteTitle">Sichtung notieren</h3>
    <input type="date" id="noteDate" style="margin-bottom:8px">
    <input type="time" id="noteTime" style="margin-bottom:8px">
    <select id="noteLoc" style="margin-bottom:8px"></select>
    <textarea id="noteText" placeholder="Notiz" rows="3" style="margin-bottom:10px"></textarea>
    <button id="noteSaveBtn" style="width:100%; background:var(--accent); color:#fff">Speichern</button>
  </div>
</div>

<!-- NEW IMPORT MODAL -->
<div id="importModal" class="modal">
  <div class="modal-content" style="max-width:350px; text-align:center">
    <h3>Backup Importieren</h3>
    <p style="font-size:14px; opacity:0.8; margin-bottom:20px;">Wie m√∂chtest du die Daten importieren?</p>
    
    <div class="import-actions">
        <button class="btn-merge" onclick="safeRun(confirmImport, 'merge')">‚ú® Zusammenf√ºgen (Merge)<br><small style="font-weight:normal; font-size:11px">F√ºgt neue Daten hinzu (keine Doppelten)</small></button>
        <button class="btn-overwrite" onclick="safeRun(confirmImport, 'overwrite')">‚ö†Ô∏è Alles √úberschreiben<br><small style="font-weight:normal; font-size:11px">L√∂scht aktuelle Daten komplett</small></button>
        <button class="btn-cancel" onclick="safeRun(confirmImport, 'cancel')">Abbrechen</button>
    </div>
  </div>
</div>

<div id="iconModal" class="modal">
  <div class="modal-content" style="max-width:320px; text-align:center">
    <span class="close-btn" onclick="closeModal('iconModal')">&times;</span>
    <h3>Bild bearbeiten</h3>
    <div style="margin:20px 0; display:flex; gap:10px;">
       <label for="editFileInput" class="file-btn" style="border:1px solid var(--btn);flex:1">üñºÔ∏è</label>
       <input type="file" id="editFileInput" hidden accept="image/*" onchange="safeRun(handleEditFile, this)">
       <label for="editCameraInput" class="file-btn" style="border:1px solid var(--btn);flex:1">üì∑</label>
       <input type="file" id="editCameraInput" hidden accept="image/*" capture="environment" onchange="safeRun(handleEditFile, this)">
    </div>
    <div id="editPreviewContainer" style="margin-bottom:15px; display:none">
        <img id="editPreviewImg" src="" style="width:80px; height:80px; border-radius:50%; object-fit:cover;">
        <br><small style="color:red; cursor:pointer" onclick="safeRun(removeEditImage)">Entfernen</small>
    </div>
    <div style="margin-bottom:20px">
       <input id="editEmoji" style="width:60px; font-size:30px; text-align:center" placeholder="ü¶Å">
       <input id="editTag" placeholder="Kategorie (Tag)" style="margin-top:10px">
    </div>
    <button onclick="safeRun(saveIconEdit)" style="width:100%; background:var(--accent); color:#fff">Speichern</button>
  </div>
</div>

<div id="notifyModal" class="modal">
  <div class="modal-content" style="max-width:350px;">
    <span class="close-btn" onclick="closeModal('notifyModal')">&times;</span>
    <h3>üîî Einstellungen</h3>
    <div class="notify-row" style="display:flex;justify-content:space-between;margin-bottom:10px">
        <span>Inaktivit√§ts-Alarm:</span>
        <label class="switch"><input type="checkbox" id="notifyToggle"><span class="slider"></span></label>
    </div>
    <div class="notify-row" style="margin-bottom:20px">
        <span>Nach Tagen:</span> <input type="number" id="notifyDays" value="7" style="width:60px">
    </div>
    <div style="display:flex; gap:10px; margin-bottom:20px">
        <button onclick="safeRun(saveNotifySettings)" style="flex:1; background:var(--accent); color:#fff">Speichern</button>
        <button onclick="safeRun(testNotification)" style="flex:1;">Test</button>
    </div>
    <hr>
    <h4>üìÖ Kalender-Export</h4>
    <div style="display:flex; gap:5px; margin-bottom:10px">
        <select id="icsFreq"><option value="WEEKLY">W√∂chentlich</option><option value="DAILY">T√§glich</option></select>
        <input type="time" id="icsTime" value="19:00">
    </div>
    <select id="icsDay" style="margin-bottom:10px"><option value="SA">Samstag</option><option value="SU">Sonntag</option></select>
    <button onclick="safeRun(downloadICS)" style="width:100%">üìÖ ICS Datei laden</button>
  </div>
</div>

<!-- Leaflet Script -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
// === CORE HELPERS ===
function showErrorToast(msg, isInfo = false) {
    const t = document.getElementById('errorToast');
    if(!t) return;
    t.innerText = (isInfo ? "‚ÑπÔ∏è " : "‚ö†Ô∏è ") + msg;
    t.style.background = isInfo ? "var(--accent)" : "var(--err-bg)";
    t.style.color = isInfo ? "#fff" : "var(--err-text)";
    t.style.display = 'block';
    setTimeout(() => { t.style.display = 'none'; }, 4000);
}
function safeRun(func, ...args) {
    try { func(...args); } catch (e) { console.error(e); showErrorToast(e.message); }
}
const getEl = (id) => document.getElementById(id);

// === GLOBALS ===
const year = new Date().getFullYear();
let animals = []; // { name, emoji, image, tags:[] }
let history = {};
let colors = {};
let locations = []; // Array of strings (names)
let locCoords = {}; // Object: { "Name": {lat: 12.3, lon: 45.6} }
let dark = false;
let currentImage = null;
let currentFilter = 'ALL';
let sortMode = 'name'; // name, count, recent
let viewMode = 'list'; // 'list' or 'grid'
let isMuted = localStorage.getItem('muted') !== 'false';
let notifyConfig = JSON.parse(localStorage.getItem('notifyConfig')) || { enabled: false, days: 7 };
let mapInstance = null;
let mapMarkers = [];
let tempImportData = null; // Stores imported JSON during modal selection

const today = () => new Date().toISOString().slice(0,10);
const nowTime = () => new Date().toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'});

// === LEVEL CONFIGURATION ===
const levels = [
    { xp: 0, name: "Garten-Gucker" },
    { xp: 100, name: "Park-Besucher" },
    { xp: 250, name: "Spuren-Sucher" },
    { xp: 500, name: "Wald-Wanderer" },
    { xp: 800, name: "Hobby-Beobachter" },
    { xp: 1200, name: "Fernglas-Profi" },
    { xp: 1700, name: "Vogel-Versteher" },
    { xp: 2300, name: "Pfadfinder" },
    { xp: 3000, name: "Natur-Freund" },
    { xp: 3800, name: "Feld-Forscher" }, // 10
    { xp: 4700, name: "Tier-Fl√ºsterer" },
    { xp: 5700, name: "Wildnis-Entdecker" },
    { xp: 6800, name: "F√§hrtenleser" },
    { xp: 8000, name: "Dschungel-Guide" },
    { xp: 9500, name: "√ñkosystem-Experte" }, // 15
    { xp: 11500, name: "Wald-Ranger" },
    { xp: 14000, name: "Meister-Biologe" },
    { xp: 17000, name: "Nationalpark-Direktor" },
    { xp: 20000, name: "Tier-Orakel" },
    { xp: 25000, name: "H√ºter der Wildnis" } // 20
];

// === SOUND ===
const AudioContext = window.AudioContext || window.webkitAudioContext;
let audioCtx; 
try { audioCtx = new AudioContext(); } catch(e){}
function toggleMute(){ isMuted = !isMuted; localStorage.setItem('muted', isMuted); getEl('muteBtn').innerText = isMuted ? 'üîá' : 'üîä'; }
function playSound(type){
    if(isMuted || !audioCtx) return;
    if(audioCtx.state === 'suspended') audioCtx.resume();
    const now = audioCtx.currentTime;
    const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
    osc.connect(g); g.connect(audioCtx.destination);
    if(type==='pop'){
        osc.frequency.setValueAtTime(800, now); osc.frequency.exponentialRampToValueAtTime(1200, now+0.1);
        g.gain.setValueAtTime(0.05, now); g.gain.exponentialRampToValueAtTime(0.001, now+0.1);
        osc.start(now); osc.stop(now+0.1);
    } else if(type==='fanfare'){
        [440, 554, 659].forEach((f,i)=>{
             const o=audioCtx.createOscillator(); const gn=audioCtx.createGain();
             o.connect(gn); gn.connect(audioCtx.destination);
             o.frequency.value=f; gn.gain.setValueAtTime(0.05, now+i*0.1); gn.gain.linearRampToValueAtTime(0, now+i*0.1+0.5);
             o.start(now+i*0.1); o.stop(now+i*0.1+0.5);
        });
    }
}

// === LOAD / SAVE ===
function loadData() {
    try {
        const a = localStorage.getItem('animals-'+year); animals = a ? JSON.parse(a) : [];
        animals.forEach(an => { if(!an.tags) an.tags = []; });
        
        const h = localStorage.getItem('history-'+year); history = h ? JSON.parse(h) : {};
        const c = localStorage.getItem('colors-'+year); colors = c ? JSON.parse(c) : {};
        const l = localStorage.getItem('locations-'+year); locations = l ? JSON.parse(l) : [];
        const lc = localStorage.getItem('locCoords-'+year); locCoords = lc ? JSON.parse(lc) : {};
        
        dark = localStorage.getItem('darkmode')==='true';
        if(dark) document.body.classList.add('dark');
        
        const vm = localStorage.getItem('viewMode');
        if(vm) viewMode = vm;

        updateStorageUsage();
    } catch(e) { animals=[]; }
}
loadData();

const safeSave = () => {
    localStorage.setItem('animals-'+year, JSON.stringify(animals));
    localStorage.setItem('history-'+year, JSON.stringify(history));
    localStorage.setItem('colors-'+year, JSON.stringify(colors));
    localStorage.setItem('locations-'+year, JSON.stringify(locations));
    localStorage.setItem('locCoords-'+year, JSON.stringify(locCoords));
    renderLocationList();
    updateStorageUsage();
};

function updateStorageUsage() {
    try {
        let total = 0;
        for (let x in localStorage) {
            if (localStorage.hasOwnProperty(x)) total += ((localStorage[x].length * 2) / 1024 / 1024);
        }
        const pct = Math.min((total / 5) * 100, 100).toFixed(1);
        const bar = getEl('storageBar');
        const txt = getEl('storageText');
        if(bar && txt) {
            bar.style.width = pct + '%';
            bar.style.background = pct > 90 ? 'var(--err-text)' : (pct > 70 ? 'var(--warn-text)' : 'var(--accent)');
            txt.innerText = pct + '% (' + total.toFixed(2) + ' MB)';
        }
    } catch(e) {}
}

// === NAVIGATION ===
function switchView(viewId, btn) {
    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
    getEl(viewId).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    if(btn) btn.classList.add('active');
    if(viewId === 'view-map') setTimeout(initMap, 200); 
    if(viewId === 'view-stats') renderStats();
}

// === PARTICLES ===
function spawnParticle(x, y, text, color = 'var(--accent)') {
    const p = document.createElement('div');
    p.className = 'particle';
    p.innerText = text;
    p.style.left = x + 'px';
    p.style.top = y + 'px';
    p.style.color = color;
    document.body.appendChild(p);
    setTimeout(() => p.remove(), 900);
}

// === LOGIC ===
function addAnimal(){
    const nm = getEl('nameInput').value.trim();
    const em = getEl('emojiInput').value || 'üì∏';
    const tag = getEl('tagInput').value.trim();
    if(!nm) return showErrorToast("Name fehlt");
    const tags = tag ? [tag] : [];
    animals.push({ name:nm, emoji:em, image:currentImage, tags: tags });
    getEl('nameInput').value=''; getEl('emojiInput').value=''; getEl('tagInput').value='';
    clearImage();
    safeSave(); render();
    showErrorToast("Tier hinzugef√ºgt", true);
}

function change(i, delta, event){
    try {
        // === CHECK LOCATION IF ADDING ===
        if (delta > 0) {
            const locSel = getEl(viewMode === 'grid' ? 'locSelectGrid'+i : 'locSelect'+i);
            const locationValue = locSel ? locSel.value : '';
            // If locations exist AND none is selected -> Confirm
            if (locations.length > 0 && locationValue === '') {
                if (!confirm("‚ö†Ô∏è Kein Ort ausgew√§hlt.\n\nTrotzdem ohne Ort hinzuf√ºgen?")) {
                    return; 
                }
            }
        }
        
        const t = new Date().toISOString().slice(0,10);
        history[t] = history[t] || { total:0, perAnimal:{} };
        history[t].perAnimal[i] = history[t].perAnimal[i] || [];
        
        if(delta > 0){
            playSound('pop');
            const locSel = getEl(viewMode === 'grid' ? 'locSelectGrid'+i : 'locSelect'+i);
            history[t].perAnimal[i].push({ location: locSel?locSel.value:'', time: new Date().toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'}) });
            history[t].total++;
            if(event) {
                const a = animals[i];
                spawnParticle(event.clientX, event.clientY, "+1 " + (a.emoji||''));
            }
        } else {
            if(history[t].perAnimal[i].length === 0) return;
            history[t].perAnimal[i].pop();
            history[t].total--;
            if(history[t].perAnimal[i].length===0) delete history[t].perAnimal[i];
            if(history[t].total<=0) delete history[t];
            if(event) spawnParticle(event.clientX, event.clientY, "-1", "red");
        }
        safeSave(); render();
    } catch(e) { console.error(e); }
}

// === TAGS, SEARCH & FILTER ===
function filterTags(tag) {
    currentFilter = tag;
    document.querySelectorAll('.tag-pill').forEach(p => p.classList.remove('active'));
    const btn = getEl('tag-' + tag.replace(/\s/g,'_'));
    if(btn) btn.classList.add('active');
    render();
}
function cycleSort(){
    if(sortMode==='name') { sortMode='count'; getEl('sortBtn').innerText='üî¢'; }
    else if(sortMode==='count') { sortMode='name'; getEl('sortBtn').innerText='üî§'; }
    render();
}
function toggleViewMode() {
    viewMode = viewMode === 'list' ? 'grid' : 'list';
    localStorage.setItem('viewMode', viewMode);
    getEl('viewToggleBtn').innerText = viewMode === 'list' ? 'üìú' : '‚ñ¶';
    render();
}

function render(){
    const list = getEl('list'); list.innerHTML = '';
    
    // Update Toggle Icon based on state
    getEl('viewToggleBtn').innerText = viewMode === 'list' ? 'üìú' : '‚ñ¶';

    const searchVal = getEl('listSearch').value.toLowerCase();
    
    // Tag Filters
    const allTags = new Set();
    animals.forEach(a => { if(a.tags) a.tags.forEach(t => allTags.add(t)); });
    const tagCont = getEl('tagFilterContainer');
    let tagHTML = `<div class="tag-pill ${currentFilter==='ALL'?'active':''}" onclick="safeRun(filterTags, 'ALL')" id="tag-ALL">Alle</div>`;
    allTags.forEach(t => {
        const id = 'tag-' + t.replace(/\s/g,'_');
        tagHTML += `<div class="tag-pill ${currentFilter===t?'active':''}" onclick="safeRun(filterTags, '${t}')" id="${id}">${t}</div>`;
    });
    tagCont.innerHTML = tagHTML;

    // Filter & Sort
    let displayList = animals.map((a, i) => {
        let count = 0;
        Object.values(history).forEach(h => { if(h.perAnimal && h.perAnimal[i]) count += h.perAnimal[i].length; });
        return { ...a, idx: i, count };
    }).filter(a => {
        if(currentFilter !== 'ALL' && (!a.tags || !a.tags.includes(currentFilter))) return false;
        if(searchVal && !a.name.toLowerCase().includes(searchVal)) return false;
        return true;
    });

    if(displayList.length === 0) { getEl('emptyState').style.display='block'; return; }
    else getEl('emptyState').style.display='none';

    if(sortMode === 'name') displayList.sort((a,b) => a.name.localeCompare(b.name));
    else if(sortMode === 'count') displayList.sort((a,b) => b.count - a.count);

    if (viewMode === 'grid') {
        // === GRID VIEW RENDER ===
        const gridCont = document.createElement('div');
        gridCont.className = 'grid-container';
        
        displayList.forEach(item => {
            const i = item.idx;
            colors[i] = colors[i] || `hsl(${i*57%360},70%,50%)`;
            
            const card = document.createElement('div'); card.className = 'grid-item';
            
            const imgContent = item.image 
                ? `<img src="${item.image}">` 
                : `<div style="font-size:30px">${item.emoji}</div>`;
            
            let locHTML = locations.length 
            ? `<select id="locSelectGrid${i}" style="width:100%; margin-bottom:6px; font-size:11px; padding:2px"><option value="">üìç Ort?</option>${locations.map(l=>`<option>${l}</option>`).join('')}</select>` 
            : '';

            card.innerHTML = `
                <div class="grid-img-wrap" onclick="safeRun(openIconEdit, ${i})">${imgContent}</div>
                <div class="grid-name">${item.name}</div>
                <div class="grid-count">${item.count}</div>
                ${locHTML}
                <div class="grid-actions">
                    <button class="grid-btn" onclick="safeRun(openDetail,${i})">üìà</button>
                    <button class="grid-btn add" onclick="safeRun(change,${i},1, event)">+</button>
                    <button class="grid-btn" onclick="safeRun(openNoteModal,${i})">üìù</button>
                </div>
            `;
            gridCont.appendChild(card);
        });
        list.appendChild(gridCont);

    } else {
        // === LIST VIEW RENDER ===
        displayList.forEach(item => {
            const i = item.idx;
            colors[i] = colors[i] || `hsl(${i*57%360},70%,50%)`;
            
            const div = document.createElement('div'); div.className = 'row';
            const iconHTML = item.image 
                ? `<div class="animal-icon" onclick="safeRun(openIconEdit, ${i})"><img src="${item.image}"></div>` 
                : `<div class="animal-icon" onclick="safeRun(openIconEdit, ${i})">${item.emoji}</div>`;
            
            let locHTML = locations.length 
                ? `<select id="locSelect${i}"><option value="">üìç Ort?</option>${locations.map(l=>`<option>${l}</option>`).join('')}</select>` 
                : '';

            div.innerHTML = `
                ${iconHTML}
                <div class="name">
                    ${item.name} 
                    ${item.tags && item.tags.length ? `<span style="font-size:10px; opacity:0.6; display:block">${item.tags.join(', ')}</span>` : ''}
                </div>
                <div class="row-controls">
                    ${locHTML}
                    <div class="count">${item.count}</div>
                    <button onclick="safeRun(change,${i},1, event)" style="background:var(--accent);color:#fff; width:36px; height:36px">‚ûï</button>
                    <button onclick="safeRun(openNoteModal,${i})" style="background:var(--bg)">üìù</button>
                    <button onclick="safeRun(openDetail,${i})" style="background:var(--bg)">üìà</button>
                </div>
            `;
            list.appendChild(div);
        });
    }
    renderLocationList();
}

// === FIX: COMPLETELY REMOVE ANIMAL & HISTORY AND SHIFT INDICES ===
function removeAnimal(i){ 
    if(!confirm("Dieses Tier und alle Statistiken unwiderruflich l√∂schen?")) return;

    // 1. Remove from animals array
    animals.splice(i, 1);

    // 2. Rebuild history for EVERY day
    Object.keys(history).forEach(date => {
        const dayData = history[date];
        if (!dayData.perAnimal) return;

        const newPerAnimal = {};
        let newTotal = 0;

        // Iterate old indices
        Object.entries(dayData.perAnimal).forEach(([idxStr, sightings]) => {
            const idx = parseInt(idxStr);
            if (idx === i) {
                // DELETE: Do not copy to new object
            } else if (idx > i) {
                // SHIFT DOWN: Index 5 becomes 4
                newPerAnimal[idx - 1] = sightings;
                newTotal += sightings.length;
            } else {
                // KEEP: Indices lower than i stay same
                newPerAnimal[idx] = sightings;
                newTotal += sightings.length;
            }
        });

        // Save corrected data
        dayData.perAnimal = newPerAnimal;
        dayData.total = newTotal;

        // Remove empty days
        if (newTotal === 0 && Object.keys(newPerAnimal).length === 0) {
            delete history[date];
        }
    });

    safeSave(); 
    closeModal('detailModal');
    render(); 
    showErrorToast("Tier komplett gel√∂scht", true);
}

// === HARD RESET FUNCTION ===
function hardReset() {
    if(!confirm("‚ö†Ô∏è ACHTUNG: M√∂chtest du wirklich ALLE deine Daten (Tiere, Statistiken, Orte) unwiderruflich l√∂schen?")) return;
    if(!confirm("‚ò†Ô∏è LETZTE WARNUNG: Dies kann nicht r√ºckg√§ngig gemacht werden! Wirklich alles l√∂schen?")) return;

    // Reset Vars
    animals = [];
    history = {};
    colors = {};
    locations = [];
    locCoords = {};

    safeSave();
    render();
    showErrorToast("Alles gel√∂scht. Tabula rasa!", true);
}

// === MAP LOGIC ===
function initMap() {
    if(mapInstance) { mapInstance.invalidateSize(); renderMapMarkers(); return; }
    let center = [51.165, 10.451]; 
    const keys = Object.keys(locCoords);
    if(keys.length > 0) center = [locCoords[keys[0]].lat, locCoords[keys[0]].lon];
    mapInstance = L.map('map').setView(center, 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap', maxZoom: 19 }).addTo(mapInstance);
    renderMapMarkers();
}

function renderMapMarkers() {
    mapMarkers.forEach(m => mapInstance.removeLayer(m));
    mapMarkers = [];
    let mapData = {};
    Object.values(history).forEach(day => {
        if(day.perAnimal) {
            Object.entries(day.perAnimal).forEach(([idx, list]) => {
                const animalName = animals[idx] ? animals[idx].name : '?';
                list.forEach(item => {
                    const loc = item.location;
                    if(loc && locCoords[loc]) {
                        if(!mapData[loc]) mapData[loc] = { ...locCoords[loc], counts: {} };
                        mapData[loc].counts[animalName] = (mapData[loc].counts[animalName] || 0) + 1;
                    }
                });
            });
        }
    });
    Object.entries(mapData).forEach(([locName, data]) => {
        let text = `<b>${locName}</b><br>`;
        Object.entries(data.counts).forEach(([an, count]) => text += `${an}: ${count}<br>`);
        mapMarkers.push(L.marker([data.lat, data.lon]).addTo(mapInstance).bindPopup(text));
    });
}

// === LOCATION SEARCH & GPS ===
const osmIn = getEl('osmInput'), osmRes = getEl('osmResults');
let debounce;

function locateMe() {
    if(!navigator.geolocation) return showErrorToast("GPS nicht verf√ºgbar");
    showErrorToast("Standort wird ermittelt...", true);
    navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        // Reverse Geocoding via Nominatim
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=18&addressdetails=1`, {
            headers: { 'User-Agent': 'TiereZaehlenApp/3.0' }
        })
        .then(r => r.json())
        .then(data => {
            if(data && data.address) {
                // Construct a readable name
                const addr = data.address;
                const city = addr.city || addr.town || addr.village || addr.municipality;
                const road = addr.road || addr.pedestrian || addr.suburb;
                let text = road ? (road + (city ? ", " + city : "")) : (city || "Unbekannter Ort");
                if(data.name && data.name !== text) text = data.name + ", " + text; // If specific building name exists
                
                osmIn.value = text;
                showErrorToast("Adresse gefunden: " + text, true);
                
                // Optional: Save coords immediately for this text so map works
                locCoords[text] = { lat: parseFloat(latitude), lon: parseFloat(longitude) };
            } else {
                showErrorToast("Adresse nicht gefunden.");
            }
        })
        .catch(e => showErrorToast("Fehler bei Adresssuche"));
    }, err => {
        showErrorToast("GPS Fehler: " + err.message);
    });
}

if(osmIn){
    osmIn.addEventListener('input', e => {
        clearTimeout(debounce);
        if(e.target.value.length < 3) { osmRes.style.display='none'; return; }
        debounce = setTimeout(() => {
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(e.target.value)}`)
            .then(r=>r.json()).then(d => {
                osmRes.innerHTML='';
                if(!d.length) return;
                osmRes.style.display='block';
                d.slice(0,5).forEach(p => {
                    const div = document.createElement('div');
                    div.className='suggestion-item';
                    div.innerText = p.display_name.split(',').slice(0,2).join(','); 
                    div.onclick = () => { addLocationWithCoords(div.innerText, p.lat, p.lon); osmIn.value=''; osmRes.style.display='none'; };
                    osmRes.appendChild(div);
                });
            });
        }, 300);
    });
    document.addEventListener('click', e => { if(e.target!==osmIn) osmRes.style.display='none'; });
}

function addLocationWithCoords(name, lat, lon) {
    if(!locations.includes(name)) locations.push(name);
    locCoords[name] = { lat: parseFloat(lat), lon: parseFloat(lon) };
    safeSave(); showErrorToast(`Ort "${name}" hinzugef√ºgt`, true); render();
}
function addManualLocation() {
    const val = osmIn.value.trim();
    if(val && !locations.includes(val)) { locations.push(val); safeSave(); render(); showErrorToast("Ort gespeichert", true); }
}
function renderLocationList(){ getEl('locationListDisplay').textContent = locations.length ? locations.join(', ') : "Keine"; }

// === EDIT MODAL ===
let editIdx = null; let editImgTemp = null;
function openIconEdit(i){
    editIdx=i; editImgTemp = animals[i].image;
    getEl('editEmoji').value = animals[i].emoji;
    getEl('editTag').value = (animals[i].tags || []).join(', ');
    updateEditPreview();
    getEl('iconModal').style.display = 'block';
}
function handleEditFile(input){
    if(input.files && input.files[0]){
        const reader = new FileReader();
        reader.onload = function(e){ resizeImage(e.target.result, 100, (res)=>{ editImgTemp = res; updateEditPreview(); }); }
        reader.readAsDataURL(input.files[0]);
    }
}
function updateEditPreview(){
    const img = getEl('editPreviewImg');
    if(editImgTemp){ img.src = editImgTemp; getEl('editPreviewContainer').style.display='block'; }
    else getEl('editPreviewContainer').style.display='none';
}
function removeEditImage(){ editImgTemp = null; updateEditPreview(); }
function saveIconEdit(){
    if(editIdx===null) return;
    animals[editIdx].image = editImgTemp;
    animals[editIdx].emoji = getEl('editEmoji').value || 'üì∏';
    const tagStr = getEl('editTag').value;
    animals[editIdx].tags = tagStr ? tagStr.split(',').map(s=>s.trim()).filter(s=>s) : [];
    safeSave(); render(); closeModal('iconModal');
}

// === IMAGE HANDLING (COMPRESSED) ===
function handleImageUpload(input){
    if(input.files && input.files[0]){
        const reader = new FileReader();
        reader.onload = e => resizeImage(e.target.result, 300, res => { currentImage = res; getEl('previewEl').src = res; getEl('imgPreview').style.display='block'; });
        reader.readAsDataURL(input.files[0]);
    }
}
function resizeImage(base64, maxW, cb){
    const img = new Image(); img.src=base64;
    img.onload = () => {
        const c = document.createElement('canvas');
        const s = maxW/img.width;
        c.width=maxW; c.height=img.height*s;
        c.getContext('2d').drawImage(img,0,0,c.width,c.height);
        cb(c.toDataURL('image/jpeg',0.6)); 
    }
}
function clearImage(){ currentImage=null; getEl('imgPreview').style.display='none'; }

// === DETAIL & NOTE MODALS ===
function openDetail(i){
    const a = animals[i]; if(!a) return;
    const modal = getEl('detailModal'); const body = getEl('modalBody'); const col = colors[i] || '#2196f3';
    let total = 0; let locs = {}; let times = { 'Morgens':0, 'Mittags':0, 'Abends':0, 'Nachts':0 };
    let months = new Array(12).fill(0); let historyList = [];

    Object.entries(history).forEach(([dateStr, entry]) => {
        try {
            const d = new Date(dateStr); if(d.getFullYear() !== year) return;
            if(entry && entry.perAnimal && entry.perAnimal[i]){
                const list = entry.perAnimal[i]; total += list.length; months[d.getMonth()] += list.length;
                list.forEach((item, arrIdx) => {
                    historyList.push({ date:dateStr, item, arrIdx });
                    const l = item.location || 'Unbekannt'; locs[l] = (locs[l]||0)+1;
                    if(item.time){
                        const h = parseInt(item.time.split(':')[0]);
                        if(!isNaN(h)) { if(h>=5&&h<11) times['Morgens']++; else if(h>=11&&h<14) times['Mittags']++; else if(h>=14&&h<22) times['Abends']++; else times['Nachts']++; }
                    }
                });
            }
        } catch(e) {}
    });

    historyList.sort((a,b) => { if(b.date !== a.date) return b.date.localeCompare(a.date); return (b.item.time||'').localeCompare(a.item.time||''); });

    const icon = a.image ? `<img src="${a.image}">` : a.emoji;
    let html = `<div class="modal-header"><div class="modal-icon" style="border-color:${col}">${icon}</div><h2 style="margin:0">${a.name}</h2><div style="opacity:0.6">Gesamt: <strong>${total}</strong></div></div><div style="margin-bottom:20px;">`;

    const sortedLocs = Object.entries(locs).sort((a,b)=>b[1]-a[1]);
    html += `<h4>üìç Orte</h4>`;
    if(sortedLocs.length===0) html+='<small>Keine</small>';
    else {
        const maxL = sortedLocs[0][1];
        sortedLocs.slice(0,3).forEach(([name, val])=>{
            const pct = (val/maxL)*100;
            const linkLabel = name !== 'Unbekannt' ? `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name)}" target="_blank" class="map-link">${name} ‚Üó</a>` : name;
            html += `<div class="hbar-row"><div class="hbar-label">${linkLabel}</div><div class="hbar-track"><div class="hbar-fill" style="width:${pct}%; background:${col}"></div></div><div class="hbar-val">${val}</div></div>`;
        });
    }

    html += `<h4>‚è±Ô∏è Zeit</h4>`;
    const maxT = Math.max(...Object.values(times), 1);
    Object.entries(times).filter(x=>x[1]>0).forEach(([k,v])=>{
        const pct = (v/maxT)*100;
        html += `<div class="hbar-row"><div class="hbar-label">${k}</div><div class="hbar-track"><div class="hbar-fill" style="width:${pct}%; background:${col}; opacity:0.7"></div></div><div class="hbar-val">${v}</div></div>`;
    });
    
    html += `<h4>üóìÔ∏è Jahrestrend</h4><div class="chart-wrap" style="height:100px; padding-top:15px">`;
    const maxM = Math.max(...months, 1); const mN = ['J','F','M','A','M','J','J','A','S','O','N','D'];
    months.forEach((v, idx)=>{
        html += `<div class="chart-col">${v>0?`<div class="chart-val">${v}</div>`:''}<div class="chart-bar" style="height:${v===0?1:(v/maxM)*100}%; background:${col}; opacity:${v===0?0.1:1}"></div><div class="chart-label">${mN[idx]}</div></div>`;
    });
    html += `</div></div>`;

    // === KOMBINATION AUS "LETZTE 2" UND "ALLE ANZEIGEN" ===
    html += `<h3>üìù Verlauf</h3>`;
    
    const renderRow = (h) => {
        const displayDate = h.date.split('-').reverse().slice(0,2).join('.');
        return `<div class="hist-item">
            <div class="hist-date">${displayDate}<br>${h.item.time||''}</div>
            <div class="hist-info">${h.item.location ? `üìç ${h.item.location}` : ''}${h.item.note ? `<br><span class="hist-note">${h.item.note}</span>` : ''}</div>
            <div class="hist-actions">
                <button class="icon-btn" onclick="safeRun(openNoteModal, ${i}, '${h.date}', ${h.arrIdx})">‚úèÔ∏è</button>
                <button class="icon-btn" onclick="safeRun(deleteHistoryItem, ${i}, '${h.date}', ${h.arrIdx})">üóëÔ∏è</button>
            </div>
        </div>`;
    };

    if(historyList.length === 0) {
        html += '<p style="text-align:center; opacity:0.5">Keine Eintr√§ge</p>';
    } else {
        html += `<div class="history-list">`;
        historyList.slice(0, 2).forEach(h => html += renderRow(h));
        html += `</div>`;

        html += `<details style="margin-top:10px; border:none; background:transparent; padding:0;">
                    <summary style="font-size:14px; opacity:0.8; margin-bottom:5px">üìú Alle Eintr√§ge anzeigen (${historyList.length})</summary>
                    <div class="history-list" style="max-height:300px; overflow-y:auto; border-top:1px solid var(--btn); margin-top:0;">`;
        historyList.forEach(h => html += renderRow(h));
        html += `   </div>
                 </details>`;
    }
    
    html += `<div style="margin-top:30px; border-top:1px solid #eee; padding-top:20px; text-align:center"><button onclick="safeRun(removeAnimal, ${i})" style="background:var(--err-bg); color:var(--err-text); font-size:14px; padding:10px 20px;">‚ö†Ô∏è Dieses Tier l√∂schen</button></div>`;

    body.innerHTML = html; modal.style.display = 'block';
}

function deleteHistoryItem(i, date, arrIdx){
    if(!confirm('Diesen Eintrag l√∂schen?')) return;
    const list = history[date].perAnimal[i];
    list.splice(arrIdx, 1);
    history[date].total--;
    if(list.length===0) delete history[date].perAnimal[i];
    if(history[date].total<=0) delete history[date];
    safeSave(); openDetail(i); render(); 
}

let editMode = null; 
function openNoteModal(i, date = null, arrIndex = null) {
  const modal = getEl('noteModal'); const sel = getEl('noteLoc'); if(!sel || !modal) return;
  sel.innerHTML = `<option value="">üìç Ort?</option>${locations.map(l=>`<option>${l}</option>`).join('')}`;
  let entry = null;
  if(date !== null && arrIndex !== null && history[date] && history[date].perAnimal[i]) entry = history[date].perAnimal[i][arrIndex];

  if (entry) {
      editMode = { date, arrIndex };
      getEl('noteTitle').innerText = "Sichtung bearbeiten";
      getEl('noteDate').value = date; getEl('noteTime').value = entry.time || '';
      getEl('noteLoc').value = entry.location || ''; getEl('noteText').value = entry.note || '';
  } else {
      editMode = null;
      getEl('noteTitle').innerText = "Sichtung mit Notiz";
      getEl('noteDate').value = today(); getEl('noteTime').value = nowTime();
      getEl('noteLoc').value = getEl('locSelect'+i)?.value || ''; getEl('noteText').value = '';
  }
  const btn = getEl('noteSaveBtn'); const newBtn = btn.cloneNode(true); btn.parentNode.replaceChild(newBtn, btn);
  newBtn.onclick = () => safeRun(saveNote, i);
  modal.style.display = 'block';
}

function saveNote(i) {
  const d = getEl('noteDate').value || today(); const t = getEl('noteTime').value || nowTime();
  const l = getEl('noteLoc').value; const n = getEl('noteText').value;

  if (editMode) {
      if(history[editMode.date] && history[editMode.date].perAnimal[i]) {
          const oldList = history[editMode.date].perAnimal[i];
          oldList.splice(editMode.arrIndex, 1);
          history[editMode.date].total--;
          if(oldList.length===0) delete history[editMode.date].perAnimal[i];
          if(history[editMode.date].total<=0) delete history[editMode.date];
      }
      history[d] = history[d] || { total:0, perAnimal:{} }; history[d].perAnimal[i] = history[d].perAnimal[i] || [];
      history[d].perAnimal[i].push({ location:l, time:t, note:n }); history[d].total++;
      openDetail(i);
  } else {
      playSound('pop');
      history[d] = history[d] || { total:0, perAnimal:{} }; history[d].perAnimal[i] = history[d].perAnimal[i] || [];
      history[d].perAnimal[i].push({ location:l, time:t, note:n }); history[d].total++;
      render();
  }
  safeSave(); closeModal('noteModal');
}

// === STATS & EXPORT ===
function renderStats(){
  const container = getEl('statsContent'); if(!container) return;
  try {
      let totalSights=0, maxDayCount=0, streak=0, weekendCounts=0, lunchCounts=0, nightCounts=0, earlyCounts=0, hasPhoto=false;
      let countsPerMonth=new Array(12).fill(0), countsPerAnimal=new Array(animals.length).fill(0);
      let timeOfDay={'Morgens (5-11)':0,'Mittags (11-14)':0,'Abends (14-22)':0,'Nachts (22-5)':0};
      let distinctAnimals=new Set(), distinctLocs=new Set(), firstSightings={};
      let animalsWithPhotos = 0;

      const sortedDates = Object.keys(history).sort((a,b)=>new Date(b)-new Date(a));
      if(sortedDates.length > 0) {
          const diffHours = (new Date(today()) - new Date(sortedDates[0])) / 36e5;
          if(diffHours <= 48){ streak = 1; for(let i=0; i<sortedDates.length-1; i++){ if(Math.round((new Date(sortedDates[i])-new Date(sortedDates[i+1]))/864e5) === 1) streak++; else break; } }
      }

      Object.entries(history).forEach(([dateStr, entry]) => {
        const date = new Date(dateStr); if(date.getFullYear() !== year) return;
        totalSights += (entry.total||0); if(entry.total > maxDayCount) maxDayCount = entry.total;
        countsPerMonth[date.getMonth()] += (entry.total||0);
        if(date.getDay() === 0 || date.getDay() === 6) weekendCounts += entry.total;

        if(entry.perAnimal){
          Object.entries(entry.perAnimal).forEach(([idxStr, list]) => {
            const idx = parseInt(idxStr);
            if(animals[idx]) {
                countsPerAnimal[idx] += list.length; distinctAnimals.add(idx);
                if(!firstSightings[idx] && list.length>0) firstSightings[idx] = { date: dateStr, loc: list[0].location };
                list.forEach(item => {
                    const loc = item.location; 
                    if(loc && loc.trim() !== '' && loc !== 'Unbekannt') distinctLocs.add(loc);
                    if(item.time) {
                        const h = parseInt(item.time.split(':')[0]);
                        if(h>=5&&h<11) {timeOfDay['Morgens (5-11)']++;earlyCounts++;} else if(h>=11&&h<14) {timeOfDay['Mittags (11-14)']++;lunchCounts++;}
                        else if(h>=14&&h<22) timeOfDay['Abends (14-22)']++; else {timeOfDay['Nachts (22-5)']++;nightCounts++;}
                    }
                });
            }
          });
        }
      });
      
      // Calculate Photo Stats
      animals.forEach(a => { if(a.image) { hasPhoto = true; animalsWithPhotos++; } });

      // === CALCULATE XP & LEVEL ===
      // 10 XP per Sighting, 50 XP per Animal created, 100 XP per Photo, 25 XP per Location
      const currentXP = (totalSights * 10) + (animals.length * 50) + (animalsWithPhotos * 100) + (distinctLocs.size * 25);
      
      let currentLevelObj = levels[0];
      let nextLevelObj = null;

      for (let i = 0; i < levels.length; i++) {
          if (currentXP >= levels[i].xp) {
              currentLevelObj = levels[i];
              nextLevelObj = levels[i+1] || null; // Null if max level
          } else {
              break;
          }
      }

      const levelIdx = levels.indexOf(currentLevelObj) + 1;
      let progressPct = 100;
      let nextXPNeeded = 0;
      
      if(nextLevelObj) {
          const range = nextLevelObj.xp - currentLevelObj.xp;
          const val = currentXP - currentLevelObj.xp;
          progressPct = Math.min((val / range) * 100, 100);
          nextXPNeeded = nextLevelObj.xp - currentXP;
      }

      // === RENDER LEVEL CARD ===
      let html = `
      <div class="level-card">
        <div class="level-title">Dein Rang - Level ${levelIdx}</div>
        <div class="level-num">${currentLevelObj.name}</div>
        <div class="xp-bar-bg"><div class="xp-bar-fill" style="width:${progressPct}%"></div></div>
        <div class="xp-text">${currentXP} XP ${nextLevelObj ? `(noch ${nextXPNeeded} XP bis ${nextLevelObj.name})` : '(Maximales Level erreicht!)'}</div>
      </div>
      `;

      if(totalSights === 0) { html += '<div style="text-align:center; padding:20px">Noch keine Daten f√ºr weitere Statistiken.</div>'; container.innerHTML = html; return; }

      const badges = [
          { id:'start', icon:'üê£', name:'Starter', desc:'Erste Sichtung', condition: totalSights >= 1 },
          { id:'bronze', icon:'ü•â', name:'Sammler', desc:'50 Sichtungen', condition: totalSights >= 50 },
          { id:'silver', icon:'ü•à', name:'Profi', desc:'100 Sichtungen', condition: totalSights >= 100 },
          { id:'gold', icon:'üëë', name:'Legende', desc:'250 Sichtungen', condition: totalSights >= 250 },
          { id:'titan', icon:'ü™ê', name:'Titan', desc:'1.000 Sichtungen', condition: totalSights >= 1000 },
          { id:'streak', icon:'üî•', name:'On Fire', desc:'3 Tage Str√§hne', condition: streak >= 3 },
          { id:'marathon', icon:'‚ö°', name:'Marathon', desc:'7 Tage Str√§hne', condition: streak >= 7 },
          { id:'weekend', icon:'üìÖ', name:'Weekend', desc:'Wochenend-Sichtung', condition: weekendCounts > 0 },
          { id:'lunch', icon:'üç±', name:'Mittag', desc:'Sichtung 11-14 Uhr', condition: lunchCounts > 0 },
          { id:'zoo', icon:'üåà', name:'Arche', desc:'10 Tierarten entdeckt', condition: distinctAnimals.size >= 10 },
          { id:'darwin', icon:'üß¨', name:'Darwin', desc:'25 Tierarten entdeckt', condition: distinctAnimals.size >= 25 },
          { id:'expl', icon:'üåç', name:'Entdecker', desc:'3 Orte', condition: distinctLocs.size >= 3 },
          { id:'globe', icon:'üó∫Ô∏è', name:'Globetrotter', desc:'10 Orte', condition: distinctLocs.size >= 10 },
          { id:'cam', icon:'üì∏', name:'Paparazzi', desc:'Foto-Upload', condition: hasPhoto },
          { id:'night', icon:'ü¶â', name:'Nachteule', desc:'Sichtung nachts', condition: nightCounts > 0 },
          { id:'early', icon:'üêì', name:'Fr√ºh', desc:'Sichtung morgens', condition: earlyCounts > 0 }
      ];
      if([1, 50, 100, 250, 1000].includes(totalSights)) playSound('fanfare');

      html += `<div class="stat-kpi-row">
        <div class="stat-kpi"><div style="font-size:20px;font-weight:bold">${totalSights}</div><div style="font-size:10px;opacity:0.7">Sichtungen</div></div>
        <div class="stat-kpi"><div style="font-size:20px;font-weight:bold">${distinctAnimals.size} <span style="font-size:12px;opacity:0.5">/ ${animals.length}</span></div><div style="font-size:10px;opacity:0.7">Gesehene Arten</div></div>
        <div class="stat-kpi"><div style="font-size:20px;font-weight:bold">${streak}</div><div style="font-size:10px;opacity:0.7">Tage Str√§hne</div></div>
      </div>`;
      html += `<details open><summary>üèÜ Troph√§en</summary><div class="badge-grid">`;
      badges.forEach(b => html += `<div class="badge ${b.condition?'earned':''}" onclick="alert('${b.icon} ${b.name}\\n${b.desc}')"><span class="badge-icon">${b.icon}</span> ${b.name}</div>`);
      html += `</div></details>`;
      
      animals.forEach((_,i)=> { if(!colors[i]) colors[i] = `hsl(${i*57%360},70%,50%)`; });
      const sortedAnimals = animals.map((a,i)=>({name:a.name, emoji:a.emoji, count:countsPerAnimal[i], color:colors[i]})).sort((a,b)=>b.count-a.count).filter(a=>a.count>0);
      html += `<details><summary>üèÜ Top 5 Tiere</summary><div style="padding-top:10px">`;
      sortedAnimals.slice(0,5).forEach(a => html += `<div class="hbar-row"><div class="hbar-label">${a.emoji} ${a.name}</div><div class="hbar-track"><div class="hbar-fill" style="width:${(a.count/totalSights)*100}%; background:${a.color}"></div></div><div class="hbar-val">${a.count}</div></div>`);
      html += `</div></details>`;

      const maxTime = Math.max(...Object.values(timeOfDay), 1);
      html += `<details><summary>‚è±Ô∏è Tageszeiten (Gesamt)</summary><div style="padding-top:10px">`;
      Object.entries(timeOfDay).forEach(([label, val]) => html += `<div class="hbar-row"><div class="hbar-label" style="width:110px">${label}</div><div class="hbar-track"><div class="hbar-fill" style="width:${(val/maxTime)*100}%; opacity:0.8"></div></div><div class="hbar-val">${val}</div></div>`);
      html += `</div></details>`;

      html += `<details><summary>üóìÔ∏è Jahres-Verlauf</summary><div class="chart-wrap">`;
      const mNames = ['J','F','M','A','M','J','J','A','S','O','N','D']; const maxMonthVal = Math.max(...countsPerMonth, 1);
      countsPerMonth.forEach((val, i) => html += `<div class="chart-col">${val>0?`<div class="chart-val">${val}</div>`:''}<div class="chart-bar" style="height:${val===0?1:(val/maxMonthVal)*100}%; opacity:${val===0?0.1:0.9}"></div><div class="chart-label">${mNames[i]}</div></div>`);
      html += `</div></details>`;

      html += `<details><summary>üî• 30-Tage Heatmap</summary><div class="heatmap-grid">`;
      for(let i=27; i>=0; i--){
        const d = new Date(); d.setDate(new Date().getDate() - i); const iso = d.toISOString().slice(0,10);
        const count = history[iso] ? history[iso].total : 0;
        html += `<div class="heat-cell" style="background:${count>0?`rgba(33, 150, 243, ${Math.min(count*0.2+0.2,1)})`:'var(--btn)'}; color:${count?'#fff':'transparent'}" title="${iso}: ${count}">${count||0}</div>`;
      }
      html += `</div></details>`;

      html += `<details><summary>üê£ Erste Begegnungen</summary><div style="padding-top:10px">`;
      const foundAnimals = animals.map((a,i)=>({idx:i, ...a})).filter(a => firstSightings[a.idx]);
      if(foundAnimals.length===0) html += '<small>Leer</small>';
      else foundAnimals.forEach(a => html += `<div style="border-bottom:1px solid #eee; padding:6px 0; font-size:14px; display:flex; justify-content:space-between;"><span>${a.emoji||'üì∏'} <strong>${a.name}</strong></span><span style="font-size:12px; text-align:right; color:var(--sub)">${firstSightings[a.idx].date}<br>${firstSightings[a.idx].loc||''}</span></div>`);
      html += `</div></details>`;
      container.innerHTML = html;
  } catch(e) { container.innerHTML = `<div style="color:red; text-align:center; padding:20px;">Fehler beim Laden der Statistik.<br><small>${e.message}</small></div>`; }
}

function generateShareCard() {
    try {
        const canvas = document.createElement('canvas'); canvas.width = 600; canvas.height = 400; const ctx = canvas.getContext('2d');
        ctx.fillStyle = dark ? '#1e1e1e' : '#f4f4f4'; ctx.fillRect(0,0,600,400);
        ctx.fillStyle = dark ? '#fff' : '#000'; ctx.font = 'bold 30px system-ui'; ctx.textAlign = 'center'; ctx.fillText(`Meine Tiersammlung ${year}`, 300, 50);
        let total = Object.values(history).reduce((a,b)=>a+(b.total||0),0);
        let topAnimal = null; if(animals.length) topAnimal = animals.map((a,i)=>{ let c=0; Object.values(history).forEach(h=>{if(h&&h.perAnimal&&h.perAnimal[i])c+=h.perAnimal[i].length}); return {n:a.name, c:c, e:a.emoji}; }).sort((a,b)=>b.c-a.c)[0];
        ctx.font = 'bold 60px system-ui'; ctx.fillStyle = '#2196f3'; ctx.fillText(total, 300, 150);
        ctx.font = '20px system-ui'; ctx.fillStyle = dark ? '#bbb' : '#555'; ctx.fillText("Sichtungen Gesamt", 300, 180);
        if(topAnimal && topAnimal.c > 0) { ctx.fillStyle = dark ? '#fff' : '#000'; ctx.font = '30px system-ui'; ctx.fillText(`üèÜ Top Tier: ${topAnimal.e} ${topAnimal.n} (${topAnimal.c})`, 300, 250); }
        ctx.font = 'italic 16px system-ui'; ctx.fillStyle = '#888'; ctx.fillText("Erstellt mit Tier-Tracker Ultimate v3", 300, 370);
        const link = document.createElement('a'); link.download = `tier-stats-${year}.png`; link.href = canvas.toDataURL(); link.click();
    } catch(e) { showErrorToast("Bild-Export Fehler"); }
}

// === FIXED IMPORT FUNCTION WITH NAME MAPPING ===
function importBackup(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            tempImportData = JSON.parse(e.target.result);
            if(!tempImportData.animals) throw new Error("Ung√ºltige Datei");
            getEl('importModal').style.display = 'block'; 
        } catch(err) { 
            console.error(err); showErrorToast("Dateifehler: " + err.message); 
            getEl('importFile').value = ''; 
        }
    };
    reader.readAsText(file);
}

function confirmImport(action) {
    getEl('importModal').style.display = 'none';
    if(action === 'cancel') {
        tempImportData = null;
        getEl('importFile').value = '';
        return;
    }

    try {
        const data = tempImportData;
        if(action === 'merge') {
            const idMap = {};
            if(data.animals) {
                data.animals.forEach((impA, impIdx) => {
                    const normName = impA.name.trim().toLowerCase();
                    let existIdx = animals.findIndex(a => a.name.trim().toLowerCase() === normName);
                    if(existIdx === -1) {
                        existIdx = animals.push(impA) - 1; 
                    }
                    idMap[impIdx] = existIdx; 
                });
            }

            if(data.history) {
                Object.entries(data.history).forEach(([date, dayData]) => {
                    if(!history[date]) history[date] = { total: 0, perAnimal: {} };
                    if(dayData.perAnimal) {
                        Object.entries(dayData.perAnimal).forEach(([oldIdxStr, list]) => {
                            const targetIdx = idMap[parseInt(oldIdxStr)];
                            if(targetIdx !== undefined && animals[targetIdx]) {
                                if(!history[date].perAnimal[targetIdx]) history[date].perAnimal[targetIdx] = [];
                                list.forEach(item => {
                                    const exists = history[date].perAnimal[targetIdx].some(ex => 
                                        ex.time === item.time && ex.location === item.location && ex.note === item.note
                                    );
                                    if(!exists) history[date].perAnimal[targetIdx].push(item);
                                });
                            }
                        });
                    }
                });
                Object.keys(history).forEach(d => {
                    let t = 0;
                    if(history[d].perAnimal) Object.values(history[d].perAnimal).forEach(l => t += l.length);
                    history[d].total = t;
                });
            }
            if(data.locations) data.locations.forEach(l => { if(!locations.includes(l)) locations.push(l); });
            locations.sort();
            if(data.locCoords) locCoords = { ...locCoords, ...data.locCoords };

        } else if (action === 'overwrite') {
            animals = data.animals || [];
            history = data.history || {};
            colors = data.colors || {};
            locations = data.locations || [];
            locCoords = data.locCoords || {};
        }

        safeSave(); render();
        showErrorToast(action === 'merge' ? "Daten erfolgreich zusammengef√ºgt!" : "Daten √ºberschrieben!", true);
    } catch(e) {
        console.error(e);
        showErrorToast("Import fehlgeschlagen.");
    } finally {
        tempImportData = null;
        getEl('importFile').value = '';
    }
}

// === EXPORT CSV FIX (Semicolon) ===
function exportCSV() {
    let csv = "Datum;Uhrzeit;Tier;Ort;Notiz\n";
    Object.entries(history).forEach(([d, v]) => {
        if (v.perAnimal) {
            Object.entries(v.perAnimal).forEach(([idx, list]) => {
                const n = animals[idx] ? animals[idx].name : "Unbekannt";
                list.forEach(s => {
                    // Safe field handling for CSV (quotes if needed)
                    const safe = (val) => {
                        val = val || '';
                        if (val.includes(';') || val.includes('"') || val.includes('\n')) {
                            return `"${val.replace(/"/g, '""')}"`;
                        }
                        return val;
                    };
                    csv += `${d};${s.time || ''};${safe(n)};${safe(s.location)};${safe(s.note)}\n`;
                });
            });
        }
    });
    const a = document.createElement('a');
    a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
    a.download = `tiere-${year}.csv`;
    a.click();
}

// === UTILS ===
function toggleInfo(){ getEl('infoBox').style.display = getEl('infoBox').style.display==='none'?'block':'none'; }
function toggleDarkMode(){ dark=!dark; document.body.classList.toggle('dark'); localStorage.setItem('darkmode',dark); }
function downloadBackup(){ const b = new Blob([JSON.stringify({year,animals,history,locations,locCoords},null,2)],{type:'application/json'}); const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`tiere-v3-${year}.json`; a.click(); }
function openNotifySettings(){ getEl('notifyModal').style.display='block'; }
function closeModal(id){ getEl(id).style.display='none'; }
window.onclick = e => { if(e.target.classList.contains('modal')) e.target.style.display='none'; }

// Init
safeRun(render);
setTimeout(() => getEl('muteBtn').innerText = isMuted ? 'üîá' : 'üîä', 100);

</script>
</body>
</html>