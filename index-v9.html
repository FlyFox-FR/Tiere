<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no, maximum-scale=1">
<title>Tiere z√§hlen Ultimate v6.4 üêæ (Merged)</title>
<meta name="theme-color" content="#000000">

<!-- PWA MANIFEST -->
<link rel="manifest" href='data:application/manifest+json,{"name":"Tiere Z√§hlen Ult.","short_name":"TierTracker","start_url":".","display":"standalone","background_color":"#121212","theme_color":"#2196f3","icons":[{"src":"https://emojicdn.elk.sh/üêæ","sizes":"192x192","type":"image/png"}]}'>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<!-- LEAFLET MAP CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

<style>
/* === GLOBAL RESET === */
*, *::before, *::after { box-sizing: border-box; }

:root{
    --bg:#f0f2f5;
    --card:rgba(255, 255, 255, 0.85);
    --card-solid:#fff;
    --text:#1c1e21;
    --btn:#e4e6eb;
    --hover:#d8dadf;
    --accent:#2196f3;
    --accent-glow: rgba(33, 150, 243, 0.4);
    --warn-bg:#fff3cd; --warn-text:#856404;
    --err-bg:#f8d7da; --err-text:#721c24;
    --sub:#65676b; 
    --nav-height: 70px;
    --glass-border: 1px solid rgba(255, 255, 255, 0.6);
    --shadow: 0 4px 12px rgba(0,0,0,0.08);
}
body.dark {
    /* TRUE OLED BLACK */
    --bg: #000000;
    --card: #000000;
    --card-solid: #000000;
    
    /* Maximaler Kontrast */
    --text: #ffffff;
    --sub: #a0a0a0;
    
    /* Buttons m√ºssen sich leicht abheben (Dunkelgrau) */
    --btn: #1a1a1a;
    --hover: #333333;
    
    /* Akzentfarben (leuchtend auf Schwarz) */
    --accent: #44a5ff; /* Etwas helleres Blau f√ºr besseren Kontrast */
    --accent-glow: rgba(68, 165, 255, 0.4);
    
    /* Warnungen/Fehler (angepasst an Schwarz) */
    --warn-bg: #1a1600; --warn-text: #ffd700;
    --err-bg: #2a0005; --err-text: #ff6b6b;
    
    /* WICHTIG: Da alles schwarz ist, ersetzen wir Schatten durch feine R√§nder */
    --glass-border: 1px solid #333333;
    --shadow: none; /* Schatten sind auf #000 unsichtbar */
}


body{font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background:var(--bg); color:var(--text); max-width:980px; margin:auto; padding:16px; padding-bottom:calc(var(--nav-height) + 40px); position:relative; overflow-x:hidden; transition: background 0.3s;}

/* Utilities */
.hidden { display: none !important; }
.fade-in { animation: fadeIn 0.3s forwards; }
@keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
.glass-panel { background: var(--card); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: var(--glass-border); box-shadow: var(--shadow); }

/* Header & Toggles */
.header-controls { position:absolute; top:16px; right:16px; display:flex; gap:8px; z-index: 100; }
.icon-btn-header { font-size:18px; background:var(--btn); color:var(--text); border-radius:50%; width:40px; height:40px; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
.icon-btn-header:active { transform: scale(0.9); }
.icon-btn-header.info { background:var(--accent); color:#fff; box-shadow: 0 2px 8px var(--accent-glow); }

h1 { margin-top: 5px; margin-bottom: 20px; font-size: 1.8em; font-weight: 800; letter-spacing: -0.5px; background: -webkit-linear-gradient(45deg, var(--text), var(--sub)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; width: fit-content;}

/* Views Container */
.view-section { display: none; }
.view-section.active { display: block; animation: fadeIn 0.3s ease-out; }

/* Sticky Bottom Nav (Glass) */
.bottom-nav {
    position: fixed;
    bottom: 20px; /* Schwebt 20px √ºber dem Rand */
    left: 20px;
    right: 20px;
    height: 65px; /* Etwas kompakter */
    background: rgba(30, 30, 30, 0.85); /* Dunkleres Glas im Standard */
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 35px; /* Pillen-Form */
    display: flex;
    justify-content: space-evenly; /* Gleichm√§√üiger verteilt */
    align-items: center;
    z-index: 9000;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    max-width: 500px; /* Damit es auf Tablets nicht riesig breit wird */
    margin: 0 auto; /* Zentriert */
}

/* Anpassung f√ºr Light Mode */
body:not(.dark) .bottom-nav {
    background: rgba(255, 255, 255, 0.85);
    border: 1px solid rgba(255,255,255,0.6);
}

/* Icon Animation beim Aktivieren */
.nav-item.active .nav-icon {
    transform: translateY(-5px) scale(1.1); /* H√ºpft h√∂her */
    filter: drop-shadow(0 4px 5px var(--accent-glow));
}
.nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--sub); cursor: pointer; transition: all 0.2s; font-size: 11px; background: none; border: none; padding: 0; }
.nav-item .nav-icon { font-size: 22px; margin-bottom: 4px; transition: transform 0.2s; }
.nav-item.active { color: var(--accent); font-weight: 600; }
.nav-item.active .nav-icon { transform: translateY(-2px); }

/* Floating Particles */
.particle { position: fixed; pointer-events: none; font-weight: bold; z-index: 9999; animation: floatUp 0.8s ease-out forwards; font-size: 20px; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
@keyframes floatUp { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; } 100% { transform: translate(-50%, -150px) scale(1.5); opacity: 0; } }

/* Tag Filters & Search */
.list-header { display:flex; gap:8px; margin-bottom:15px; position: relative; z-index: 5; }
.search-bar { flex:1; padding:12px 16px; border-radius:25px; border:none; background:var(--card-solid); color:var(--text); font-size:15px; box-shadow: var(--shadow); transition: box-shadow 0.2s; }
.search-bar:focus { outline: 2px solid var(--accent); box-shadow: 0 4px 12px var(--accent-glow); }
.sort-btn { padding:0; width: 44px; height: 44px; border-radius:14px; border:none; background:var(--card-solid); color: var(--text); cursor:pointer; box-shadow: var(--shadow); display: flex; align-items: center; justify-content: center; font-size: 18px; }

.tag-scroll { display: flex; gap: 8px; overflow-x: auto; padding: 4px 4px 15px 4px; margin-bottom: 0px; scrollbar-width: none; mask-image: linear-gradient(to right, black 90%, transparent 100%); }
.tag-scroll::-webkit-scrollbar { display: none; }
.tag-pill { background: var(--btn); padding: 8px 16px; border-radius: 20px; font-size: 13px; white-space: nowrap; cursor: pointer; border: 1px solid transparent; transition: all 0.2s; font-weight: 500; }
.tag-pill.active { background: var(--accent); color: #fff; box-shadow: 0 4px 10px var(--accent-glow); transform: scale(1.05); }

/* Map Container */
#map { height: 60vh; width: 100%; border-radius: 24px; z-index: 1; margin-bottom: 20px; border: 4px solid var(--card); box-shadow: var(--shadow); }

/* Inputs & Buttons */
button{font-size:16px;padding:10px 16px;border-radius:14px;border:none;background:var(--btn);color:var(--text);cursor:pointer; transition: all 0.2s; font-weight: 600;}
button:active{transform: scale(0.96);}
button:hover{background:var(--hover)}
input,select,textarea{padding:12px;font-size:16px;border-radius:12px;border:1px solid var(--btn);background:var(--card-solid);color:var(--text); width: 100%; box-sizing: border-box; font-family: inherit;}
input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent); }

/* === LIST VIEW STYLES (MODERN V7.6) - UPDATED: NAME OBEN === */
.row {
    display: flex; 
    align-items: center; 
    gap: 6px; 
    background: var(--card); 
    backdrop-filter: blur(10px);
    padding: 8px 8px; 
    margin-bottom: 12px; 
    border-radius: 20px; 
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    border: 1px solid rgba(255,255,255,0.4);
    transition: transform 0.2s, box-shadow 0.2s;
    /* Damit die H√∂he wachsen kann, wenn der Name lang ist */
    height: auto;
    min-height: 70px;
}
.row:active { transform: scale(0.99); }

/* Klick-Bereich links: Jetzt untereinander (Column) */
.click-area-left {
    display: flex; 
    flex-direction: column; /* Stapelt Elemente vertikal */
    align-items: center; 
    justify-content: center;
    gap: 4px; /* Abstand zwischen Name und Bild */
    cursor: pointer;
    border-radius: 16px;
    padding: 4px;
    transition: background 0.2s;
    min-width: 85px; /* Mindestbreite f√ºr sch√∂ne Optik */
    max-width: 100px; /* Begrenzt die Breite, damit Umbruch passiert */
    text-align: center;
}
.click-area-left:active {
    background: rgba(0,0,0,0.05);
    transform: scale(0.98);
}
/* Hover Effekt */
.click-area-left:hover .animal-icon {
    transform: scale(1.1) rotate(-5deg);
    border-color: var(--accent);
    box-shadow: 0 4px 12px var(--accent-glow);
}

.animal-icon{
    font-size:26px; width:46px; height:46px; flex-shrink:0; 
    display:flex; align-items:center; justify-content:center; 
    overflow:hidden; border-radius:16px; cursor: pointer; 
    background: linear-gradient(135deg, var(--bg), var(--card-solid));
    border: 1px solid var(--btn);
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.animal-icon img {width:100%; height:100%; object-fit:cover;}

/* Name Anpassung f√ºr Umbruch */
.name { 
    font-weight: 700; 
    font-size: 13px; 
    color: var(--text);
    white-space: normal; /* Erlaubt Zeilenumbruch */
    line-height: 1.2;
    word-wrap: break-word; /* Bricht lange W√∂rter um */
    margin-bottom: 2px;
}

/* Tags (Kategorie) ausblenden, um Platz zu sparen */
.tags-row { display: none; }


/* === V7.9 FINAL POLISH: SUPER BADGES - KLEINER GEMACHT === */

/* === ANPASSUNG: Z√§hler kleiner & besser lesbar (auch im Dark Mode) === */
/* === ANPASSUNG: Z√§hler (Kompakt & Farbe angepasst) === */
.count-badge {
    /* Gr√∂√üe & Layout */
    min-width: 30px; 
    height: 30px;
    padding: 0 4px;
    margin-left: auto; 
    margin-right: 4px;
    
    display: flex; 
    align-items: center; 
    justify-content: center;
    
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    font-weight: 800; 
    font-size: 13px;
    
    /* STANDARD (Light Mode): Blau/Akzentfarbe */
    color: var(--accent);
    background: var(--btn);
    border: 1px solid var(--glass-border);
    border-radius: 8px; 
    transition: all 0.2s;
}

/* SPEZIAL: Nur im Dark Mode (Wei√üer Text) */
body.dark .count-badge {
    color: #ffffff !important;       /* Text ist jetzt Reinwei√ü */
    background: rgba(255, 255, 255, 0.15); /* Hintergrund etwas heller grau */
    border-color: rgba(255, 255, 255, 0.2);
}

/* === NEU: Lightbox (Bild vergr√∂√üern) === */
#lightboxModal {
    display: none;
    position: fixed;
    z-index: 10000; /* Ganz oben */
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.9);
    cursor: pointer;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.2s ease-out;
}
#lightboxImg {
    max-width: 95%;
    max-height: 90vh;
    border-radius: 8px;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
    border: 2px solid #fff;
    transform: scale(0.9);
    transition: transform 0.3s;
}
#lightboxModal.active #lightboxImg {
    transform: scale(1);
}

/* Modern Select Dropdown (Pill Shape) */
.modern-select {
    appearance: none; -webkit-appearance: none;
    background-color: var(--btn);
    background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23555%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
    background-repeat: no-repeat;
    background-position: right 8px top 50%;
    background-size: 10px auto;
    padding: 6px 24px 6px 12px;
    border-radius: 20px;
    border: 1px solid transparent;
    font-size: 12px;
    font-weight: 600;
    color: var(--sub);
    cursor: pointer;
    
    margin-left: 0; /* Kein Auto Margin mehr */
    margin-right: 4px;
    max-width: 110px;
    white-space: nowrap; text-overflow: ellipsis; overflow: hidden;
    margin-top: 0; align-self: center;
    transition: all 0.2s;
}
.modern-select:focus {
    outline: none;
    border-color: var(--accent);
    background-color: var(--card-solid);
    box-shadow: 0 0 0 3px var(--accent-glow);
}

/* Fav Button Update */
.fav-btn {
    background: none; border: none; 
    font-size: 24px; /* Gr√∂√üer */
    color: var(--btn); 
    cursor: pointer; 
    padding: 0 4px;
    margin-right: -4px;
    transition: transform 0.2s;
}
.fav-btn:active { transform: scale(1.3); }
.fav-btn.active { color: #ffb300; filter: drop-shadow(0 0 2px rgba(255,179,0,0.5)); }

/* Animations f√ºr Buttons */
.action-btn-main, .icon-btn-anim {
    transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.2s;
    cursor: pointer;
}
.action-btn-main {
    background: var(--accent); color: white; width: 44px; height: 44px; border-radius: 14px;
    display: flex; align-items: center; justify-content: center; font-size: 20px; 
    box-shadow: 0 4px 10px var(--accent-glow);
    border: 2px solid var(--card-solid);
}
.action-btn-main:active, .icon-btn-anim:active { transform: scale(0.90); }
.action-btn-main:hover { transform: scale(1.05); box-shadow: 0 6px 15px var(--accent-glow); }
.icon-btn-anim:hover { transform: scale(1.1); background: rgba(0,0,0,0.05); border-radius: 8px; }

/* === GRID VIEW STYLES === */
.grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; padding-bottom: 20px; }
.grid-item { background: var(--card); border-radius: 20px; padding: 15px; display: flex; flex-direction: column; align-items: center; text-align: center; box-shadow: var(--shadow); position: relative; border: var(--glass-border); }
.grid-fav { position: absolute; top: 8px; right: 8px; font-size: 16px; color: var(--btn); cursor: pointer; }
.grid-fav.active { color: #ffb300; }
.grid-img-wrap { width: 80px; height: 80px; border-radius: 40px; overflow: hidden; margin-bottom: 10px; border: 4px solid var(--bg); box-shadow: 0 4px 8px rgba(0,0,0,0.1); cursor: pointer; display:flex; align-items:center; justify-content:center; font-size:40px; background:var(--btn); }
.grid-img-wrap img { width: 100%; height: 100%; object-fit: cover; }
.grid-name { font-weight: bold; font-size: 14px; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }
.grid-count { background: transparent; color: var(--accent); padding: 2px 8px; font-size: 16px; font-weight: bold; margin-bottom: 8px; }
.grid-actions { display: flex; gap: 8px; width: 100%; margin-top: 10px; }
.grid-btn { flex: 1; padding: 8px; border-radius: 10px; font-size: 16px; display:flex; align-items:center; justify-content:center; }

/* === UNDO TOAST === */
.undo-toast {
    position: fixed; bottom: calc(var(--nav-height) + 20px); left: 50%; transform: translateX(-50%) translateY(100px);
    background: #323232; color: white; padding: 12px 20px; border-radius: 30px;
    display: flex; align-items: center; gap: 15px; z-index: 9998;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3); opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    width: 90%; max-width: 400px; justify-content: space-between;
}
.undo-toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
.undo-btn { background: transparent; color: #64b5f6; font-weight: bold; text-transform: uppercase; font-size: 14px; padding: 5px 10px; margin: -5px -10px -5px 0; cursor: pointer; }
.error-toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--err-bg); color: var(--err-text); padding: 12px 24px; border-radius: 50px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 9999; font-size: 14px; display: none; animation: fadeIn 0.3s; font-weight: bold; width: max-content; }

/* === BOTTOM SHEETS & MODALS === */
.modal { display: none; position: fixed; z-index: 9995; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px); transition: opacity 0.3s; }
.modal-content {
    background-color: var(--card-solid); margin: 5% auto; padding: 25px; border-radius: 24px; width: 90%; max-width: 500px; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.3);
    animation: zoomIn 0.2s ease-out; max-height: 85vh; overflow-y: auto;
}
@media (max-width: 600px) {
    .modal-content {
        margin: 0; position: absolute; bottom: 0; left: 0; width: 100%; max-width: 100%; border-radius: 24px 24px 0 0; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); padding-bottom: 40px; transform: translateZ(0); transition: transform 0.1s;
    }
}
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
@keyframes zoomIn { from { transform: scale(0.9); opacity:0; } to { transform: scale(1); opacity:1; } }

.close-btn { position: absolute; top: 15px; right: 20px; color: var(--sub); font-size: 24px; width:30px; height:30px; display:flex;align-items:center;justify-content:center; background:var(--btn); border-radius:50%; cursor: pointer; z-index:10; }
.sheet-handle { width: 50px; height: 6px; background: var(--btn); border-radius: 10px; margin: 0 auto 20px auto; cursor: grab; }

/* === STATS Styles === */
.card-section { background:var(--card); padding:20px; border-radius:20px; box-shadow: var(--shadow); margin-bottom: 20px; border: var(--glass-border); }
.card-section h3 { margin-top: 0; margin-bottom: 15px; font-size: 1.1em; border-bottom: 1px solid var(--btn); padding-bottom: 15px; display:flex; align-items:center; gap:10px; }
.level-card { background: linear-gradient(135deg, #2196f3, #673ab7); color: white; padding: 25px; border-radius: 24px; margin-bottom: 20px; text-align: center; box-shadow: 0 10px 25px rgba(33, 150, 243, 0.3); position: relative; overflow: hidden; }
.level-card::before { content:''; position: absolute; top:-50%; left:-50%; width:200%; height:200%; background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 60%); pointer-events: none; }
.level-title { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.9; margin-bottom: 5px; }
.level-num { font-size: 42px; font-weight: 900; margin: 10px 0; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
.xp-bar-bg { background: rgba(0,0,0,0.25); height: 8px; border-radius: 4px; overflow: hidden; margin-top: 15px; }
.xp-bar-fill { background: #fff; height: 100%; width: 0%; transition: width 1s ease-out; box-shadow: 0 0 10px rgba(255,255,255,0.5); }
.xp-text { font-size: 11px; margin-top: 6px; opacity: 0.9; }

.badge-grid { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
.badge { background: var(--btn); padding: 6px 10px; border-radius: 20px; font-size: 12px; display: flex; align-items: center; gap: 5px; opacity: 0.4; filter: grayscale(1); transition: all 0.3s; cursor: pointer; user-select: none; border: 1px solid transparent; }
.badge:active { transform: scale(0.95); }
.badge.earned { opacity: 1; filter: grayscale(0); background: rgba(33, 150, 243, 0.15); border-color: var(--accent); color: var(--accent); font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
.badge-icon { font-size: 16px; }

.heatmap-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; max-width: 320px; margin: 10px auto; }
.heat-cell { aspect-ratio: 1; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: transparent; background: var(--btn); }

.stat-kpi-row { display:flex; gap:10px; justify-content:space-around; margin-bottom:15px; text-align:center; }
.stat-kpi { background:var(--card-solid); padding:10px; border-radius:12px; flex:1; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
.hbar-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 14px; }
.hbar-label { flex: 1; text-align: left; opacity: 0.9; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 0; }
.hbar-track { width: 40%; flex: none; background: var(--btn); height: 12px; border-radius: 6px; overflow: hidden; }
.hbar-fill { height: 100%; background: var(--accent); }
.hbar-val { font-size: 12px; width: 25px; text-align:right; font-weight:bold; flex:none; }
.chart-wrap { display: flex; align-items: flex-end; height: 140px; gap: 6px; padding-top: 25px; margin-top: 10px; }
.chart-col { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; }
.chart-bar { width: 100%; background: var(--accent); border-radius: 4px 4px 0 0; opacity: 0.9; min-height: 1px; }
.chart-val { font-size: 10px; margin-bottom: 2px; }
.chart-label { font-size: 10px; margin-top: 4px; transform: rotate(-45deg); height: 20px; text-align: center; }

/* Level Table */
.level-table { width: 100%; border-collapse: collapse; font-size: 13px; text-align: left; }
.level-table th { border-bottom: 1px solid var(--btn); padding: 5px; opacity: 0.7; }
.level-table td { border-bottom: 1px solid var(--btn); padding: 6px 5px; }
.level-table tr.current-level { background: rgba(33, 150, 243, 0.15); color: var(--accent); font-weight: bold; }

/* Switch Toggle */
.switch { position: relative; display: inline-block; width: 50px; height: 28px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--btn); transition: .4s; border-radius: 34px; }
.slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
input:checked + .slider { background-color: var(--accent); }
input:checked + .slider:before { transform: translateX(22px); }

/* Import/Actions */
.import-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
.import-actions button { height: 100%; padding: 15px; border-radius: 16px; }
.btn-merge { grid-column: span 2; background: var(--accent); color: white; }

/* Image Edit */
.edit-tools { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
.file-label { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; background: var(--btn); padding: 15px; border-radius: 16px; cursor: pointer; font-size: 13px; font-weight: bold; }

/* Autocomplete */
.autocomplete-container { flex: 1; position: relative; }
.autocomplete-results { position: absolute; top: 100%; left: 0; right: 0; background: var(--card-solid); border: 1px solid var(--btn); z-index: 1000; display: none; max-height: 200px; overflow-y: auto; border-radius: 0 0 12px 12px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
.suggestion-item { padding: 12px; cursor: pointer; border-bottom: 1px solid var(--btn); font-size: 14px; }

/* Trash Bin */
.trash-row { transition: background 0.2s; }
.trash-row:hover { background: var(--btn); }

/* === V7.8 DESIGN UPDATE: BUTTONS & PATTERNS === */

/* 1. Der Stift-Button ("Ebenb√ºrtig" zum Plus) */
.action-btn-secondary {
    width: 44px; height: 44px; /* Exakt gleich wie Plus */
    border-radius: 14px;
    background: var(--card-solid); /* Wei√ü/Dunkelgrau */
    color: var(--text);
    border: 1px solid var(--btn); /* Zarter Rand */
    display: flex; align-items: center; justify-content: center;
    font-size: 20px;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05); /* Gleicher Schattenstil */
    transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    flex-shrink: 0; /* Darf nicht schrumpfen */
}
.action-btn-secondary:active {
    transform: scale(0.9);
}
.action-btn-secondary:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-color: var(--accent); /* Leuchtet beim Hovern in Akzentfarbe */
}

/* === V7.9 FINAL POLISH: SUPER BADGES & BETTER ANIMALS === */

/* 1. Der "Coole" Z√§hler (Count Badge) */
.count-badge {
    /* Gr√∂√üe & Layout */
    min-width: 40px; 
    height: 40px;
    padding: 0 8px;
    margin-left: auto; 
    margin-right: 8px;
    
    /* Flexbox f√ºr Zentrierung */
    display: flex; 
    align-items: center; 
    justify-content: center;
    
    /* Typografie - Fett & Auff√§llig */
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    font-weight: 900; 
    font-size: 18px; 
    color: var(--accent); /* Zahl in Akzentfarbe */
    
    /* Der "Look" */
    background: linear-gradient(135deg, var(--card-solid), #f0f8ff); /* Leichter Verlauf */
    border: 2px solid var(--btn); /* Etwas dickerer Rand */
    border-radius: 14px; /* Super-Ellipse */
    
    /* Effekt */
    box-shadow: 
        inset 0 2px 4px rgba(255,255,255,1), /* Innerer Glanz */
        0 4px 10px rgba(0,0,0,0.05); /* √Ñu√üerer Schatten */
    
    transition: transform 0.2s, color 0.2s;
}

/* Kleiner "Pop" Effekt wenn sich die Zahl √§ndert (optional via JS getriggert, aber hover geht auch) */
.row:hover .count-badge {
    border-color: var(--accent);
    transform: scale(1.1) rotate(5deg);
    background: #fff;
}
/* === DETAIL DASHBOARD V8.0 === */

/* Container f√ºr die Statistik-Karten */
.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr; /* 2 Spalten */
    gap: 10px;
    margin-bottom: 20px;
}

/* Einzelne Stat-Karte */
.stat-card {
    background: var(--bg);
    border-radius: 16px;
    padding: 12px;
    text-align: center;
    border: 1px solid var(--btn);
    box-shadow: 0 2px 5px rgba(0,0,0,0.02);
}

.stat-value {
    font-size: 24px;
    font-weight: 900;
    color: var(--accent);
    margin: 5px 0;
}

.stat-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    opacity: 0.6;
}

/* Bunter Tageszeit-Balken (Segmented Bar) */
.time-bar-container {
    display: flex;
    height: 24px;
    border-radius: 12px;
    overflow: hidden;
    margin-top: 10px;
    background: var(--btn);
}
.time-segment {
    height: 100%;
    transition: width 0.5s ease-out;
}
/* Farben f√ºr Tageszeiten */
.ts-morgens { background: #FFC107; } /* Gelb */
.ts-mittags { background: #FF9800; } /* Orange */
.ts-abends  { background: #F44336; } /* Rot */
.ts-nachts  { background: #3F51B5; } /* Dunkelblau */

.time-legend {
    display: flex;
    justify-content: space-between;
    font-size: 10px;
    margin-top: 5px;
    opacity: 0.7;
}

/* Verbessertes Monats-Chart */
.chart-bar {
    border-radius: 4px 4px 0 0; /* Runde Ecken oben */
    background: linear-gradient(to top, var(--accent), #64b5f6); /* Verlauf */
}

/* Animation Update f√ºr Staggering */
.fade-in { 
    opacity: 0; /* Startet unsichtbar */
    animation: fadeIn 0.4s cubic-bezier(0.25, 0.8, 0.25, 1) forwards; 
}

/* Die View selbst soll sofort da sein, nur der Inhalt animiert */
.view-section.active { 
    display: block; 
    /* animation hier entfernen, sonst doppelt sich das */
}

@keyframes fadeIn { 
    from { opacity: 0; transform: translateY(20px); } 
    to { opacity: 1; transform: translateY(0); } 
}

/* Ripple Animation */
.ripple {
    position: absolute;
    border-radius: 50%;
    transform: scale(0);
    animation: ripple-anim 0.6s linear;
    background-color: rgba(255, 255, 255, 0.4);
    pointer-events: none; /* Klicks gehen durch */
}
@keyframes ripple-anim {
    to { transform: scale(4); opacity: 0; }
}
/* Damit der Ripple nicht aus dem Button rausl√§uft */
.action-btn-main, .click-area-left, .nav-item {
    position: relative;
    overflow: hidden; 
}

/* Eine Klasse f√ºr aktive Zeilen */
.row.is-active {
    border-color: var(--accent); /* Rand in Akzentfarbe */
    background: linear-gradient(to right, var(--card), rgba(33, 150, 243, 0.05)); /* Leichter Schimmer */
    box-shadow: 0 4px 12px var(--accent-glow);
}
/* Im Darkmode etwas dezenter */
body.dark .row.is-active {
    background: linear-gradient(to right, var(--card), rgba(100, 181, 246, 0.08));
}

/* Toggle Button f√ºr die Liste */
.list-toggle-btn {
    width: 100%;
    max-width: 300px;
    margin: 10px auto 20px auto; /* Zentriert mit Abstand */
    padding: 10px 20px;
    background: var(--card);
    border: 1px solid var(--btn);
    border-radius: 30px; /* Pillenform */
    color: var(--sub);
    font-weight: 600;
    font-size: 14px;
    text-align: center;
    cursor: pointer;
    box-shadow: var(--shadow);
    display: flex; align-items: center; justify-content: center; gap: 8px;
    transition: all 0.2s;
}

.list-toggle-btn:active { transform: scale(0.96); }

/* Wenn offen: Dunkler/Aktiver */
.list-toggle-btn.is-open {
    background: var(--btn);
    color: var(--text);
    border-color: var(--sub);
}

/* Kleiner Pfeil Animation */
.arrow-icon { display: inline-block; transition: transform 0.3s; }
.list-toggle-btn.is-open .arrow-icon { transform: rotate(180deg); }

/* Dashboard Hero Card */
.dashboard-hero {
    background: linear-gradient(135deg, var(--accent), #9c27b0);
    border-radius: 24px;
    padding: 20px;
    color: white;
    box-shadow: 0 10px 20px rgba(33, 150, 243, 0.3);
    margin-bottom: 20px;
    text-align: center;
    position: relative;
    overflow: hidden;
}
.dashboard-hero h2 { margin: 0; font-size: 32px; font-weight: 900; }
.dashboard-hero p { margin: 5px 0 0 0; opacity: 0.9; font-size: 14px; }
.hero-bg-icon {
    position: absolute; right: -20px; bottom: -20px;
    font-size: 100px; opacity: 0.2; pointer-events: none;
}

/* Favoriten Karussell */
.fav-scroll-title { margin-left: 5px; font-size: 13px; font-weight:bold; color:var(--sub); margin-bottom:10px; text-transform:uppercase; letter-spacing:1px; }
.fav-scroll-container {
    display: flex;
    gap: 12px;
    overflow-x: auto;
    padding: 5px 5px 20px 5px; /* Platz f√ºr Schatten */
    margin-bottom: 10px;
    scrollbar-width: none; /* Firefox */
}
.fav-scroll-container::-webkit-scrollbar { display: none; } /* Chrome/Safari */

.fav-card {
    min-width: 100px;
    background: var(--card);
    border-radius: 18px;
    padding: 15px 10px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    box-shadow: var(--shadow);
    border: 1px solid rgba(255,255,255,0.1);
    cursor: pointer;
    transition: transform 0.2s;
}
.fav-card:active { transform: scale(0.95); }
.fav-emoji { font-size: 32px; margin-bottom: 5px; }
.fav-name { font-size: 12px; font-weight: bold; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }
.fav-count { 
    background: var(--btn); color: var(--accent); 
    font-size: 11px; font-weight: bold; 
    padding: 2px 8px; border-radius: 10px; margin-top: 5px; 
}

/* Update f√ºr Favoriten Bilder */
.fav-visual {
    width: 48px; 
    height: 48px;
    display: flex; 
    align-items: center; 
    justify-content: center;
    border-radius: 14px;
    background: var(--bg); /* Leichter Kontrast */
    margin-bottom: 6px;
    overflow: hidden;
    font-size: 28px; /* Gr√∂√üe f√ºr Emoji */
    border: 1px solid transparent;
}
/* Wenn ein Bild drin ist */
.fav-visual img { 
    width: 100%; 
    height: 100%; 
    object-fit: cover; 
}

.fav-card {
    min-width: 100px;
    /* Leichter Verlauf im Hintergrund f√ºr Tiefe */
    background: linear-gradient(160deg, var(--card), rgba(255,255,255,0.5));
    border-radius: 18px;
    padding: 15px 10px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    
    /* HIER: Die farbige Umrandung (nutzt deine Akzent-Farbe mit Transparenz) */
    border: 2px solid var(--accent-glow);
    box-shadow: 0 4px 15px rgba(0,0,0,0.03);
    
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
    position: relative;
    overflow: hidden;
}

/* Dark Mode Anpassung f√ºr den Hintergrund */
body.dark .fav-card {
    background: linear-gradient(160deg, var(--card-solid), #2a2a2a);
}

/* Klick-Effekt: Rand wird st√§rker, Karte schrumpft leicht */
.fav-card:active { 
    transform: scale(0.96); 
    border-color: var(--accent); /* Volle Farbe beim Klicken */
    background: rgba(33, 150, 243, 0.1); /* Leichter blauer Hintergrund */
}


/* Im Dark Mode darf der Schein etwas intensiver sein */
body.dark .fav-card {
    background: var(--card-solid);
    box-shadow: 0 10px 30px -10px var(--accent-glow);
}

/* Klick-Effekt: Karte wird "reingedr√ºckt" und der Schein wird enger/heller */
.fav-card:active { 
    transform: scale(0.95); 
    box-shadow: 0 0 20px var(--accent); /* Schein wird intensiv beim Dr√ºcken */
}

.fav-card {
    min-width: 95px; /* Etwas kompakter */
    background: var(--card);
    border-radius: 18px;
    
    /* HIER IST DER FIX F√úR GLEICHM√ÑSSIGKEIT: */
    padding: 12px; /* √úberall exakt 12px Abstand zum Rand */
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    justify-content: center;
    gap: 6px; /* Exakt 6px Platz zwischen Bild, Name und Zahl */
    
    /* HIER DER "D√úNNERE" SCHEIN: */
    /* 0px Versatz, 15px Weichzeichner, -4px Verbreitung = Enger Schein um die Karte */
    box-shadow: 0 0 15px -4px var(--accent-glow); 
    border: 1px solid rgba(255,255,255,0.1); /* Hauchd√ºnne Linie f√ºr Struktur */
    
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
    position: relative;
    overflow: hidden;
}

/* Dark Mode Anpassung */
body.dark .fav-card {
    background: var(--card-solid);
    box-shadow: 0 0 15px -2px var(--accent-glow); /* Im Dunkeln etwas st√§rker */
}

.fav-card:active { 
    transform: scale(0.96); 
    box-shadow: 0 0 20px var(--accent); /* Aufleuchten beim Klick */
}

/* Das Bild/Emoji-Symbol */
.fav-visual {
    width: 44px; 
    height: 44px;
    display: flex; 
    align-items: center; 
    justify-content: center;
    border-radius: 12px; /* Radius passend zur Karte */
    background: var(--bg); 
    
    /* Reset von Margins, da wir jetzt 'gap' in der Karte nutzen */
    margin: 0; 
    
    overflow: hidden;
    font-size: 26px;
    
    /* Rahmen um das BILD selbst (falls gew√ºnscht) */
    border: 1px solid rgba(0,0,0,0.05); 
}

/* Z√§hler-Badge Reset */
.fav-count { 
    background: var(--btn); color: var(--accent); 
    font-size: 10px; font-weight: 800; 
    padding: 3px 8px; border-radius: 10px; 
    margin: 0; /* Reset Margin */
}

/* Name Reset */
.fav-name {
    font-size: 11px; font-weight: 700;
    text-align: center; width: 100%;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    margin: 0; /* Reset Margin */
    opacity: 0.9;
}
/* OLED Anpassung f√ºr Navigation */
body.dark .bottom-nav {
    background: #000000;
    border-top: 1px solid #333; /* Feine Linie oben */
    border-left: 1px solid #333;
    border-right: 1px solid #333;
    border-bottom: none;
    box-shadow: 0 -5px 20px rgba(255, 255, 255, 0.05); /* Leichter wei√üer Schein nach oben */
}

/* OLED Anpassung f√ºr Sticky Header (falls genutzt) */
body.dark .sticky-wrapper {
    background: #000000;
    border-bottom: 1px solid #333;
}

/* OLED Anpassung f√ºr Listen-Elemente (damit man die Kanten sieht) */
body.dark .row, 
body.dark .grid-item,
body.dark .card-section,
body.dark .fav-card {
    border: 1px solid #222; /* Subtile Grenze */
    background: #000000;
}

/* Aktive Zeile (Glow) im OLED Modus */
body.dark .row.is-active {
    background: #000000;
    border: 1px solid var(--accent);
    box-shadow: 0 0 10px rgba(68, 165, 255, 0.2);
}

/* TOP 3 STATS STYLES */
.top3-container {
    display: flex; flex-direction: column; gap: 8px;
}
.top3-row {
    position: relative;
    display: flex; align-items: center; gap: 12px;
    padding: 10px 15px;
    background: var(--bg);
    border-radius: 16px;
    overflow: hidden; /* Damit der Balken nicht rausguckt */
    border: 1px solid var(--btn);
}
/* Der Balken im Hintergrund */
.top3-bar {
    position: absolute;
    left: 0; top: 0; bottom: 0;
    background: var(--accent);
    opacity: 0.15; /* Transparent, damit Text lesbar bleibt */
    z-index: 0;
    transition: width 0.5s ease-out;
}
/* Elemente im Vordergrund */
.top3-medal { font-size: 22px; z-index: 1; width: 30px; text-align: center; }
.top3-img { 
    width: 44px; height: 44px; 
    border-radius: 50%; 
    background: var(--card-solid);
    display: flex; align-items: center; justify-content: center;
    font-size: 24px;
    z-index: 1;
    border: 2px solid var(--card-solid);
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    overflow: hidden;
}
.top3-img img { width: 100%; height: 100%; object-fit: cover; }

.top3-info { 
    flex: 1; z-index: 1; 
    display: flex; justify-content: space-between; align-items: center;
    font-size: 14px; font-weight: bold;
}
.top3-count {
    background: var(--card-solid);
    padding: 4px 10px; border-radius: 10px;
    font-size: 13px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
#scrollTopBtn {
    position: fixed;
    bottom: 95px; /* √úber der Bottom-Nav */
    right: 20px;
    width: 44px; height: 44px;
    background: var(--card-solid);
    border: 1px solid var(--btn);
    border-radius: 50%;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    display: none; /* Erstmal unsichtbar */
    align-items: center; justify-content: center;
    font-size: 20px;
    cursor: pointer;
    z-index: 8000;
    transition: transform 0.2s, opacity 0.2s;
}
#scrollTopBtn:active { transform: scale(0.9); }
/* Dark Mode Anpassung */
body.dark #scrollTopBtn { background: #222; border-color: #333; color: white; }

/* Wenn body die Klasse 'compact-view' hat */
body.compact-view .row {
    padding: 4px 8px; /* Weniger Polsterung */
    min-height: 40px; /* Flacher */
}
body.compact-view .click-area-left {
    flex-direction: row; /* Nebeneinander statt untereinander */
    min-width: auto;
    gap: 8px;
}
body.compact-view .animal-icon {
    width: 30px; height: 30px; font-size: 18px; /* Kleineres Icon */
}
body.compact-view .name {
    font-size: 14px; text-align: left; /* Name linksb√ºndig */
    max-width: 150px;
}
body.compact-view .action-btn-main, 
body.compact-view .action-btn-secondary,
body.compact-view .action-btn-minus {
    width: 32px; height: 32px; font-size: 16px; /* Kleinere Buttons */
}
/* === HEUTE MODAL STYLES === */
.today-list-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
    padding: 10px 0;
}

.today-row {
    display: flex;
    gap: 12px;
    animation: fadeIn 0.3s ease-out;
}

.today-time-col {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 50px;
    padding-top: 5px;
}

.today-time-text {
    font-size: 12px;
    font-weight: bold;
    color: var(--sub);
    background: var(--bg);
    padding: 2px 6px;
    border-radius: 8px;
    border: 1px solid var(--btn);
}

.today-line {
    width: 2px;
    flex: 1;
    background: var(--btn);
    margin-top: 5px;
    border-radius: 2px;
}

.today-bubble {
    flex: 1;
    background: var(--card);
    border: 1px solid var(--btn);
    border-radius: 0 16px 16px 16px; /* Chat-Bubble Look */
    padding: 12px;
    position: relative;
    box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    transition: transform 0.2s;
}
.today-bubble:active { transform: scale(0.98); }

.today-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
}

.today-animal-name {
    font-weight: 800;
    font-size: 15px;
    color: var(--text);
}

.today-details {
    font-size: 13px;
    color: var(--sub);
    line-height: 1.4;
}

.today-tag {
    display: inline-block;
    background: rgba(33, 150, 243, 0.1);
    color: var(--accent);
    padding: 2px 8px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: bold;
    margin-right: 5px;
}

/* Backup Alert Box */
.backup-alert {
    background: var(--warn-bg);
    color: var(--warn-text);
    padding: 12px 15px;
    border-radius: 12px;
    margin-bottom: 15px;
    font-size: 13px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    animation: fadeIn 0.3s ease-out;
    border: 1px solid rgba(0,0,0,0.05);
}
.backup-alert button {
    background: transparent;
    color: inherit;
    font-weight: bold;
    font-size: 16px;
    padding: 0 5px;
    width: auto;
    height: auto;
    border-radius: 4px;
}
.backup-alert button:hover {
    background: rgba(0,0,0,0.1);
}
/* === ACCORDION STYLES === */
.accordion-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    /* Damit der Klickbereich gro√ü ist, nehmen wir das Padding vom h3 weg/dazu */
    padding-bottom: 0 !important; 
    border-bottom: none !important;
    margin-bottom: 0 !important;
    transition: opacity 0.2s;
}
.accordion-header:active { opacity: 0.6; }

/* Der Pfeil */
.acc-chevron {
    font-size: 14px;
    opacity: 0.5;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.card-section.open .acc-chevron {
    transform: rotate(180deg);
}

/* Der Inhalt (animiert) */
.accordion-content {
    display: grid;
    grid-template-rows: 0fr;
    transition: grid-template-rows 0.3s cubic-bezier(0.4, 0, 0.2, 1), 
                opacity 0.3s ease-out, 
                padding 0.3s ease;
    opacity: 0;
    overflow: hidden;
}
.card-section.open .accordion-content {
    grid-template-rows: 1fr;
    opacity: 1;
    /* Trennlinie erscheint erst beim √ñffnen */
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid var(--btn);
}
.accordion-inner {
    min-height: 0;
    /* Bugfix f√ºr Overflow bei Grid Animation */
    overflow: hidden; 
}

/* Warn-Badge auf dem Header (wenn zugeklappt) */
.header-warning-badge {
    background: var(--err-bg);
    color: var(--err-text);
    font-size: 11px;
    font-weight: bold;
    padding: 4px 10px;
    border-radius: 12px;
    margin-right: 10px;
    margin-left: auto; /* Schiebt es nach rechts */
    display: none; /* Standardm√§√üig aus */
    border: 1px solid var(--err-text);
    animation: pulseBadge 2s infinite;
}
@keyframes pulseBadge {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}


/* === ANPASSUNG: LIST HEADER (Symmetrisch) === */
.list-header { 
    display:flex; 
    gap: 10px; /* Abstand zwischen Suchleiste und Button */
    margin-bottom:15px; 
    position: relative; 
    z-index: 5; 
}

/* Suchleiste und neuer Button teilen sich den Platz 50/50 */
.search-bar { 
    flex: 1; 
    width: auto; /* Reset */
    margin: 0;
}

/* Der neue gro√üe Button "Sichtung" */
.btn-sighting-large {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: 25px; /* Gleiche Rundung wie Searchbar */
    font-weight: bold;
    font-size: 15px;
    box-shadow: var(--shadow);
    cursor: pointer;
    padding: 12px 16px;
    transition: transform 0.2s;
}
.btn-sighting-large:active { transform: scale(0.96); }

/* === NEU: SCHWEBENDE KONTROLLEN (Sortieren/Ansicht) === */
/* Container √ºber der Liste */
.list-controls-floating {
    display: none; /* Standardm√§√üig aus */
    justify-content: flex-end; /* Rechtsb√ºndig */
    gap: 10px;
    margin-bottom: 10px;
    padding: 0 5px;
    animation: fadeIn 0.3s ease-out;
}
/* Sichtbar machen Klasse */
.list-controls-floating.visible { display: flex; }

/* Die Buttons darin (kleiner, dezenter) */
.float-btn {
    width: 40px; 
    height: 40px; 
    border-radius: 12px;
    background: var(--card);
    border: 1px solid var(--btn);
    color: var(--text);
    box-shadow: var(--shadow);
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
    cursor: pointer;
}

</style>
</head>
<body>

<!-- Global Toast & Undo -->
<div id="errorToast" class="error-toast"></div>
<div id="undoToast" class="undo-toast">
    <span id="undoText">Gez√§hlt: L√∂we (+1)</span>
    <button class="undo-btn" onclick="safeRun(performUndo)">R√ºckg√§ngig</button>
</div>

<!-- HEADER -->
<div class="header-controls">
  <button class="icon-btn-header" onclick="safeRun(openNotifySettings)" title="Einstellungen & Erinnerungen">üîî</button>
  <button class="icon-btn-header" onclick="safeRun(toggleMute)" id="muteBtn" title="Ton an/aus">üîá</button>
  <button class="icon-btn-header info" onclick="safeRun(toggleInfo)" title="Hilfe anzeigen">‚ÑπÔ∏è</button>
</div>

<h1>Tiere Z√§hlen <span style="font-size:0.5em; opacity:0.6; vertical-align:middle; font-weight:normal">v6.4</span></h1>

<!-- INFO BOX (Anleitung f√ºr Endanwender) -->
<div id="infoBox" class="glass-panel" style="display:none; padding:20px; margin-bottom:20px; border-radius:20px;">
<h3>üìñ Anleitung</h3>
<p>Willkommen! So benutzt du die App:</p>
<ul style="line-height:1.6; padding-left:20px;">
<li><strong>üî¢ Z√§hlen:</strong> Tippe auf das (+), um ein Tier zu z√§hlen.</li>
<li><strong>üîç Details & Historie:</strong> Tippe auf den Namen oder das Bild eines Tiers, um alle Sichtungen zu sehen. <em>(Schlie√üen nur √ºber das X oben rechts m√∂glich)</em>.</li>
<li><strong>üìù Notizen:</strong> Klicke auf das üìù Symbol, um eine Notiz oder eine genaue Uhrzeit einzutragen.</li>
<li><strong>‚≠ê Favoriten:</strong> Markiere deine Lieblingstiere mit dem Stern, damit sie oben stehen.</li>
<li><strong>‚öôÔ∏è Verwalten:</strong> Unten auf "Admin" kannst du neue Tiere anlegen oder Backups machen.</li>
</ul>
</div>
<div id="scrollTopBtn" onclick="window.scrollTo({top:0, behavior:'smooth'})">‚¨ÜÔ∏è</div>


<!-- === VIEW: LIST (Startseite) === -->
<div id="view-list" class="view-section active">
<div class="list-header">
      <!-- Suchleiste -->
      <input id="listSearch" class="search-bar" placeholder="üîç Tier suchen..." oninput="safeRun(debouncedRender)">
      
      <!-- Neuer gro√üer Button -->
      <button class="btn-sighting-large" onclick="safeRun(openQuickSighting)">
          <span style="font-size:18px; font-weight:900;">+</span> Sichtung
      </button>
  </div>


  <!-- Tag Filter bleibt hier -->
  <div id="tagFilterContainer" class="tag-scroll">...</div>

  <!-- NEU: Container f√ºr Sortieren/Ansicht (Omnipr√§sent √ºber der Liste) -->
  <div id="floatingControls" class="list-controls-floating">
      <button class="float-btn" onclick="safeRun(toggleViewMode)" id="viewToggleBtn" title="Ansicht wechseln">üìú</button>
      <button class="float-btn" onclick="safeRun(cycleSort)" id="sortBtn" title="Sortieren">‚≠ê</button>
  </div>

  <div id="list" style="padding-bottom: 20px;"></div>


  <div id="list" style="padding-bottom: 20px;"></div>
  
  <div id="emptyState" style="text-align:center; padding:60px 20px; color:var(--sub); display:none;">
      <div style="font-size:60px; margin-bottom:15px; opacity:0.5">üêæ</div>
      <h3>Keine Tiere gefunden</h3>
      <p>Gehe auf "Admin" um neue Tiere anzulegen.</p>
  </div>
</div>


<!-- === VIEW: ADMIN (Verwalten) === -->
 <!-- === VIEW: ADMIN (Verwalten) === -->
<div id="view-admin" class="view-section">
  
  <!-- BUBBLE 1: NEUES TIER (Kein Akkordeon, bleibt statisch offen) -->
  <div class="card-section">
    <h3>üêæ Neues Tier anlegen</h3>
    <div class="edit-tools" style="margin-bottom:0">
      <label class="file-label">
          <span style="font-size:24px">üñºÔ∏è</span> Galerie
          <input type="file" id="fileUpload" hidden accept="image/*" onchange="safeRun(handleImageUpload, this)">
      </label>
      <label class="file-label">
          <span style="font-size:24px">üì∑</span> Kamera
          <input type="file" id="cameraUpload" hidden accept="image/*" capture="environment" onchange="safeRun(handleImageUpload, this)">
      </label>
    </div>
    
    <div style="display:flex; gap:10px; margin:15px 0;">
        <input id="emojiInput" placeholder="ü¶Å" size="3" style="width:60px; text-align:center; font-size:24px">
        <input id="nameInput" placeholder="Name des Tiers (z.B. Rotfuchs)" style="flex:1">
    </div>
    
    <div style="margin-bottom:15px">
        <input id="tagInput" placeholder="Kategorie (z.B. Katze, V√∂gel)..." list="tagSuggestions">
        <datalist id="tagSuggestions">
            <option value="Katze"><option value="Hund"><option value="Fuchs">
            <option value="Hase"><option value="Igel"><option value="Marder">
            <option value="V√∂gel"><option value="Insekten">
        </datalist>
    </div>
    
    <div id="imgPreview" style="display:none; margin-bottom:15px; position:relative; width:fit-content; margin: 0 auto 15px auto;">
        <img id="previewEl" src="" style="width:80px; height:80px; border-radius:20px; object-fit:cover; border:2px solid var(--accent)">
        <div onclick="safeRun(clearImage)" style="position:absolute; top:-5px; right:-5px; background:red; color:white; border-radius:50%; width:24px; height:24px; display:flex; align-items:center; justify-content:center; cursor:pointer">‚úñ</div>
    </div>

    <button onclick="safeRun(addAnimal)" style="width:100%; background:var(--accent); color:#fff; padding:14px;">Tier Speichern ‚ú®</button>
  </div>

  <!-- BUBBLE 2: ORTE (Akkordeon) -->
  <div class="card-section">
    <!-- ONCLICK JETZT NUR HIER IM HEADER -->
    <div class="accordion-header" onclick="toggleAccordion(this)">
        <h3>üìç Orte & Suche</h3>
        <span class="acc-chevron">‚ñº</span>
    </div>
    <div class="accordion-content">
        <div class="accordion-inner">
            <p style="font-size:12px; opacity:0.7; margin-bottom:10px">Suche Orte oder nutze GPS, um die Adresse automatisch zu finden.</p>
            <div style="display:flex; gap:8px; align-items:flex-start;">
                <div class="autocomplete-container" style="flex:1">
                  <input id="osmInput" placeholder="Ort suchen (Enter)...">
                  <div id="osmResults" class="autocomplete-results"></div>
                </div>
                <button onclick="safeRun(locateMe)" title="Mein Standort" style="background:var(--card-solid); border:1px solid var(--btn); min-width:44px">üìç</button>
                <button onclick="safeRun(addManualLocation)" style="min-width:44px;">üíæ</button>
            </div>
            <div style="margin-top:15px; border-top:1px solid var(--btn); padding-top:10px;">
                <span style="font-size:12px; opacity:0.7">Gespeicherte Orte (zum L√∂schen antippen):</span>
                <div id="locationListDisplay" style="display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; max-height:120px; overflow-y:auto;"></div>
            </div>
        </div>
    </div>
  </div>

  <!-- BUBBLE 3: DATEN (Akkordeon) -->
  <div class="card-section">
    <!-- ONCLICK JETZT NUR HIER IM HEADER -->
    <div class="accordion-header" onclick="toggleAccordion(this)">
        <h3>üíæ Daten & Sicherung</h3>
        <div id="backupHeaderBadge" class="header-warning-badge">‚ö†Ô∏è Backup f√§llig!</div>
        <span class="acc-chevron">‚ñº</span>
    </div>
    <div class="accordion-content">
        <div class="accordion-inner">
            <!-- Warnbox -->
            <div id="backupWarningBox" class="backup-alert" style="display:none;">
                <div>
                    ‚ö†Ô∏è Dein letztes Backup ist <strong id="backupDaysCount">lange</strong> her.<br>
                    <span style="opacity:0.8; font-size:11px;">Sichere deine Sammlung lieber mal!</span>
                </div>
                <button onclick="document.getElementById('backupWarningBox').style.display='none'" title="Ausblenden">‚úï</button>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                <button onclick="safeRun(toggleDarkMode)">üåô Design</button>
                <button onclick="safeRun(downloadBackup)">üì¶ Backup</button>
                <button onclick="safeRun(exportCSV)">üìÑ CSV Export</button>
                <button onclick="document.getElementById('importFile').click()">üì• Import</button>
                <input type="file" id="importFile" accept="application/json" hidden onchange="safeRun(importBackup, event)">
            </div>

            <div style="margin-top:20px; font-size:12px; opacity:0.8;">
                <div style="display:flex; justify-content:space-between"><span>Bild-Datenbank (IndexedDB):</span><span id="storageText">Lade...</span></div>
                <div class="xp-bar-bg" style="height:6px; margin-top:5px; background:var(--btn)"><div id="storageBar" class="xp-bar-fill" style="width:0%; background:var(--accent)"></div></div>
            </div>
        </div>
    </div>
  </div>

  <!-- BUBBLE 4: PAPIERKORB (Akkordeon) -->
  <div id="trashSection" class="card-section" style="border-color:var(--err-bg);">
      <!-- ONCLICK JETZT NUR HIER IM HEADER -->
      <div class="accordion-header" onclick="toggleAccordion(this)">
        <h3 style="color:var(--err-text)">üóëÔ∏è Papierkorb</h3>
        <span class="acc-chevron">‚ñº</span>
      </div>
      <div class="accordion-content">
        <div class="accordion-inner">
          <p style="font-size:12px; opacity:0.7; margin-bottom:10px">Gel√∂schte Elemente werden nach 30 Tagen automatisch entfernt.</p>
          <div id="trashList" style="max-height:200px; overflow-y:auto; margin-bottom:15px; background:var(--bg); border-radius:12px;"></div>
          <button onclick="safeRun(emptyTrash)" style="width:100%; background:var(--err-bg); color:var(--err-text); border:1px solid var(--err-text)">
              Papierkorb jetzt leeren
          </button>
        </div>
      </div>
  </div>    

  <div style="text-align:center; margin-top:40px; padding-top:20px; border-top:1px dashed var(--btn);">
      <p style="color:var(--err-text); font-weight:bold; font-size:12px; margin-bottom:10px">‚ö†Ô∏è GEFAHRENZONE</p>
      <button onclick="safeRun(hardReset)" style="background:transparent; color:var(--err-text); border:1px solid var(--err-text); font-size:12px">‚ö†Ô∏è App vollst√§ndig zur√ºcksetzen</button>
  </div>
</div>

<!-- === VIEW: MAP (Karte) === -->
<div id="view-map" class="view-section">
    <div id="map"></div>
    <div style="text-align:center; opacity:0.7; font-size:13px">Zeigt Orte deiner Sichtungen aller Jahre.</div>
</div>

<!-- === VIEW: STATS (Statistik) === -->
<div id="view-stats" class="view-section">
  <div style="display:flex; justify-content:flex-end; margin-bottom:15px">
      <select id="statsYearSelect" onchange="safeRun(renderStats)" style="width:auto; font-weight:bold; background:var(--card);"></select>
  </div>
  <div id="statsContainer">
    <div id="statsContent"></div>
  </div>
  <button onclick="safeRun(generateShareCard)" style="width:100%; margin-top:20px; background:var(--text); color:var(--bg)">üé® Share Card erstellen</button>
</div>

<!-- === BOTTOM NAV === -->
<div class="bottom-nav">
    <button class="nav-item active" onclick="safeRun(switchView, 'view-list', this)">
        <span class="nav-icon">üìã</span>
        <span>Liste</span>
    </button>
    <button class="nav-item" onclick="safeRun(switchView, 'view-admin', this)">
        <span class="nav-icon">‚öôÔ∏è</span>
        <span>Admin</span>
    </button>
    <button class="nav-item" onclick="safeRun(switchView, 'view-map', this)">
        <span class="nav-icon">üåç</span>
        <span>Karte</span>
    </button>
    <button class="nav-item" onclick="safeRun(switchView, 'view-stats', this)">
        <span class="nav-icon">üìä</span>
        <span>Stats</span>
    </button>
</div>

<!-- MODALS WITH SWIPE HANDLE -->
<div id="detailModal" class="modal">
    <div class="modal-content">
        <!-- SHEET HANDLE ENTFERNT, damit man nicht denkt, man kann swipen -->
        <div class="close-btn" onclick="closeModal('detailModal')">‚úï</div>
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:20px; padding-bottom:10px; border-bottom:1px solid var(--btn)">
             <div class="modal-icon" id="detailIcon" style="font-size:50px; line-height:1"></div>
             <div>
                 <h2 id="detailTitle" style="margin:0">Tier</h2>
                 <select id="detailYearSelect" onchange="safeRun(updateDetailChart)" style="padding:4px; font-size:13px; margin-top:4px"></select>
             </div>
        </div>
        <div id="modalBody"></div>
    </div>
</div>

<div id="noteModal" class="modal">
  <div class="modal-content">
    <div class="sheet-handle"></div>
    <div class="close-btn" onclick="closeModal('noteModal')">‚úï</div>
    
    <h3 id="noteModalTitle">üìù Notiz & Details</h3>

    <!-- NEU: Tier-Auswahl (Nur sichtbar bei "Schnell-Sichtung") -->
    <div id="noteAnimalWrapper" style="display:none; margin-bottom:15px; position:relative;">
        <label style="font-size:12px; font-weight:bold; opacity:0.7; margin-bottom:4px; display:block;">Welches Tier?</label>
        <input id="noteAnimalInput" placeholder="üîç Tiername tippen (z.B. Wolf)..." style="font-weight:bold; border:2px solid var(--accent);">
        <!-- Autocomplete Liste -->
        <div id="noteAnimalResults" class="autocomplete-results"></div>
    </div>

    <!-- Bestehende Inputs -->
    <input type="date" id="noteDate" style="margin-bottom:10px">
    <div style="display:flex; gap:10px; margin-bottom:10px">
        <input type="time" id="noteTime">
        <select id="noteLoc"></select>
    </div>
    <textarea id="noteText" placeholder="Was hast du beobachtet?" rows="4" style="margin-bottom:15px"></textarea>
    <button id="noteSaveBtn" style="width:100%; background:var(--accent); color:#fff; padding:15px">Speichern</button>
  </div>
</div>

<div id="importModal" class="modal">
  <div class="modal-content" style="text-align:center">
    <div class="sheet-handle"></div>
    <h3>Backup Importieren</h3>
    <p style="opacity:0.7">Wie m√∂chtest du die Daten importieren?</p>
    <div class="import-actions">
        <button class="btn-merge" onclick="safeRun(confirmImport, 'merge')">‚ú® Zusammenf√ºgen (Smart Merge)<br><small>F√ºgt neue Daten hinzu, beh√§lt alte</small></button>
        <button class="btn-overwrite" onclick="safeRun(confirmImport, 'overwrite')" style="background:var(--err-bg); color:var(--err-text); border:1px solid var(--err-text)">‚ö†Ô∏è Alles √úberschreiben<br><small>L√∂scht ALLE aktuellen Daten</small></button>
        <button onclick="safeRun(confirmImport, 'cancel')">Abbrechen</button>
    </div>
  </div>
</div>

<div id="iconModal" class="modal">
  <div class="modal-content">
    <div class="sheet-handle"></div>
    <div class="close-btn" onclick="closeModal('iconModal')">‚úï</div>
    
    <h3>‚úèÔ∏è Tier bearbeiten</h3>
    
    <!-- Bilder Upload -->
    <div class="edit-tools">
       <label class="file-label">üñºÔ∏è Galerie<input type="file" id="editFileInput" hidden accept="image/*" onchange="safeRun(handleEditFile, this)"></label>
       <label class="file-label">üì∑ Foto<input type="file" id="editCameraInput" hidden accept="image/*" capture="environment" onchange="safeRun(handleEditFile, this)"></label>
    </div>

    <!-- Bild Vorschau -->
    <div id="editPreviewContainer" style="text-align:center; display:none; margin-bottom:15px">
        <img id="editPreviewImg" src="" style="width:100px; height:100px; border-radius:20px; object-fit:cover; border:3px solid var(--accent); box-shadow:0 5px 15px rgba(0,0,0,0.2);">
        <br><button onclick="safeRun(removeEditImage)" style="margin-top:8px; font-size:12px; padding:6px 12px; background:var(--err-bg); color:var(--err-text); border:none; border-radius:15px; font-weight:bold;">üóëÔ∏è Bild entfernen</button>
    </div>

    <!-- NEU: Name √§ndern -->
    <label style="font-size:12px; font-weight:bold; opacity:0.7; margin-bottom:4px; display:block;">Name:</label>
    <div style="display:flex; gap:10px; margin-bottom:15px">
       <input id="editEmoji" style="width:60px; font-size:24px; text-align:center" placeholder="Icon">
       <input id="editName" placeholder="Tiername (z.B. Wolf)" style="font-weight:bold;">
    </div>

    <!-- Kategorien -->
    <label style="font-size:12px; font-weight:bold; opacity:0.7; margin-bottom:4px; display:block;">Kategorie / Tags:</label>
    <input id="editTag" placeholder="z.B. S√§ugetiere, Wald (Komma getrennt)" style="margin-bottom:20px;">

    <button onclick="safeRun(saveIconEdit)" style="width:100%; background:var(--accent); color:#fff; padding:15px; font-size:16px;">üíæ √Ñnderungen speichern</button>
  </div>
</div>

<div id="notifyModal" class="modal">
  <div class="modal-content">
    <div class="sheet-handle"></div>
    <div class="close-btn" onclick="closeModal('notifyModal')">‚úï</div>
    <h3>üîî Einstellungen</h3>
<!-- Neuer Schalter f√ºr Kompakt-Modus -->
    <div style="background:var(--bg); padding:15px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
        <span>Kompakt-Ansicht (klein)</span>
        <label class="switch">
            <!-- WICHTIG: onchange ruft toggleCompactMode auf -->
            <input type="checkbox" id="compactToggle" onchange="safeRun(toggleCompactMode)">
            <span class="slider"></span>
        </label>
    </div>
    <div style="background:var(--bg); padding:15px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
        <span>Inaktivit√§ts-Alarm</span>
        <label class="switch"><input type="checkbox" id="notifyToggle"><span class="slider"></span></label>
    </div>
    <div style="display:flex; gap:10px; align-items:center; margin-bottom:20px">
        <span>Nach Tagen:</span> <input type="number" id="notifyDays" value="7" style="width:80px">
    </div>
    <div style="display:flex; gap:10px; margin-bottom:20px">
        <button onclick="safeRun(saveNotifySettings)" style="flex:1; background:var(--accent); color:#fff">Speichern</button>
        <button onclick="safeRun(testNotification)" style="flex:1;">Testen</button>
    </div>
    <hr style="opacity:0.2">
    <h4>üìÖ Kalender-Export</h4>
    <div style="display:flex; gap:5px; margin-bottom:10px">
        <select id="icsFreq"><option value="WEEKLY">W√∂chentlich</option><option value="DAILY">T√§glich</option></select>
        <input type="time" id="icsTime" value="19:00">
    </div>
    <select id="icsDay" style="margin-bottom:10px"><option value="SA">Samstag</option><option value="SU">Sonntag</option></select>
    <button onclick="safeRun(downloadICS)" style="width:100%">üìÖ ICS Datei laden</button>
  </div>
</div>

<!-- PAPIERKORB DETAILS MODAL -->
<div id="trashDetailModal" class="modal">
  <div class="modal-content">
    <div class="sheet-handle"></div>
    <div class="close-btn" onclick="closeModal('trashDetailModal')">‚úï</div>
    <h3>üóëÔ∏è Gel√∂schtes Element</h3>
    
    <div style="background:var(--bg); padding:15px; border-radius:12px; margin-bottom:15px; font-size:14px; line-height:1.6">
        <div style="margin-bottom:8px"><strong>Art:</strong> <span id="tdType">...</span></div>
        <div style="margin-bottom:8px"><strong>Name:</strong> <span id="tdName" style="color:var(--accent); font-weight:bold">...</span></div>
        <div style="margin-bottom:8px"><strong>Datum:</strong> <span id="tdDate">...</span></div>
        <div style="margin-bottom:8px"><strong>Zeit:</strong> <span id="tdTime">...</span></div>
        <div style="margin-bottom:8px"><strong>Ort:</strong> <span id="tdLoc">...</span></div>
        <div><strong>Notiz:</strong> <div id="tdNote" style="background:var(--card); padding:8px; border-radius:8px; margin-top:4px; font-style:italic; opacity:0.8">...</div></div>
    </div>

    <button id="tdRestoreBtn" style="width:100%; background:var(--accent); color:#fff; padding:15px">‚ôªÔ∏è Wiederherstellen</button>
  </div>
</div>

<!-- HEUTE DETAILS MODAL -->
<div id="todayModal" class="modal">
  <div class="modal-content">
    <div class="sheet-handle"></div>
    <div class="close-btn" onclick="closeModal('todayModal')">‚úï</div>
    <h3>üìÖ Heute entdeckt</h3>
    <p style="font-size:13px; opacity:0.6; margin-top:-10px; margin-bottom:20px">Chronologische Liste deiner heutigen Sichtungen.</p>
    
    <div id="todayListContainer" class="today-list-container">
        <!-- Hier wird die Liste reingeladen -->
    </div>
  </div>
</div>

<!-- LIGHTBOX F√úR BILDER -->
<div id="lightboxModal" onclick="closeImageLightbox()">
    <img id="lightboxImg" src="" alt="Gro√üansicht">
</div>

<!-- LEAFLET JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
/** 
 * === TIER APP V6.4 ULTIMATE CORE ===
 * Fixes: Disabled Swipe for Details View
 */

// === 1. SWIPE GESTURE HANDLER ===
function initSwipeGestures() {
    let startY = 0;
    let currentModalContent = null;

    document.addEventListener('touchstart', (e) => {
        const handle = e.target.closest('.sheet-handle');
        const content = e.target.closest('.modal-content');
        
        // HIER WIRD DIE √ÑNDERUNG GEMACHT:
        // Wenn das Modal die ID 'detailModal' hat, brechen wir ab (kein Swipe)
        if (content && content.parentElement.id === 'detailModal') return;

        // Only allow swipe if touching handle OR touching content at the very top (scrolled up)
        if (content && (handle || content.scrollTop === 0)) {
            currentModalContent = content;
            startY = e.touches[0].clientY;
            // Remove transition for instant drag response
            currentModalContent.style.transition = 'none';
        }
    }, {passive: true});

    document.addEventListener('touchmove', (e) => {
        if (!currentModalContent) return;
        const currentY = e.touches[0].clientY;
        const delta = currentY - startY;

        // Only move if dragging DOWN
        if (delta > 0) {
            e.preventDefault(); // Prevent scrolling body
            currentModalContent.style.transform = `translateY(${delta}px)`;
        }
    }, {passive: false});

    document.addEventListener('touchend', (e) => {
        if (!currentModalContent) return;
        const delta = e.changedTouches[0].clientY - startY;

        // Restore transition for smooth bounce back or exit
        currentModalContent.style.transition = 'transform 0.3s ease-out';

        if (delta > 120) { // Threshold to close
            const modalId = currentModalContent.parentElement.id;
            closeModal(modalId);
            // Reset transform AFTER animation closes it (timeout matches css transition)
            setTimeout(() => { 
                currentModalContent.style.transform = ''; 
                currentModalContent.style.transition = '';
            }, 300);
        } else {
            // Bounce back
            currentModalContent.style.transform = '';
        }
        currentModalContent = null;
    });
}

// === 2. INDEXED DB WRAPPER (Async Image Storage) ===
const DB_NAME = 'TierAppDB';
const STORE_IMGS = 'images';
const dbPromise = new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = e => { e.target.result.createObjectStore(STORE_IMGS); };
    req.onsuccess = e => resolve(e.target.result);
    req.onerror = e => reject(e);
});

async function dbSaveImg(id, dataUrl) {
    const db = await dbPromise;
    return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_IMGS, 'readwrite');
        tx.objectStore(STORE_IMGS).put(dataUrl, id);
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject();
    });
}
async function dbGetImg(id) {
    const db = await dbPromise;
    return new Promise(resolve => {
        const tx = db.transaction(STORE_IMGS, 'readonly');
        const req = tx.objectStore(STORE_IMGS).get(id);
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => resolve(null);
    });
}
async function dbDelImg(id) {
    const db = await dbPromise;
    const tx = db.transaction(STORE_IMGS, 'readwrite');
    tx.objectStore(STORE_IMGS).delete(id);
}
async function dbCount() {
    const db = await dbPromise;
    return new Promise(resolve => {
        const req = db.transaction(STORE_IMGS, 'readonly').objectStore(STORE_IMGS).count();
        req.onsuccess = () => resolve(req.result);
    });
}

// === 3. GLOBALS & CONFIG ===
const currentSystemYear = new Date().getFullYear();
let animals = []; 
let locations = [];
let locCoords = {};
let dark = false;
let trashBin = [];
let currentTempImg = null;
let currentFilter = 'ALL';
let listExpanded = false; // Standardm√§√üig zugeklappt
let sortMode = 'fav'; 
let viewMode = 'list';
let isMuted = localStorage.getItem('muted') !== 'false';
let notifyConfig = JSON.parse(localStorage.getItem('notifyConfig')) || { enabled: false, days: 7 };
let undoStack = [];
let undoTimeout = null;
let mapInstance = null;
let tempImportData = null;
let detailAnimalIdx = null;

// KOMPAKT MODUS STATUS LADEN
let isCompact = localStorage.getItem('compactMode') === 'true';
if(isCompact) document.body.classList.add('compact-view');

function toggleCompactMode() {
    isCompact = !isCompact;
    localStorage.setItem('compactMode', isCompact);
    document.body.classList.toggle('compact-view', isCompact);
    render(); // Liste neu zeichnen, damit Abst√§nde passen
}

// LEVEL CONFIG
const levels = [
    { xp: 0, name: "Garten-Gucker" }, { xp: 100, name: "Park-Besucher" }, { xp: 250, name: "Spuren-Sucher" },
    { xp: 500, name: "Wald-Wanderer" }, { xp: 800, name: "Hobby-Beobachter" }, { xp: 1200, name: "Fernglas-Profi" },
    { xp: 1700, name: "Vogel-Versteher" }, { xp: 2300, name: "Pfadfinder" }, { xp: 3000, name: "Natur-Freund" },
    { xp: 3800, name: "Feld-Forscher" }, { xp: 4700, name: "Tier-Fl√ºsterer" }, { xp: 5700, name: "Wildnis-Entdecker" },
    { xp: 6800, name: "F√§hrtenleser" }, { xp: 8000, name: "Dschungel-Guide" }, { xp: 9500, name: "√ñkosystem-Experte" },
    { xp: 11500, name: "Wald-Ranger" }, { xp: 14000, name: "Meister-Biologe" }, { xp: 17000, name: "Nationalpark-Direktor" },
    { xp: 20000, name: "Tier-Orakel" }, { xp: 25000, name: "H√ºter der Wildnis" }
];

// Helper
const getEl = id => document.getElementById(id);
const todayStr = () => new Date().toISOString().slice(0,10);
const nowTimeStr = () => new Date().toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'});
function safeRun(fn, ...args){ try{fn(...args)}catch(e){console.error(e); showErrorToast(e.message)}}
function showErrorToast(msg, isInfo=false){
    const t=getEl('errorToast'); t.innerText=(isInfo?"‚ÑπÔ∏è ":"‚ö†Ô∏è ")+msg; 
    t.style.background=isInfo?"var(--accent)":"var(--err-bg)"; t.style.color=isInfo?"#fff":"var(--err-text)";
    t.style.display='block'; setTimeout(()=>t.style.display='none',4000);
}


// HELPER: Debounce f√ºr die Suche
let debounceTimer;
function debouncedRender() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
        render();
    }, 250);
}

function toggleMute(){ isMuted=!isMuted; localStorage.setItem('muted',isMuted); getEl('muteBtn').innerText=isMuted?'üîá':'üîä'; }

/* === HIER EINF√úGEN: RIPPLE EFFEKT LOGIK === */
 function createRipple(event) { const button = event.currentTarget; const circle = document.createElement("span"); const diameter = Math.max(button.clientWidth, button.clientHeight); const radius = diameter / 2; 
// Position berechnen 
const rect = button.getBoundingClientRect(); circle.style.width = circle.style.height = `${diameter}px`; circle.style.left = `${event.clientX - rect.left - radius}px`; circle.style.top = `${event.clientY - rect.top - radius}px`; circle.classList.add("ripple");
// Falls schon ein Ripple da ist, entfernen 
const ripple = button.getElementsByClassName("ripple")[0]; if (ripple) { ripple.remove(); } button.appendChild(circle); }
 /* === ENDE EINF√úGEN === */ 



// === 4. AUDIO ENGINE ===
const AudioContext = window.AudioContext || window.webkitAudioContext;
let audioCtx;
function playSound(type){
    if(isMuted) return;
    if(!audioCtx) audioCtx = new AudioContext();
    if(audioCtx.state==='suspended') audioCtx.resume();
    const now=audioCtx.currentTime; const osc=audioCtx.createOscillator(); const g=audioCtx.createGain();
    osc.connect(g); g.connect(audioCtx.destination);
    if(type==='pop'){
        osc.frequency.setValueAtTime(800,now); osc.frequency.exponentialRampToValueAtTime(1200,now+0.1);
        g.gain.setValueAtTime(0.05,now); g.gain.exponentialRampToValueAtTime(0.001,now+0.1);
        osc.start(now); osc.stop(now+0.1);
    } else if(type==='fanfare'){
        [440,554,659].forEach((f,i)=>{
             const o=audioCtx.createOscillator(); const gn=audioCtx.createGain(); o.connect(gn); gn.connect(audioCtx.destination);
             o.frequency.value=f; gn.gain.setValueAtTime(0.05,now+i*0.1); gn.gain.linearRampToValueAtTime(0,now+i*0.1+0.5);
             o.start(now+i*0.1); o.stop(now+i*0.1+0.5);
        });
    }
}

// === 5. DATA ENGINE ===
function getHistory(y) { try{return JSON.parse(localStorage.getItem('history-'+y))||{}}catch(e){return{}} }
function saveHistory(y, h) { localStorage.setItem('history-'+y, JSON.stringify(h)); }
function getAvailableYears() {
    let ys = new Set([currentSystemYear]);
    for(let i=0; i<localStorage.length; i++) {
        const k = localStorage.key(i);
        if(k.startsWith('history-')) ys.add(parseInt(k.split('-')[1]));
    }
    return Array.from(ys).sort((a,b)=>b-a);
}

function writeEntry(date, idx, data){
    const y = parseInt(date.split('-')[0]);
    let h = getHistory(y);
    h[date] = h[date] || { total:0, perAnimal:{} };
    h[date].perAnimal[idx] = h[date].perAnimal[idx] || [];
    h[date].perAnimal[idx].push(data);
    h[date].total++;
    saveHistory(y, h);
    return { year:y, date, idx, arrIdx: h[date].perAnimal[idx].length-1 };
}

function removeEntry(date, idx, arrIdx){
    const y = parseInt(date.split('-')[0]);
    let h = getHistory(y);
    if(h[date]?.perAnimal?.[idx]){
        h[date].perAnimal[idx].splice(arrIdx, 1);
        h[date].total--;
        if(h[date].perAnimal[idx].length===0) delete h[date].perAnimal[idx];
        if(h[date].total<=0) delete h[date];
        saveHistory(y, h);
    }
}

// === 30-TAGE CLEANUP ===
function checkTrashAge(){
    const now = Date.now();
    const limit = 30 * 24 * 60 * 60 * 1000; // 30 Tage in ms
    const initialLen = trashBin.length;
    
    // Behalte nur Elemente, die j√ºnger als 30 Tage sind (oder kein Datum haben -> Legacy Schutz)
    trashBin = trashBin.filter(item => {
        if(!item.deletedAt) return true; 
        return (now - item.deletedAt) < limit;
    });
    
    if(trashBin.length !== initialLen) {
        saveGlobals();
        console.log("Papierkorb automatisch bereinigt.");
    }
}

function loadGlobals(){
    try {
        // 1. Tiere laden
        const a = localStorage.getItem('animals-'+currentSystemYear) || localStorage.getItem('animals-'+(currentSystemYear-1));
        animals = a ? JSON.parse(a) : [];
        
        // Datenbank-Migration (optional, falls noch alte Bilder da sind)
        animals.forEach(async (an, i) => {
            if(an.image && !an.imageId && an.image.startsWith('data:')) {
                const newId = 'img_'+Date.now()+'_'+i;
                await dbSaveImg(newId, an.image);
                an.imageId = newId; delete an.image;
                saveGlobals();
            }
        });
        
        // 2. Orte laden
        locations = JSON.parse(localStorage.getItem('locations')||'[]');
        let lc = localStorage.getItem('locCoords');
        if(!lc) lc = localStorage.getItem('locCoords-'+currentSystemYear);
        locCoords = lc ? JSON.parse(lc) : {};

        // 3. PAPIERKORB LADEN (Das fehlte wahrscheinlich!)
        trashBin = JSON.parse(localStorage.getItem('trashBin') || '[]');

        // 4. Einstellungen
        dark = localStorage.getItem('darkmode')==='true';
        if(dark) document.body.classList.add('dark');
        viewMode = localStorage.getItem('viewMode') || 'list';
        sortMode = localStorage.getItem('sortMode') || 'fav';

        // 5. START-AKTIONEN
        // Automatisch alte Sachen l√∂schen (>30 Tage)
        if(typeof checkTrashAge === "function") checkTrashAge();
        
        // Anzeige sofort aktualisieren!
        updateStorageUI(); 
        updateTrashUI(); // <--- Sorgt daf√ºr, dass die Eintr√§ge sofort sichtbar sind
  
       checkBackupHealth();

    } catch(e){ 
        console.error("Fehler beim Laden:", e); 
        // Falls was schief geht, nicht alles l√∂schen, nur Fehler loggen
        showErrorToast("Fehler beim Laden der Daten");
    }
}

function saveGlobals(){
    localStorage.setItem('animals-'+currentSystemYear, JSON.stringify(animals));
    localStorage.setItem('locations', JSON.stringify(locations));
    localStorage.setItem('locCoords', JSON.stringify(locCoords));
    localStorage.setItem('trashBin', JSON.stringify(trashBin));
}

async function updateStorageUI(){
    const count = await dbCount();
    getEl('storageText').innerText = count + " Bilder gespeichert";
    const pct = Math.min((count * 0.5) / 500 * 100, 100);
    getEl('storageBar').style.width = pct + '%';
    getEl('storageBar').style.background = pct > 90 ? 'var(--err-text)' : 'var(--accent)';
}

// === 6. IMAGE COMPRESSION ===
function resizeImage(base64, maxW, cb){
    const img = new Image();
    img.src = base64;
    img.onload = () => {
        const c = document.createElement('canvas');
        const scale = maxW / img.width;
        c.width = maxW;
        c.height = img.height * scale;
        const ctx = c.getContext('2d');
        ctx.drawImage(img, 0, 0, c.width, c.height);
        cb(c.toDataURL('image/jpeg', 0.6));
    };
}

// === 7. CORE LOGIC ===
async function addAnimal(){
    const nm = getEl('nameInput').value.trim();
    if(!nm) return showErrorToast("Name fehlt");
    let imgId = null;
    if(currentTempImg) {
        imgId = 'img_' + Date.now();
        await dbSaveImg(imgId, currentTempImg);
    }
    const tags = getEl('tagInput').value.trim() ? getEl('tagInput').value.split(',').map(s=>s.trim()) : [];
    animals.push({ name:nm, emoji:getEl('emojiInput').value||'üêæ', imageId: imgId, tags, isFav: false });
    getEl('nameInput').value=''; getEl('emojiInput').value=''; getEl('tagInput').value='';
    clearImage();
    saveGlobals(); render(); updateStorageUI();
    showErrorToast("Tier angelegt!", true);
}

function handleImageUpload(input){
    if(input.files && input.files[0]){
        const reader = new FileReader();
        reader.onload = e => resizeImage(e.target.result, 800, res => { // Max 800px width
            currentTempImg = res;
            getEl('previewEl').src = res;
            getEl('imgPreview').style.display='block';
        });
        reader.readAsDataURL(input.files[0]);
    }
}
function clearImage(){ currentTempImg=null; getEl('imgPreview').style.display='none'; }

// === UNDO SYSTEM ===
function showUndoToast(actionDesc, undoFn) {
    const t = getEl('undoToast');
    getEl('undoText').innerText = actionDesc;
    t.classList.add('show');
    clearTimeout(undoTimeout);
    undoStack.push(undoFn);
    undoTimeout = setTimeout(() => {
        t.classList.remove('show');
        undoStack = []; 
    }, 4000);
}

function performUndo() {
    if(undoStack.length > 0) {
        const fn = undoStack.pop(); fn();
        getEl('undoToast').classList.remove('show');
        render(); showErrorToast("R√ºckg√§ngig gemacht", true);
    }
}

function change(i, delta, e){
    if(delta > 0) {
        const locSel = getEl(viewMode === 'grid' ? 'locSelectGrid'+i : 'locSelect'+i);
        const locVal = locSel ? locSel.value : '';
        const entry = { location: locVal, time: nowTimeStr() };
        const date = todayStr();
        const info = writeEntry(date, i, entry);
        playSound('pop');
        if(e && navigator.vibrate) navigator.vibrate(15);
        if(e) spawnParticle(e.clientX, e.clientY, "+1");
        showUndoToast(`Gez√§hlt: ${animals[i].name} (+1)`, () => removeEntry(date, i, info.arrIdx));
        render();
    }
}

function toggleFav(i, e) {
    if(e) e.stopPropagation();
    animals[i].isFav = !animals[i].isFav;
    saveGlobals();
    if(navigator.vibrate) navigator.vibrate(5);
    render();
}

function spawnParticle(x, y, text) {
    const p = document.createElement('div');
    p.className = 'particle'; p.innerText = text; p.style.color = 'var(--accent)';
    p.style.left = x + 'px'; p.style.top = y + 'px';
    document.body.appendChild(p);
    setTimeout(() => p.remove(), 800);
}

// === FIX: EIGENE FUNKTION F√úR ORTE ===
function renderLocations() {
    const locContainer = document.getElementById('locationListDisplay');
    // Falls wir gerade nicht auf der Admin-Seite sind oder das Element fehlt
    if(!locContainer) return;

    locContainer.innerHTML = '';
    
    if(!locations.length) {
        locContainer.innerHTML = '<span style="font-size:13px; opacity:0.5; padding:5px;">Keine Orte gespeichert.</span>';
    } else {
        locations.forEach((l, i) => {
            const pill = document.createElement('div');
            pill.style.cssText = "background:var(--btn); padding:6px 10px; border-radius:15px; font-size:12px; cursor:pointer; display:flex; align-items:center; gap:5px; border:1px solid transparent;";
            pill.innerHTML = `<span>üìç ${l}</span> <span style="color:var(--err-text); font-weight:bold; margin-left:2px;">&times;</span>`;
            
            // WICHTIG: stopPropagation verhindert, dass Klicks auf das X irgendwas anderes ausl√∂sen
            pill.onclick = (e) => { 
                e.stopPropagation(); 
                safeRun(deleteLocation, i); 
            };
            
            locContainer.appendChild(pill);
        });
    }
}

function render() {
    // 1. Orte immer aktuell halten
    if(typeof renderLocations === 'function') renderLocations();

    const list = getEl('list'); 
    list.innerHTML = '';

    // Button Texte aktualisieren
    const viewBtn = getEl('viewToggleBtn');
    const sortBtn = getEl('sortBtn');
    if(viewBtn) viewBtn.innerText = viewMode === 'list' ? 'üìú' : '‚ñ¶';
    if(sortBtn) sortBtn.innerText = sortMode === 'fav' ? '‚≠ê' : (sortMode === 'name' ? 'üî§' : (sortMode === 'count' ? 'üî¢' : 'üïí'));

    const searchVal = getEl('listSearch').value.toLowerCase();
    
    // Filter Tags
    const allTags = new Set(); 
    animals.forEach(a => a.tags?.forEach(t => allTags.add(t)));
    const tagCont = getEl('tagFilterContainer');
    let tagHTML = `<div class="tag-pill ${currentFilter==='ALL'?'active':''}" onclick="safeRun(filterTags, 'ALL')" id="tag-ALL">Alle</div>`;
    allTags.forEach(t => tagHTML += `<div class="tag-pill ${currentFilter===t?'active':''}" onclick="safeRun(filterTags, '${t}')" id="tag-${t}">${t}</div>`);
    if(tagCont) tagCont.innerHTML = tagHTML;

    // Counts berechnen
    const h = getHistory(currentSystemYear);
    
    // Heutige Stats f√ºr Dashboard
    let todayTotal = 0;
    const todayKey = todayStr();
    if(h[todayKey]) todayTotal = h[todayKey].total || 0;

    // Helper f√ºr "Zuletzt gesehen" Sortierung
    const getLastSeen = (idx) => {
        const yData = getHistory(currentSystemYear); 
        let maxTime = 0;
        Object.entries(yData).forEach(([dateStr, d]) => {
            if(d.perAnimal && d.perAnimal[idx]) {
                const lastEntry = d.perAnimal[idx][d.perAnimal[idx].length-1];
                const timeStr = lastEntry.time || "00:00";
                const ts = new Date(dateStr + 'T' + timeStr).getTime();
                if(ts > maxTime) maxTime = ts;
            }
        });
        return maxTime;
    };

    // Liste filtern & mappen
    let displayList = animals.map((a, i) => {
        let count = 0;
        Object.values(h).forEach(day => { if(day.perAnimal?.[i]) count += day.perAnimal[i].length; });
        return { ...a, idx: i, count };
    }).filter(a => {
        if(currentFilter !== 'ALL' && !a.tags?.includes(currentFilter)) return false;
        if(searchVal && !a.name.toLowerCase().includes(searchVal)) return false;
        return true;
    });

    // --- LOGIK: Dashboard vs. Liste ---
    const isSearching = searchVal.length > 0 || currentFilter !== 'ALL';
    const showList = listExpanded || isSearching; 

    // Schwebende Buttons Steuern
    const floatCtrl = getEl('floatingControls');
    if(floatCtrl) {
        if (showList) floatCtrl.classList.add('visible'); 
        else floatCtrl.classList.remove('visible');       
    }

    // 1. Smart Create (bei leerer Suche)
    if(searchVal && displayList.length === 0) {
        getEl('emptyState').style.display='none';
        const searchRaw = getEl('listSearch').value;
        const div = document.createElement('div');
        div.style.textAlign = "center"; div.style.padding = "30px";
        div.innerHTML = `<div style="font-size:40px; margin-bottom:10px;">ü§∑‚Äç‚ôÇÔ∏è</div><div style="margin-bottom:15px; font-weight:bold;">"${searchRaw}" nicht gefunden.</div><button onclick="safeRun(quickCreate, '${searchRaw}')" style="background:var(--accent); color:#fff; padding:12px 20px; font-size:16px;">‚ö° Jetzt schnell anlegen</button>`;
        list.appendChild(div);
        return; 
    }

    // 2. DASHBOARD (Sichtbar wenn Liste zugeklappt & keine Suche)
    if (!isSearching && !listExpanded) {
        // A) Hero Card
        const hero = document.createElement('div');
        hero.className = 'dashboard-hero fade-in';
        hero.style.cursor = 'pointer'; 
        hero.onclick = () => safeRun(openTodayModal); 
        
        hero.innerHTML = `
            <h2>${todayTotal}</h2>
            <p>Tiere heute entdeckt üëÜ</p>
            <div class="hero-bg-icon">üêæ</div>
        `;
        list.appendChild(hero);

        // B) Favoriten Karussell
        const favs = animals.map((a,i)=>({...a, idx:i})).filter(a => a.isFav);
        
        const favsWithCount = favs.map(f => {
            let c = 0; Object.values(h).forEach(day => { if(day.perAnimal?.[f.idx]) c += day.perAnimal[f.idx].length; });
            return {...f, count: c};
        });

        if(favsWithCount.length > 0) {
            const favTitle = document.createElement('div');
            favTitle.className = 'fav-scroll-title fade-in';
            favTitle.innerText = '‚≠ê Schnellzugriff';
            list.appendChild(favTitle);

            const favCont = document.createElement('div');
            favCont.className = 'fav-scroll-container fade-in';
            
            favsWithCount.forEach(f => {
                const fCard = document.createElement('div');
                fCard.className = 'fav-card';
                const imgContainerId = `fav-img-${f.idx}`;
                
                fCard.innerHTML = `
                    <div class="fav-visual" id="${imgContainerId}">${f.emoji}</div>
                    <div class="fav-name">${f.name}</div>
                    <div class="fav-count">${f.count}</div>
                `;
                
                fCard.onclick = (event) => {
                     if(typeof createRipple === "function") createRipple(event); 
                     safeRun(openDetail, f.idx);
                };
                
                if(f.imageId) {
                    dbGetImg(f.imageId).then(src => {
                        if(src) {
                            const el = document.getElementById(imgContainerId);
                            if(el) {
                                el.innerHTML = `<img src="${src}">`;
                                el.style.border = "1px solid var(--btn)"; 
                            }
                        }
                    });
                }
                favCont.appendChild(fCard);
            });
            list.appendChild(favCont);
        }
    }

    // 3. Toggle Button
    if (!isSearching && animals.length > 0) {
        const toggleBtn = document.createElement('div');
        toggleBtn.className = `list-toggle-btn ${showList ? 'is-open' : ''}`;
        const icon = showList ? 'üîº' : 'üîΩ';
        const text = showList ? 'Liste einklappen' : `Alle ${animals.length} Tiere anzeigen`;
        toggleBtn.innerHTML = `<span class="arrow-icon">${icon}</span> ${text}`;
        toggleBtn.onclick = () => {
            listExpanded = !listExpanded;
            if(navigator.vibrate) navigator.vibrate(10);
            render();
        };
        list.appendChild(toggleBtn);
    }

    // Abbrechen wenn zugeklappt
    if (!showList) {
        getEl('emptyState').style.display='none';
        return; 
    }

    if(displayList.length === 0) { getEl('emptyState').style.display='block'; return; }
    getEl('emptyState').style.display='none';

    // Sortierung
    displayList.sort((a,b) => {
        if(sortMode === 'fav') { 
            if (a.isFav && !b.isFav) return -1;
            if (!a.isFav && b.isFav) return 1;
            return a.name.localeCompare(b.name); 
        }
        if(sortMode === 'last') return getLastSeen(b.idx) - getLastSeen(a.idx);
        if(sortMode === 'name') return a.name.localeCompare(b.name);
        return b.count - a.count;
    });

    // Helper f√ºr Highlighting
    const highlightText = (text, query) => {
        if(!query) return text;
        const regex = new RegExp(`(${query})`, 'gi');
        return text.replace(regex, '<mark style="background:rgba(255,235,59,0.5); color:inherit; padding:0 2px; border-radius:2px;">$1</mark>');
    };

    // --- GRID VIEW ---
    if (viewMode === 'grid') {
        const gridCont = document.createElement('div'); gridCont.className = 'grid-container';
        displayList.forEach((item, loopIdx) => {
            const card = document.createElement('div'); 
            card.className = 'grid-item fade-in';
            card.style.animationDelay = `${loopIdx * 0.04}s`; 

            const imgHTML = `<div class="grid-img-wrap" onclick="safeRun(openDetail, ${item.idx})"><div style="font-size:30px">${item.emoji}</div></div>`;
            
            // CLEAN GRID: Nur noch Detail-Klick (Bild) und Plus-Button
            card.innerHTML = `
                <div class="grid-fav ${item.isFav?'active':''}" onclick="safeRun(toggleFav, ${item.idx}, event)">${item.isFav?'‚òÖ':'‚òÜ'}</div>
                ${imgHTML}
                <div class="grid-name">${item.name}</div>
                <div class="grid-count" style="font-weight:bold;color:var(--accent)">${item.count}</div>
                
                <div class="grid-actions">
                     <!-- Der neue Plus Button (√∂ffnet Modal) -->
                     <button class="grid-btn" style="background:var(--accent); color:#fff; flex:1;" onclick="safeRun(openNoteModal,${item.idx})">+</button>
                </div>
            `;
            // FIX: Hier war der Syntaxfehler
            if(item.imageId) { 
                dbGetImg(item.imageId).then(src => { 
                    if(src) {
                        const el = card.querySelector('.grid-img-wrap');
                        if(el) el.innerHTML = `<img src="${src}">`; 
                    }
                }); 
            }
            gridCont.appendChild(card);
        });
        list.appendChild(gridCont);
    } else {
        // --- LIST VIEW ---
        displayList.forEach((item, loopIdx) => {
            const div = document.createElement('div'); 
            const activeClass = item.count > 0 ? 'is-active' : '';
            div.className = `row fade-in ${activeClass}`;
            div.style.animationDelay = `${loopIdx * 0.05}s`; 

            const highlightedName = highlightText(item.name, searchVal);

            // CLEAN LIST: Keine Location, kein extra Plus, Stift wurde zum Plus
            div.innerHTML = `
                <div class="click-area-left" onclick="safeRun(openDetail,${item.idx})" title="Details anzeigen">
                    <div class="name">${highlightedName}</div>
                    <div class="animal-icon">${item.emoji}</div>
                </div>

                <div class="count-badge">${item.count}</div>
                
                <button class="fav-btn ${item.isFav?'active':''}" onclick="safeRun(toggleFav, ${item.idx}, event)" style="margin-right:8px;">${item.isFav?'‚òÖ':'‚òÜ'}</button>
                
                <!-- Der NEUE Plus-Knopf (ehemals Stift). Nutzt das blaue Design, √∂ffnet Modal -->
                <button onclick="safeRun(openNoteModal,${item.idx})" class="action-btn-main" title="Z√§hlen & Notiz">+</button>
            `;
            
            if(item.imageId) { dbGetImg(item.imageId).then(src => { if(src) div.querySelector('.animal-icon').innerHTML = `<img src="${src}">`; }); }
            
            list.appendChild(div);
        });
    }
}

function filterTags(t) { currentFilter=t; render(); }
function cycleSort() { 
    // Reihenfolge: Fav -> Zeit (Last) -> Name -> Anzahl -> Fav...
    if(sortMode === 'fav') sortMode = 'last';
    else if(sortMode === 'last') sortMode = 'name';
    else if(sortMode === 'name') sortMode = 'count';
    else sortMode = 'fav'; // Fallback & Reset auf Fav
    
    // Kleines Feedback (optional)
    // if(navigator.vibrate) navigator.vibrate(5);
    
    render(); 
}
function toggleViewMode() { viewMode = viewMode==='list'?'grid':'list'; localStorage.setItem('viewMode',viewMode); render(); }

// === DETAILS & EDIT ===

async function openDetail(i){
    detailAnimalIdx = i;
    const modal = getEl('detailModal');
    const a = animals[i];
    
    // Header bauen: Icon + Name + EDIT BUTTON
    const iconDiv = getEl('detailIcon');
    
    // Standard Emoji
    iconDiv.innerHTML = a.emoji;
    
    // Bild Logik (mit Lightbox)
    if(a.imageId) { 
        const src = await dbGetImg(a.imageId); 
        if(src) {
            iconDiv.innerHTML = `<img src="${src}" onclick="openImageLightbox('${src}')" style="width:60px;height:60px;border-radius:15px;object-fit:cover;cursor:zoom-in;border:1px solid var(--btn)">`; 
        }
    }
    
    // HIER IST DAS NEUE FEATURE: Der Titel bekommt einen Stift!
    // Wir bauen den Titel-HTML String neu
    const titleContainer = getEl('detailTitle').parentElement; // Das Eltern-Div vom h2
    
    // Name + Stift Button
    getEl('detailTitle').innerHTML = `
        ${a.name} 
        <button onclick="safeRun(openIconEdit, ${i}); closeModal('detailModal');" 
                style="background:transparent; border:none; font-size:18px; cursor:pointer; padding:5px; vertical-align:middle;" 
                title="Tier bearbeiten (Name, Bild, Kategorie)">
            ‚úèÔ∏è
        </button>
    `;

    const ys = getAvailableYears();
    const sel = getEl('detailYearSelect');
    sel.innerHTML = ys.map(y => `<option value="${y}" ${y===currentSystemYear?'selected':''}>${y}</option>`).join('');
    
    updateDetailChart();
    modal.style.display = 'block';
}

// === DETAIL DASHBOARD LOGIK ===
function updateDetailChart() {
    const i = detailAnimalIdx; 
    const y = parseInt(getEl('detailYearSelect').value);
    const h = getHistory(y);
    const body = getEl('modalBody');
    const a = animals[i];
    if(!a) return;

    let total = 0;
    let locs = {};
    let months = new Array(12).fill(0);
    let historyList = [];
    
    // Neue Stats Variablen
    let dailyCounts = {}; 
    let times = { morgens:0, mittags:0, abends:0, nachts:0 }; // 5-11, 11-17, 17-22, 22-5

    // DATEN SAMMELN
    Object.entries(h).forEach(([dateStr, entry]) => {
        if(entry.perAnimal?.[i]){
            const list = entry.perAnimal[i];
            const d = new Date(dateStr);
            
            // Basic Stats
            total += list.length; 
            months[d.getMonth()] += list.length;
            
            // Rekord Tag Berechnung
            dailyCounts[dateStr] = (dailyCounts[dateStr] || 0) + list.length;

            list.forEach((item, arrIdx) => {
                historyList.push({ date:dateStr, item, arrIdx });
                if(item.location) locs[item.location] = (locs[item.location]||0)+1;
                
                // Tageszeit Analyse
                if(item.time) {
                    const hour = parseInt(item.time.split(':')[0]);
                    if(hour >= 5 && hour < 11) times.morgens++;
                    else if(hour >= 11 && hour < 17) times.mittags++;
                    else if(hour >= 17 && hour < 22) times.abends++;
                    else times.nachts++;
                }
            });
        }
    });
    
    // Sortieren & Maxima finden
    historyList.sort((a,b) => b.date.localeCompare(a.date) || (b.item.time||'').localeCompare(a.item.time||''));
    const maxDayVal = Math.max(...Object.values(dailyCounts), 0);
    
    // --- HTML ZUSAMMENBAUEN ---
    
    // 1. HEADER (Die gro√üen Zahlen)
    let html = `
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Gesamt ${y}</div>
            <div class="stat-value">${total}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Tages-Rekord</div>
            <div class="stat-value">${maxDayVal}</div>
        </div>
    </div>`;

    // 2. TAGESZEITEN (Der bunte Balken) - Nur anzeigen wenn Daten da sind
    if(total > 0) {
        const pctM = (times.morgens / total) * 100;
        const pctMi = (times.mittags / total) * 100;
        const pctA = (times.abends / total) * 100;
        const pctN = (times.nachts / total) * 100;
        
        html += `
        <div class="card-section" style="padding:15px; margin-bottom:15px;">
            <h4 style="margin:0 0 10px 0; font-size:14px;">‚è±Ô∏è Tageszeit</h4>
            <div class="time-bar-container">
                <div class="time-segment ts-morgens" style="width:${pctM}%" title="Morgens"></div>
                <div class="time-segment ts-mittags" style="width:${pctMi}%" title="Mittags"></div>
                <div class="time-segment ts-abends" style="width:${pctA}%" title="Abends"></div>
                <div class="time-segment ts-nachts" style="width:${pctN}%" title="Nachts"></div>
            </div>
            <div class="time-legend">
                <span>üåÖ ${times.morgens}</span>
                <span>‚òÄÔ∏è ${times.mittags}</span>
                <span>üåá ${times.abends}</span>
                <span>üåô ${times.nachts}</span>
            </div>
        </div>`;
    }

    // 3. TOP ORTE (Nur wenn vorhanden)
    const sortedLocs = Object.entries(locs).sort((a,b)=>b[1]-a[1]).slice(0,3);
    if(sortedLocs.length) {
        html += `<div class="card-section" style="padding:15px; margin-bottom:15px;"><h4 style="margin:0 0 10px 0; font-size:14px;">üìç Top Orte</h4>`;
        sortedLocs.forEach(([name, val])=>{
            const pct = (val/sortedLocs[0][1])*100;
            html += `<div class="hbar-row"><div class="hbar-label">${name}</div><div class="hbar-track"><div class="hbar-fill" style="width:${pct}%;"></div></div><div class="hbar-val">${val}</div></div>`;
        });
        html += `</div>`;
    }

    // 4. JAHRESTREND (Monate)
    html += `<div class="card-section" style="padding:15px; margin-bottom:15px;">
        <h4 style="margin:0 0 5px 0; font-size:14px;">üóìÔ∏è Jahrestrend</h4>
        <div class="chart-wrap" style="height:80px; padding-top:10px; margin-top:0;">`;
    const maxM = Math.max(...months, 1); 
    const mN = ['J','F','M','A','M','J','J','A','S','O','N','D'];
    months.forEach((v, idx)=> html += `<div class="chart-col"><div class="chart-bar" style="height:${v===0?1:(v/maxM)*100}%; opacity:${v===0?0.1:1}"></div><div class="chart-label">${mN[idx]}</div></div>`);
    html += `</div></div>`;

    // 5. LISTE (Verlauf mit Sticky Header)
    if(historyList.length === 0) html += '<p style="text-align:center; opacity:0.6; margin-top:20px">Keine Sichtungen.</p>';
    else {
        html += `<div style="margin-top:5px; max-height:350px; overflow-y:auto; padding-right:5px;">`;
        let lastDate = '';
        const today = new Date().toISOString().slice(0,10);

        historyList.forEach(row => {
            if(row.date !== lastDate) {
                let displayDate = row.date.split('-').reverse().slice(0,2).join('.');
                if(row.date === today) displayDate = "Heute";
                html += `<div style="position:sticky; top:0; background:var(--card-solid); border:1px solid var(--btn); padding:4px 12px; border-radius:15px; font-size:12px; font-weight:bold; margin:15px auto 5px auto; width:fit-content; z-index:5; box-shadow:0 2px 5px rgba(0,0,0,0.05);">üìÖ ${displayDate}</div>`;
                lastDate = row.date;
            }
            html += `
            <div style="display:flex; justify-content:space-between; align-items:flex-start; padding:10px; margin-bottom:6px; background:var(--bg); border-radius:12px; font-size:14px;">
                <div>
                    <span style="font-weight:bold; opacity:0.8">‚åö ${row.item.time||'--:--'}</span>
                    ${row.item.location ? `<br><span style="font-size:12px; opacity:0.7">üìç ${row.item.location}</span>` : ''}
                    ${row.item.note ? `<br><span style="background:var(--warn-bg); color:var(--warn-text); padding:2px 6px; border-radius:4px; font-size:11px; display:inline-block; margin-top:4px;">üìù ${row.item.note}</span>` : ''}
                </div>
                <div style="display:flex; gap:5px;">
                    <button style="padding:6px; font-size:14px; background:var(--card-solid); border:1px solid var(--btn); border-radius:8px; cursor:pointer;" onclick="safeRun(deleteHistoryItem, '${row.date}', ${i}, ${row.arrIdx})">üóëÔ∏è</button>
                    <button style="padding:6px; font-size:14px; background:var(--card-solid); border:1px solid var(--btn); border-radius:8px; cursor:pointer;" onclick="safeRun(openNoteModal, ${i}, '${row.date}', ${row.arrIdx})">‚úèÔ∏è</button>
                </div>
            </div>`;
        });
        html += `</div>`;
    }
    
    // L√∂sch-Button unten
    html += `<div style="margin-top:20px; text-align:center"><button onclick="safeRun(moveToTrash, ${i})" style="background:var(--err-bg); color:var(--err-text); font-size:12px; padding:10px 20px; border-radius:20px;">Tier in Papierkorb</button></div>`;
    
    body.innerHTML = html;
}

// === PAPIERKORB LOGIK (TIERE & EINTR√ÑGE) ===

// 1. Einzelnen Eintrag l√∂schen -> in Papierkorb
function deleteHistoryItem(date, i, idx) { 
    if(confirm("Eintrag in Papierkorb verschieben?")) { 
        const h = getHistory(parseInt(date.split('-')[0]));
        const entry = h[date].perAnimal[i][idx];
        
        trashBin.push({
            type: 'entry',
            name: animals[i].name, // F√ºr Anzeige
            date: date,
            animalIdx: i,
            data: entry,
            deletedAt: Date.now()
        });
        
        removeEntry(date, i, idx); 
        saveGlobals(); 
        updateTrashUI();
        updateDetailChart(); 
        render(); 
        showErrorToast("In Papierkorb verschoben", true);
    } 
}

 // 2. Ganzes Tier l√∂schen -> in Papierkorb (INKLUSIVE HISTORIE & INDEX-KORREKTUR)
function moveToTrash(i){ 
    const tierName = animals[i].name;
    if(!confirm(`M√∂chtest du "${tierName}" wirklich l√∂schen?\n\nDas Tier UND alle seine ${animals[i].count||0} Eintr√§ge landen im Papierkorb.`)) {
        return; 
    }

    // A) Historie sichern (Alle Jahre durchgehen)
    const archivedHistory = {}; 
    const years = getAvailableYears();
    
    years.forEach(y => {
        const h = getHistory(y);
        let hasData = false;
        
        Object.entries(h).forEach(([dateStr, dayData]) => {
            if(dayData.perAnimal && dayData.perAnimal[i]) {
                if(!archivedHistory[y]) archivedHistory[y] = {};
                // Wir speichern Datum -> Array von Eintr√§gen
                archivedHistory[y][dateStr] = dayData.perAnimal[i]; 
                hasData = true;
            }
        });
    });

    // B) In Papierkorb schieben (Tier + Historie)
    trashBin.push({
        type: 'animal',
        data: { ...animals[i] }, 
        history: archivedHistory, // Das ist NEU: Die kompletten Sichtungen
        name: tierName,
        deletedAt: Date.now()
    });
    
    // C) Historie der verbleibenden Tiere korrigieren (Index-Shift)
    // Wenn wir Tier 2 l√∂schen, wird Tier 3 zu Tier 2. Die Historie muss das auch tun!
    years.forEach(y => {
        const h = getHistory(y);
        let changed = false;
        
        Object.values(h).forEach(dayData => {
            if(!dayData.perAnimal) return;
            
            // 1. Eintrag des gel√∂schten Tiers entfernen
            if(dayData.perAnimal[i]) { delete dayData.perAnimal[i]; changed = true; }
            
            // 2. Alle Indices > i um eins verringern
            // Wir m√ºssen hier vorsichtig sein und eine neue Map aufbauen oder Schl√ºssel verschieben
            const newPerAnimal = {};
            Object.keys(dayData.perAnimal).forEach(k => {
                const idx = parseInt(k);
                if(idx < i) {
                    newPerAnimal[idx] = dayData.perAnimal[idx]; // Bleibt gleich
                } else if (idx > i) {
                    newPerAnimal[idx - 1] = dayData.perAnimal[idx]; // Rutscht eins runter
                    changed = true;
                }
            });
            dayData.perAnimal = newPerAnimal;
        });
        
        if(changed) saveHistory(y, h);
    });

    // D) Tier aus Array entfernen
    animals.splice(i, 1); 
    
    saveGlobals(); 
    render(); 
    updateStorageUI(); 
    updateTrashUI(); 
    closeModal('detailModal'); 
    showErrorToast("In Papierkorb verschoben", true); 
}


// 3. Wiederherstellen (Tier inkl. Historie)
function restoreFromTrash(trashIdx){ 
    const item = trashBin[trashIdx];
    
    if(item.type === 'entry') {
        // Einzelner Eintrag
        writeEntry(item.date, item.animalIdx, item.data);
        showErrorToast("Eintrag wiederhergestellt", true);
    } else {
        // KOMPLETTES TIER
        const animalData = item.data || item; // Fallback f√ºr alte Backups
        
        // 1. Tier wieder ans Ende der Liste anf√ºgen
        animals.push(animalData);
        const newIdx = animals.length - 1; // Das ist der neue Index
        
        // 2. Historie wiederherstellen (falls vorhanden)
        if(item.history) {
            Object.entries(item.history).forEach(([yearStr, datesObj]) => {
                const y = parseInt(yearStr);
                const h = getHistory(y);
                
                Object.entries(datesObj).forEach(([dateStr, entriesArr]) => {
                    // Tag initialisieren falls nicht da
                    h[dateStr] = h[dateStr] || { total:0, perAnimal:{} };
                    h[dateStr].perAnimal[newIdx] = entriesArr; // Hier mit NEUEM Index einf√ºgen
                    h[dateStr].total += entriesArr.length;
                });
                
                saveHistory(y, h);
            });
        }
        
        showErrorToast("Tier & Verlauf wiederhergestellt", true);
    }
    
    trashBin.splice(trashIdx, 1); 
    saveGlobals(); 
    render(); 
    
    // Falls Detailansicht offen war, aktualisieren
    if(getEl('detailModal').style.display === 'block') {
        // Wir m√ºssen das Modal schlie√üen, da sich der Index ge√§ndert hat!
        closeModal('detailModal');
    }
    
    updateStorageUI(); 
}

// 4. Papierkorb leeren	
function emptyTrash(){ 
    if(confirm("Papierkorb unwiderruflich leeren?")){ 
        trashBin = []; 
        saveGlobals(); 
        updateTrashUI(); 
        showErrorToast("Papierkorb geleert", true);
    } 
}

// 5. Papierkorb Eintrag Detailansicht
let currentTrashIdx = null;

function openTrashDetail(i) {
    currentTrashIdx = i;
    const item = trashBin[i];
    const m = getEl('trashDetailModal');
    
    // F√ºlle Daten
    getEl('tdName').innerText = item.name || 'Unbekannt';
    
    if (item.type === 'entry') {
        // --- EINZELNER EINTRAG ---
        getEl('tdType').innerHTML = 'üìù Einzelner Eintrag';
        getEl('tdDate').innerText = item.date;
        getEl('tdTime').innerText = item.data.time || '-';
        getEl('tdLoc').innerText = item.data.location || '-';
        getEl('tdNote').innerText = item.data.note || 'Keine Notiz';
        getEl('tdNote').style.display = 'block';
    } else {
        // --- KOMPLETTES TIER ---
        // Wir z√§hlen mal schnell nach, wie viele Eintr√§ge im Backup stecken
        let countArchived = 0;
        if(item.history) {
            Object.values(item.history).forEach(yearObj => {
                Object.values(yearObj).forEach(dayList => {
                    countArchived += dayList.length;
                });
            });
        }

        // Anzeige mit Z√§hler
        getEl('tdType').innerHTML = `üêæ Komplettes Tier <br><small style="color:var(--accent)">(${countArchived} Sichtungen archiviert)</small>`;
        getEl('tdDate').innerText = new Date(item.deletedAt).toLocaleDateString();
        getEl('tdTime').innerText = '-';
        getEl('tdLoc').innerText = '-';
        getEl('tdNote').style.display = 'none';
    }
    
    // Button Logik
    getEl('tdRestoreBtn').onclick = function() {
        restoreFromTrash(currentTrashIdx);
        closeModal('trashDetailModal');
    };

    m.style.display = 'block';
}

function updateTrashUI(){ 
    const t = getEl('trashList'); 
    const section = getEl('trashSection');
    const emptyBtn = section.querySelector('button'); // Den Button finden
    
    t.innerHTML = ''; // Liste leeren
    
    // WICHTIG: Die Bubble immer sichtbar machen (falls noch hidden gesetzt war)
    section.classList.remove('hidden');

    // FALL 1: Papierkorb ist leer
    if(trashBin.length === 0) {
        t.innerHTML = '<div style="padding:20px; text-align:center; opacity:0.6; font-size:13px; font-style:italic;">üóëÔ∏è Nichts im Papierkorb.<br>Alles sauber!</div>';
        if(emptyBtn) emptyBtn.style.display = 'none'; // Button verstecken
        return;
    }
    
    // FALL 2: Papierkorb hat Inhalt -> Button zeigen
    if(emptyBtn) emptyBtn.style.display = 'block';

    // Hilfsfunktion Zeilen-Erstellung
    const createTrashRow = (item, i) => {
        const daysLeft = item.deletedAt ? Math.ceil((30 * 86400000 - (Date.now() - item.deletedAt)) / 86400000) : 30;
        let info = item.type === 'entry' ? `${item.date}` : 'Tier';
        
        return `
        <div onclick="safeRun(openTrashDetail, ${i})" style="display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px solid var(--btn); cursor:pointer; transition:background 0.2s;" onmouseover="this.style.background='var(--btn)'" onmouseout="this.style.background='transparent'">
            <div style="overflow:hidden;">
                <div style="font-weight:bold; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                    ${item.type==='entry'?'üìù':'üêæ'} ${item.name}
                </div>
                <div style="font-size:11px; opacity:0.7">
                    ${info} ‚Ä¢ noch ${daysLeft} Tage
                </div>
            </div>
            <span style="font-size:18px; color:var(--accent)">‚ÑπÔ∏è</span>
        </div>`;
    };

    // Die ersten 2 Eintr√§ge
    trashBin.slice(0, 2).forEach((item, i) => {
        t.innerHTML += createTrashRow(item, i);
    });

    // Accordion f√ºr den Rest
    if (trashBin.length > 2) {
        let hiddenRows = '';
        trashBin.slice(2).forEach((item, i) => {
            hiddenRows += createTrashRow(item, i + 2);
        });

        t.innerHTML += `
        <details style="margin-top:5px; border-top:1px solid var(--btn);">
            <summary style="padding:10px; font-size:12px; color:var(--accent); cursor:pointer; text-align:center; font-weight:bold; list-style:none;">
                üîΩ Alle anzeigen (${trashBin.length})
            </summary>
            <div style="background:rgba(0,0,0,0.02); border-radius:8px;">
                ${hiddenRows}
            </div>
        </details>
        `;
    }
}

// Hilfsfunktion f√ºr Long-Press
function addLongPress(el, onClick, onLong) {
    let timer;
    const delay = 600; // 0.6 Sekunden dr√ºcken
    let isLong = false;

    const start = (e) => {
        isLong = false;
        timer = setTimeout(() => { isLong = true; onLong(e); }, delay);
    };
    const end = (e) => {
        clearTimeout(timer);
        if (!isLong) onClick(e); // Nur klicken, wenn nicht lange gedr√ºckt wurde
        e.preventDefault(); // Verhindert Ghost-Clicks
    };

    el.addEventListener('touchstart', start, {passive:false});
    el.addEventListener('touchend', end, {passive:false});
    el.addEventListener('mousedown', start);
    el.addEventListener('mouseup', end);
}

// === NOTES ===
let editNoteRef = null;

function openNoteModal(i, date=null, arrIdx=null){
    // Reset Quick Mode (UI aufr√§umen)
    if(typeof isQuickSightingMode !== 'undefined') isQuickSightingMode = false;
    
    // UI auf Normalzustand setzen
    const titleEl = getEl('noteModalTitle');
    if(titleEl) titleEl.innerText = "üìù Notiz & Details";
    
    const wrapper = getEl('noteAnimalWrapper');
    if(wrapper) wrapper.style.display = 'none'; // Suchfeld VERSTECKEN

    const modal = getEl('noteModal');
    const locs = getEl('noteLoc');
    
    // Orte Dropdown f√ºllen
    locs.innerHTML = `<option value="">üìç Ort?</option>${locations.map(l=>`<option>${l}</option>`).join('')}`;
    
    // Bestehende Notiz bearbeiten?
    if(date && arrIdx !== null) {
        editNoteRef = { date, i, arrIdx };
        const h = getHistory(parseInt(date.split('-')[0]));
        // Safety check falls history leer
        if(h && h[date] && h[date].perAnimal && h[date].perAnimal[i]) {
            const entry = h[date].perAnimal[i][arrIdx];
            getEl('noteDate').value = date; 
            getEl('noteTime').value = entry.time||''; 
            getEl('noteLoc').value = entry.location||''; 
            getEl('noteText').value = entry.note||'';
        }
    } else {
        // Neue Notiz f√ºr bestehendes Tier
        editNoteRef = null;
        getEl('noteDate').value = todayStr(); 
        getEl('noteTime').value = nowTimeStr();
        getEl('noteLoc').value = getEl('locSelect'+i)?.value || ''; 
        getEl('noteText').value = '';
    }
    
    // Speicher Button Logik f√ºr dieses spezifische Tier (i)
    getEl('noteSaveBtn').onclick = () => {
        const d = getEl('noteDate').value || todayStr();
        const data = { 
            time: getEl('noteTime').value, 
            location: getEl('noteLoc').value, 
            note: getEl('noteText').value 
        };
        
        // Wenn wir editieren -> alten Eintrag l√∂schen
        if(editNoteRef) removeEntry(editNoteRef.date, editNoteRef.i, editNoteRef.arrIdx);
        else playSound('pop');
        
        // Speichern
        writeEntry(d, i, data);
        
        closeModal('noteModal');
        
        // Falls wir aus der Detailansicht kamen, diese updaten
        if(editNoteRef && getEl('detailModal').style.display === 'block') updateDetailChart();
        
        render();
    };
    
    modal.style.display='block';
}

// === EDIT ANIMAL (NAME, ICON, TAGS, IMAGE) ===
let editIconIdx = null; 
let editIconTemp = null;

async function openIconEdit(i){
    editIconIdx = i; 
    editIconTemp = null;
    const a = animals[i];
    
    // Werte laden
    getEl('editName').value = a.name; // NEU: Name laden
    getEl('editEmoji').value = a.emoji;
    getEl('editTag').value = (a.tags||[]).join(', ');
    
    // Bild Vorschau laden
    const prev = getEl('editPreviewImg');
    const container = getEl('editPreviewContainer');
    
    if(a.imageId) {
        const src = await dbGetImg(a.imageId);
        if(src) {
            prev.src = src;
            container.style.display = 'block';
        } else {
            container.style.display = 'none';
        }
    } else { 
        container.style.display = 'none'; 
    }
    
    getEl('iconModal').style.display='block';
}



function handleEditFile(input){
    if(input.files[0]) {
        const reader = new FileReader();
        reader.onload = e => resizeImage(e.target.result, 800, res => { editIconTemp = res; getEl('editPreviewImg').src = res; getEl('editPreviewContainer').style.display='block'; });
        reader.readAsDataURL(input.files[0]);
    }
}
async function removeEditImage(){ editIconTemp = 'DELETE'; getEl('editPreviewContainer').style.display='none'; }

async function saveIconEdit(){
    if(editIconIdx === null) return;
    const a = animals[editIconIdx];
    
    // 1. Name speichern (NEU)
    const newName = getEl('editName').value.trim();
    if(newName) a.name = newName;
    
    // 2. Rest speichern
    a.emoji = getEl('editEmoji').value || 'üêæ';
    a.tags = getEl('editTag').value.split(',').map(s=>s.trim()).filter(s=>s);
    
    // 3. Bild Logik
    if(editIconTemp === 'DELETE') { 
        if(a.imageId) await dbDelImg(a.imageId); 
        a.imageId = null; 
    }
    else if(editIconTemp) { 
        if(a.imageId) await dbDelImg(a.imageId); 
        const newId = 'img_' + Date.now(); 
        await dbSaveImg(newId, editIconTemp); 
        a.imageId = newId; 
    }
    
    saveGlobals(); 
    render(); 
    updateStorageUI(); 
    
    closeModal('iconModal');
    // Optional: Detailansicht wieder √∂ffnen, falls man von dort kam
    // openDetail(editIconIdx); 
    showErrorToast("√Ñnderungen gespeichert", true);
}

function quickCreate(name) {
    if(!name) return;
    
    // Tier anlegen (Kategorie leer lassen -> User sieht das sp√§ter)
    animals.push({ 
        name: name, 
        emoji: 'üêæ', 
        imageId: null, 
        tags: [], // Noch keine Tags
        isFav: false 
    });
    
    saveGlobals();
    getEl('listSearch').value = ''; // Suche leeren
    
    showErrorToast(`"${name}" angelegt!`, true);
    
    // Wir rendern neu
    render();
    
    // OPTIONAL: Wir √∂ffnen direkt das Bearbeiten Fenster, 
    // falls du es SOFORT kategorisieren willst.
    // Wenn du das NICHT willst (wegen Schnelligkeit), kommentiere die n√§chste Zeile aus:
    // openIconEdit(animals.length - 1); 
}

// === EXPORT / IMPORT ===
async function downloadBackup(){
    const fullHistory = {}; getAvailableYears().forEach(y => fullHistory[y] = getHistory(y));
    const images = {};
    if(animals.length) {
        showErrorToast("Backup wird erstellt... das kann kurz dauern.", true);
        for(let a of animals) { if(a.imageId) { const data = await dbGetImg(a.imageId); if(data) images[a.imageId] = data; } }
    }
    const exportObj = { meta:{v:"6.3", date:new Date()}, animals, locations, locCoords, fullHistory, images, notifyConfig };
    const blob = new Blob([JSON.stringify(exportObj)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `tiere-backup-${todayStr()}.json`; a.click();
    //Nach dem Download:
 localStorage.setItem('lastBackup', Date.now()); 
// Sofort pr√ºfen -> Das entfernt den Punkt und die Box sofort!
 checkBackupHealth(); showErrorToast("Backup erstellt! Super üëç", true); // Positives Feedback
}
function importBackup(e){
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = evt => { try { tempImportData = JSON.parse(evt.target.result); getEl('importModal').style.display='block'; } catch(err) { showErrorToast("Datei besch√§digt"); } };
    reader.readAsText(file);
}
async function confirmImport(mode){
    getEl('importModal').style.display='none'; if(mode==='cancel') return;
    try {
        const d = tempImportData;
        
        // 1. Bilder bereinigen (nur bei Overwrite)
        if(mode==='overwrite') {
            const allKeys = await new Promise(async r => { const db = await dbPromise; const req = db.transaction(STORE_IMGS).objectStore(STORE_IMGS).getAllKeys(); req.onsuccess = () => r(req.result); });
            for(let k of allKeys) await dbDelImg(k); 
            localStorage.clear();
        }
        
        // 2. Neue Bilder speichern
        if(d.images) for(let [id, data] of Object.entries(d.images)) await dbSaveImg(id, data);
        
        // 3. Daten einspielen
        if(mode==='overwrite') {
            animals = d.animals || []; 
            locations = d.locations || []; 
            locCoords = d.locCoords || {}; 
            notifyConfig = d.notifyConfig || notifyConfig;
            
            // WICHTIG: Papierkorb leeren, damit keine fehlerhaften Reste bleiben!
            trashBin = []; 

            if(d.fullHistory) Object.entries(d.fullHistory).forEach(([y, h]) => saveHistory(y, h));
            else if(d.history) saveHistory(currentSystemYear, d.history);
        } else {
            // MERGE (Zusammenf√ºgen) - Papierkorb bleibt wie er ist
            d.animals?.forEach(impA => { if(!animals.some(a => a.name === impA.name)) animals.push(impA); });
            
            // Locations mergen
            if(d.locations) d.locations.forEach(l => { if(!locations.includes(l)) locations.push(l); });

            let entriesToProcess = [];
            if(d.fullHistory) {
                Object.values(d.fullHistory).forEach(yearData => {
                    Object.entries(yearData).forEach(([dateStr, dayContent]) => {
                        if(dayContent.perAnimal) Object.entries(dayContent.perAnimal).forEach(([idxStr, list]) => {
                            let targetIdx = parseInt(idxStr);
                            if(d.animals && d.animals[idxStr]) { const impName = d.animals[idxStr].name; const localIdx = animals.findIndex(a => a.name === impName); if(localIdx !== -1) targetIdx = localIdx; }
                            list.forEach(item => entriesToProcess.push({ date: dateStr, idx: targetIdx, data: item }));
                        });
                    });
                });
            }
            entriesToProcess.forEach(e => { const y = e.date.split('-')[0]; const h = getHistory(y); let exists = false; if(h[e.date]?.perAnimal?.[e.idx]) exists = h[e.date].perAnimal[e.idx].some(ex => ex.time === e.data.time && ex.location === e.data.location); if(!exists) writeEntry(e.date, e.idx, e.data); });
        }
        
        saveGlobals(); 
        render(); 
        updateStorageUI(); 
        updateTrashUI(); // UI aktualisieren, damit Papierkorb-Bubble verschwindet (weil leer)
        showErrorToast("Import fertig!", true); 
        setTimeout(()=>location.reload(), 1500);

    } catch(e) { console.error(e); showErrorToast("Import Fehler: " + e.message); }
}

function exportCSV() {
    let csv = "Datum;Uhrzeit;Tier;Ort;Notiz\n";
    getAvailableYears().forEach(y => {
        const h = getHistory(y);
        Object.entries(h).forEach(([d, val]) => {
             if(val.perAnimal) Object.entries(val.perAnimal).forEach(([idx, list]) => {
                 const name = animals[idx]?.name || 'Unknown';
                 list.forEach(item => csv += `${d};${item.time};"${name}";"${item.location||''}";"${item.note||''}"\n`);
             });
        });
    });
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'tiere-export.csv'; a.click();
}

// === MAP & STATS ===
function initMap() {
    if(mapInstance) { mapInstance.invalidateSize(); return; }
    let center = [51.165, 10.451];
    if(Object.keys(locCoords).length) { const k=Object.keys(locCoords)[0]; center=[locCoords[k].lat, locCoords[k].lon]; }
    mapInstance = L.map('map').setView(center, 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution:'&copy; OSM'}).addTo(mapInstance);
    
    const locCounts = {};
    getAvailableYears().forEach(y => {
        const h = getHistory(y);
        Object.values(h).forEach(d => { if(d.perAnimal) Object.values(d.perAnimal).forEach(list => list.forEach(item => { if(item.location && locCoords[item.location]) locCounts[item.location] = (locCounts[item.location]||0)+1; })); });
    });
    Object.entries(locCounts).forEach(([name, count]) => {
        const c = locCoords[name];
        L.marker([c.lat, c.lon]).addTo(mapInstance).bindPopup(`<b>${name}</b><br>${count} Sichtungen`);
    });
}


    function renderStats(){
    const ct = getEl('statsContent'); 
    const ys = getAvailableYears(); 
    const sel = getEl('statsYearSelect');
    
    // Dropdown f√ºllen falls leer
    if(sel.options.length !== ys.length) {
        sel.innerHTML = ys.map(y => `<option value="${y}" ${y===currentSystemYear?'selected':''}>${y}</option>`).join('');
    }
    
    const sYr = parseInt(sel.value) || currentSystemYear;
    
    // 1. GLOBALE STATS (F√ºr Level & XP - √ºber ALLE Jahre)
    let gTot=0, gNote=0, gLoc=new Set(), streak=0;
    ys.forEach(y => {
        const h = getHistory(y); 
        Object.values(h).forEach(e => {
            gTot += (e.total||0); 
            if(e.perAnimal) Object.values(e.perAnimal).forEach(l => l.forEach(x => {
                if(x.note) gNote++;
                if(x.location) gLoc.add(x.location);
            }));
        });
    });
    
    // 2. JAHRES STATS (F√ºr das gew√§hlte Jahr sYr)
    const th = getHistory(sYr);
    let yTot = 0, yWk = 0, yDistinct = new Set();
    let time = { Morgens:0, Mittags:0, Abends:0, Nachts:0 };
    let mCounts = new Array(12).fill(0);
    
    // --- NEU: Z√ÑHLER PRO TIER (F√ºr Top 3) ---
    let animalCounts = {}; // { animalIndex: count }

    Object.entries(th).forEach(([dStr, e]) => {
        yTot += e.total; 
        mCounts[new Date(dStr).getMonth()] += e.total; 
        if([0,6].includes(new Date(dStr).getDay())) yWk += e.total;
        
        if(e.perAnimal) {
            Object.entries(e.perAnimal).forEach(([k, l]) => { 
                const idx = parseInt(k);
                const aName = animals[idx]?.name || '???';
                yDistinct.add(aName); 
                
                // F√ºr Top 3 z√§hlen
                animalCounts[idx] = (animalCounts[idx] || 0) + l.length;

                l.forEach(x => {
                    if(x.time){
                        const h = parseInt(x.time); 
                        if(h>=5 && h<11) time.Morgens++;
                        else if(h>=11 && h<14) time.Mittags++;
                        else if(h>=14 && h<22) time.Abends++;
                        else time.Nachts++;
                    }
                }); 
            });
        }
    });

    // 3. LEVEL BERECHNUNG
    const photo = animals.some(a => a.imageId);
    // Streak Berechnung (einfach)
    const dates = Object.keys(th).sort((a,b) => new Date(b)-new Date(a));
    if(dates.length){ 
        const dh = (new Date(todayStr())-new Date(dates[0]))/36e5; 
        if(dh <= 48){
            streak = 1;
            for(let i=0; i<dates.length-1; i++) {
                if(Math.round((new Date(dates[i])-new Date(dates[i+1]))/864e5)===1) streak++; else break;
            }
        }
    }

    const xp = (gTot*40) + (gNote*75) + (animals.length*50) + (photo?100:0) + (gLoc.size*25) + (streak*100);
    let lvl = levels[0], nxt = null; 
    for(let l of levels){ if(xp >= l.xp){ lvl = l; } else { nxt = l; break; }}
    const pct = nxt ? Math.min(((xp-lvl.xp)/(nxt.xp-lvl.xp))*100,100) : 100;

    // --- HTML ZUSAMMENBAUEN ---
    let html = `<div class="level-card"><div class="level-title">Level ${levels.indexOf(lvl)+1}</div><div class="level-num">${lvl.name}</div><div class="xp-bar-bg"><div class="xp-bar-fill" style="width:${pct}%"></div></div><div class="xp-text">${xp} XP ${nxt?`(noch ${nxt.xp-xp})`:'MAX'}</div></div>`;
    
    html += `<details style="margin-bottom:20px;border:1px solid var(--btn);border-radius:12px;padding:10px;"><summary>‚ÑπÔ∏è Level-√úbersicht</summary><div style="max-height:200px;overflow-y:auto;margin-top:10px;"><table class="level-table"><tr><th>Lvl</th><th>Name</th><th>XP</th></tr>${levels.map((l,i)=>`<tr class="${l===lvl?'current-level':''}"><td>${i+1}</td><td>${l.name}</td><td>${l.xp}</td></tr>`).join('')}</table></div></details>`;

    if(gTot === 0) { ct.innerHTML = html+'<div style="text-align:center">Noch keine Daten.</div>'; return; }

    // KPI ROW
    html += `<div class="stat-kpi-row"><div class="stat-kpi"><h2>${yTot}</h2><small>Sichtungen ${sYr}</small></div><div class="stat-kpi"><h2>${yDistinct.size}</h2><small>Arten ${sYr}</small></div><div class="stat-kpi"><h2>${streak}</h2><small>Streak</small></div></div>`;

    // --- NEU: TOP 3 SECTION ---
    // Sortieren nach Anzahl
    const sortedTop = Object.entries(animalCounts)
        .map(([idx, count]) => ({ idx: parseInt(idx), count }))
        .sort((a,b) => b.count - a.count)
        .slice(0, 3); // Nur die Top 3

    if(sortedTop.length > 0) {
        const medals = ['ü•á', 'ü•à', 'ü•â'];
        const maxVal = sortedTop[0].count; // F√ºr Balken-Prozent

        html += `<div class="card-section"><h3>üèÜ Top 3 Lieblinge (${sYr})</h3><div class="top3-container">`;
        
        sortedTop.forEach((item, rank) => {
            const a = animals[item.idx];
            if(!a) return;
            const percent = (item.count / maxVal) * 100;
            const imgId = `stat-top3-${item.idx}-${sYr}`; // Unique ID f√ºr Bild-Loader

            html += `
            <div class="top3-row">
                <div class="top3-bar" style="width:${percent}%"></div>
                <div class="top3-medal">${medals[rank]}</div>
                <div class="top3-img" id="${imgId}">${a.emoji}</div>
                <div class="top3-info">
                    <span>${a.name}</span>
                    <span class="top3-count">${item.count}</span>
                </div>
            </div>`;

            // Bild asynchron nachladen
            if(a.imageId) {
                dbGetImg(a.imageId).then(src => {
                    const el = document.getElementById(imgId);
                    if(src && el) {
                        el.innerHTML = `<img src="${src}">`;
                        el.style.border = "none"; // Rahmen entfernen bei Bild
                    }
                });
            }
        });
        html += `</div></div>`;
    }
    // --- ENDE TOP 3 ---

    // TROPH√ÑEN
    const badges=[
          {i:'üê£',n:'Starter',c:gTot>=1},{i:'ü•â',n:'Sammler',c:gTot>=50},{i:'ü•à',n:'Profi',c:gTot>=100},{i:'üëë',n:'Legende',c:gTot>=250},{i:'ü™ê',n:'Titan',c:gTot>=1000},
          {i:'üî•',n:'On Fire',c:streak>=3},{i:'‚ö°',n:'Marathon',c:streak>=7},{i:'üìÖ',n:'Weekend',c:yWk>0},{i:'üç±',n:'Mittag',c:time.Mittags>0},
          {i:'üåà',n:'Arche',c:yDistinct.size>=10},{i:'üß¨',n:'Darwin',c:yDistinct.size>=25},{i:'üåç',n:'Entdecker',c:gLoc.size>=3},
          {i:'üó∫Ô∏è',n:'Globe',c:gLoc.size>=10},{i:'üì∏',n:'Paparazzi',c:photo},{i:'ü¶â',n:'Nachteule',c:time.Nachts>0},{i:'üêì',n:'Fr√ºh',c:time.Morgens>0}
    ];
    html += `<div class="card-section"><h3>üèÜ Troph√§en</h3><div class="badge-grid">`+badges.map(b=>`<div class="badge ${b.c?'earned':''}"><span class="badge-icon">${b.i}</span> ${b.n}</div>`).join('')+`</div></div>`;
    
    // TAGESZEITEN
    const maxT = Math.max(...Object.values(time), 1);
    html += `<div class="card-section"><h3>‚è±Ô∏è Tageszeiten</h3>`+Object.entries(time).map(([l,v])=>`<div class="hbar-row"><div class="hbar-label" style="width:80px">${l}</div><div class="hbar-track"><div class="hbar-fill" style="width:${(v/maxT)*100}%;opacity:0.8"></div></div><div class="hbar-val">${v}</div></div>`).join('')+`</div>`;
    
    // JAHRES CHART
    html += `<div class="card-section"><h3>üóìÔ∏è Jahr ${sYr}</h3><div class="chart-wrap">`+mCounts.map((v,i)=>`<div class="chart-col"><div class="chart-bar" style="height:${v?(v/Math.max(...mCounts))*100:1}%;opacity:${v?1:0.1}"></div><div class="chart-label">${['J','F','M','A','M','J','J','A','S','O','N','D'][i]}</div></div>`).join('')+`</div></div>`;
    
    // HEATMAP
    let refDate = (sYr === currentSystemYear) ? new Date() : new Date(sYr, 11, 31);
    html += `<div class="card-section"><h3>üî• 30 Tage Heatmap</h3><div class="heatmap-grid">`;
    for(let i=27; i>=0; i--){
        const d = new Date(refDate); d.setDate(d.getDate() - i); const iso = d.toISOString().slice(0,10);
        const count = getHistory(d.getFullYear())[iso]?.total || 0;
        html += `<div class="heat-cell" style="background:${count>0?`rgba(33, 150, 243, ${Math.min(count*0.2+0.2,1)})`:'var(--btn)'}; color:${count>0?'#fff':'transparent'}; font-weight:bold;">${count||''}</div>`;
    }
    html += `</div></div>`;
    
    ct.innerHTML = html;
}

function generateShareCard() {
    const canvas = document.createElement('canvas'); canvas.width = 600; canvas.height = 400; const ctx = canvas.getContext('2d');
    ctx.fillStyle = dark ? '#1e1e1e' : '#f4f4f4'; ctx.fillRect(0,0,600,400);
    ctx.fillStyle = dark ? '#fff' : '#000'; ctx.font = 'bold 30px sans-serif'; ctx.textAlign = 'center'; ctx.fillText(`Meine Tiersammlung ${currentSystemYear}`, 300, 50);
    const h = getHistory(currentSystemYear); let total = 0; Object.values(h).forEach(d=>total+=d.total||0);
    ctx.font = 'bold 80px sans-serif'; ctx.fillStyle = '#2196f3'; ctx.fillText(total, 300, 180);
    ctx.font = '20px sans-serif'; ctx.fillStyle = '#888'; ctx.fillText("Sichtungen Gesamt", 300, 220);
    const link = document.createElement('a'); link.download = `tier-stats-${currentSystemYear}.png`; link.href = canvas.toDataURL(); link.click();
}

// === NOTIFICATIONS & UTILS ===
function saveNotifySettings(){
    notifyConfig.enabled = getEl('notifyToggle').checked;
    notifyConfig.days = parseInt(getEl('notifyDays').value) || 7;
    localStorage.setItem('notifyConfig', JSON.stringify(notifyConfig));
    showErrorToast("Einstellungen gespeichert", true); closeModal('notifyModal');
}
function testNotification(){
    if (Notification.permission === "granted") new Notification("Tier-Tracker", { body: "Test-Erinnerung: Zeit zu z√§hlen! üêæ" });
    else if (Notification.permission !== "denied") Notification.requestPermission().then(p => { if (p === "granted") new Notification("Test", { body: "Erinnerungen aktiviert." }); });
}
function downloadICS() {
    let ics = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//TierTracker//DE\nBEGIN:VEVENT\nSUMMARY:Tiere z√§hlen üêæ\nRRULE:FREQ=" + getEl('icsFreq').value + (getEl('icsFreq').value==='WEEKLY' ? ";BYDAY="+getEl('icsDay').value : "") + "\nDTSTART:" + todayStr().replace(/-/g,'') + "T" + getEl('icsTime').value.replace(':','') + "00\nDURATION:PT15M\nDESCRIPTION:Zeit deine Beobachtungen einzutragen!\nEND:VEVENT\nEND:VCALENDAR";
    const a = document.createElement('a'); a.href = 'data:text/calendar;charset=utf-8,' + encodeURIComponent(ics); a.download = 'tiere-erinnerung.ics'; a.click();
}

function toggleDarkMode(){ dark=!dark; localStorage.setItem('darkmode',dark); document.body.classList.toggle('dark', dark); }
function switchView(id, btn){
    document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active')); getEl(id).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); if(btn) btn.classList.add('active');
    if(id==='view-map') setTimeout(initMap, 200); if(id==='view-stats') renderStats();
}
function toggleInfo(){ const b = getEl('infoBox'); b.style.display = b.style.display==='none'?'block':'none'; }
function openNotifySettings(){ 
    // Vorhandene Settings laden
    getEl('notifyToggle').checked = notifyConfig.enabled;
    getEl('notifyDays').value = notifyConfig.days;

    // NEU: Kompakt-Modus Status setzen
    const compactBox = getEl('compactToggle');
    if(compactBox) compactBox.checked = isCompact;

    getEl('notifyModal').style.display='block'; 
}
function closeModal(id){ getEl(id).style.display='none'; }
function hardReset(){ if(confirm("ALLES L√ñSCHEN?")) { localStorage.clear(); location.reload(); } }

// === GPS ===
function locateMe(){
    if(!navigator.geolocation) return showErrorToast("Kein GPS");
    showErrorToast("Suche Position...", true);
    navigator.geolocation.getCurrentPosition(p => {
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${p.coords.latitude}&lon=${p.coords.longitude}&zoom=18`)
        .then(r=>r.json()).then(d => {
            const name = (d.address.road || d.address.village || d.address.city || "Ort");
            getEl('osmInput').value = name; locCoords[name] = {lat:p.coords.latitude, lon:p.coords.longitude};
        }).catch(()=>showErrorToast("Ort nicht gefunden"));
    });
}

function addManualLocation(){ 
    const v = getEl('osmInput').value; 
    if(v && !locations.includes(v)) { 
        locations.push(v); 
        saveGlobals(); 
        
        renderLocations(); // <--- HIER GE√ÑNDERT (statt render())
        
        showErrorToast("Ort gespeichert", true); 
    } 
}

function deleteLocation(i) {
    if(confirm(`Ort "${locations[i]}" wirklich l√∂schen?`)) {
        locations.splice(i, 1);
        saveGlobals();
        
        renderLocations(); // <--- HIER GE√ÑNDERT (statt render())
        
        showErrorToast("Ort gel√∂scht", true);
    }
}

// === AUTOCOMPLETE LOGIC FROM FILE 2 ===
getEl('osmInput').addEventListener('keydown', (e) => { if(e.key === 'Enter') addManualLocation(); });
getEl('osmInput').addEventListener('input', e => { 
    if(e.target.value.length<3) { getEl('osmResults').style.display='none'; return; }
    clearTimeout(window.osmDebounce); 
    window.osmDebounce = setTimeout(() => { 
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${e.target.value}`)
        .then(r=>r.json()).then(d => { 
            const res = getEl('osmResults'); res.innerHTML='';
            if(d.length) {
                res.style.display='block';
                d.slice(0,3).forEach(x => { 
                    const div = document.createElement('div'); div.className='suggestion-item'; div.innerText=x.display_name.split(',')[0]; 
                    div.onclick=()=>{ getEl('osmInput').value=div.innerText; locCoords[div.innerText]={lat:parseFloat(x.lat),lon:parseFloat(x.lon)}; res.style.display='none'; addManualLocation(); }; 
                    res.appendChild(div); 
                });
            } else { res.style.display='none'; }
        }); 
    }, 500); 
});
document.addEventListener('click', (e) => { if(e.target !== getEl('osmInput')) getEl('osmResults').style.display='none'; });


// === LIGHTBOX LOGIC ===
function openImageLightbox(src) {
    const modal = document.getElementById('lightboxModal');
    const img = document.getElementById('lightboxImg');
    img.src = src;
    modal.style.display = 'flex';
    // Kleiner Timeout f√ºr Animationseffekt
    setTimeout(() => modal.classList.add('active'), 10);
}

function closeImageLightbox() {
    const modal = document.getElementById('lightboxModal');
    modal.classList.remove('active');
    setTimeout(() => modal.style.display = 'none', 200);
}


// --- UPDATE: Backup Health Check (Erweitert um Header Badge) ---
function checkBackupHealth() {
    const last = localStorage.getItem('lastBackup');
    const now = Date.now();
    const daysSince = last ? Math.floor((now - last) / (1000 * 60 * 60 * 24)) : 100;
    
    // Elemente holen
    const adminBtn = document.querySelectorAll('.nav-item')[1]; 
    const existingBadge = adminBtn ? adminBtn.querySelector('.warn-badge') : null;
    
    // Die Box innen
    const warnBox = getEl('backupWarningBox');
    const daysText = getEl('backupDaysCount');
    
    // Der Badge auf dem Header (wenn zugeklappt)
    const headerBadge = getEl('backupHeaderBadge');

    // Schwelle: Warnen ab 14 Tagen
    if (daysSince > 14) {
        // 1. Roter Punkt in der Navigation
        if (adminBtn && !existingBadge) {
            const badge = document.createElement('div');
            badge.className = 'warn-badge';
            badge.style.cssText = "position:absolute; top:5px; right:20px; width:10px; height:10px; background:var(--err-text); border-radius:50%; border:2px solid var(--card); z-index:10;";
            adminBtn.style.position = 'relative';
            adminBtn.appendChild(badge);
        }

        // 2. Warnbox innen (Text setzen)
        if(warnBox) {
            warnBox.style.display = 'flex';
            const timeText = last ? `vor ${daysSince} Tagen` : "noch nie";
            daysText.innerText = timeText;
        }
        
        // 3. NEU: Warnbadge auf dem Header anzeigen
        if(headerBadge) {
            headerBadge.style.display = 'block';
        }

    } else {
        // Alles gut: Aufr√§umen
        if (existingBadge) existingBadge.remove();
        if (warnBox) warnBox.style.display = 'none';
        if (headerBadge) headerBadge.style.display = 'none'; // Header Badge weg
    }
}

// Scroll Monitor
window.addEventListener('scroll', () => {
    const btn = getEl('scrollTopBtn');
    if(window.scrollY > 300) { // Erst ab 300px Scrolltiefe zeigen
        btn.style.display = 'flex';
        btn.style.opacity = '1';
    } else {
        btn.style.display = 'none';
    }
}, {passive: true});

// === NEW: OPEN TODAY MODAL ===
function openTodayModal() {
    const listCont = getEl('todayListContainer');
    listCont.innerHTML = ''; // Reset
    
    const h = getHistory(currentSystemYear);
    const todayKey = todayStr();
    const todayData = h[todayKey];

    if (!todayData || !todayData.perAnimal || todayData.total === 0) {
        listCont.innerHTML = '<div style="text-align:center; padding:40px; opacity:0.6">Noch keine Tiere heute.<br>Geh raus und such welche! üå≥</div>';
        getEl('todayModal').style.display = 'block';
        return;
    }

    // 1. Alle heutigen Eintr√§ge in eine flache Liste sammeln
    let timeline = [];
    Object.keys(todayData.perAnimal).forEach(idxStr => {
        const idx = parseInt(idxStr);
        const entries = todayData.perAnimal[idx];
        const animal = animals[idx];
        
        entries.forEach((entry, arrIdx) => {
            timeline.push({
                animalIdx: idx,
                name: animal.name,
                emoji: animal.emoji,
                time: entry.time || '00:00',
                location: entry.location || '',
                note: entry.note || '',
                arrIdx: arrIdx // F√ºr Editieren/L√∂schen wichtig
            });
        });
    });

    // 2. Sortieren nach Uhrzeit (Neueste oben)
    timeline.sort((a, b) => b.time.localeCompare(a.time));

    // 3. HTML generieren
    timeline.forEach((item, i) => {
        // Animation Delay f√ºr sch√∂nen Effekt
        const delay = i * 0.05;
        
        const row = document.createElement('div');
        row.className = 'today-row';
        row.style.animationDelay = delay + 's';
        
        // Falls keine Zeit eingetragen ist, zeigen wir "--:--"
        const displayTime = item.time === '00:00' ? '--:--' : item.time;
        
        let detailsHTML = '';
        if(item.location) detailsHTML += `<div style="margin-top:4px">üìç ${item.location}</div>`;
        if(item.note) detailsHTML += `<div style="margin-top:4px; font-style:italic; opacity:0.8">" ${item.note} "</div>`;
        if(!item.location && !item.note) detailsHTML += `<div style="margin-top:4px; opacity:0.5; font-size:11px">Keine Details</div>`;

        row.innerHTML = `
            <div class="today-time-col">
                <div class="today-time-text">${displayTime}</div>
                <div class="today-line"></div>
            </div>
            <div class="today-bubble" onclick="safeRun(openDetail, ${item.animalIdx})">
                <div class="today-header">
                    <div class="today-animal-name">${item.emoji} ${item.name}</div>
                    <span style="font-size:12px; color:var(--accent)">‚ûî</span>
                </div>
                <div class="today-details">
                    ${detailsHTML}
                </div>
            </div>
        `;
        listCont.appendChild(row);
    });

    // Letzte Linie ausblenden (kosmetisch)
    if(listCont.lastChild) {
        listCont.lastChild.querySelector('.today-line').style.background = 'transparent';
    }

    getEl('todayModal').style.display = 'block';
}

// --- NEUE FUNKTION: Akkordeon umschalten ---
function toggleAccordion(headerElement) {
    // Wir klicken auf den Header, wollen aber die ganze Sektion √∂ffnen
    const section = headerElement.closest('.card-section');
    section.classList.toggle('open');
}
// WICHTIG: Inputs innerhalb des Akkordeons d√ºrfen das Zuklappen nicht ausl√∂sen.
// Das habe ich im HTML oben schon mit onclick="event.stopPropagation()" gel√∂st.


// === QUICK SIGHTING LOGIC ===
let isQuickSightingMode = false;

function openQuickSighting() {
    isQuickSightingMode = true;
    const modal = getEl('noteModal');
    
    // UI anpassen
    getEl('noteModalTitle').innerText = "‚ûï Neue Sichtung";
    getEl('noteAnimalWrapper').style.display = 'block'; // Suchfeld zeigen
    getEl('noteAnimalInput').value = '';
    getEl('noteAnimalResults').style.display = 'none';
    getEl('noteAnimalInput').focus();

    // Standardwerte f√ºr Zeit/Ort
    getEl('noteDate').value = todayStr(); 
    getEl('noteTime').value = nowTimeStr();
    getEl('noteLoc').innerHTML = `<option value="">üìç Ort?</option>${locations.map(l=>`<option>${l}</option>`).join('')}`;
    getEl('noteText').value = '';

    // Autocomplete Logik f√ºr das Tier-Suchfeld
    const inp = getEl('noteAnimalInput');
    inp.oninput = (e) => {
        const val = e.target.value.toLowerCase();
        const res = getEl('noteAnimalResults');
        res.innerHTML = '';
        
        if(val.length < 1) { res.style.display='none'; return; }
        
        // Suche nach existierenden Tieren
        const matches = animals.filter(a => a.name.toLowerCase().includes(val));
        
        if(matches.length > 0) {
            res.style.display = 'block';
            matches.slice(0, 5).forEach(a => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.innerHTML = `${a.emoji} <b>${a.name}</b>`;
                div.onclick = () => {
                    inp.value = a.name; // Name √ºbernehmen
                    res.style.display = 'none';
                };
                res.appendChild(div);
            });
        } else {
            res.style.display = 'none';
        }
    };

    // Speicher-Button Logik √ºberschreiben/anpassen
    getEl('noteSaveBtn').onclick = () => {
        const animalName = getEl('noteAnimalInput').value.trim();
        if(!animalName) return showErrorToast("Bitte Tiernamen eingeben");

        // 1. Pr√ºfen ob Tier existiert
        let idx = animals.findIndex(a => a.name.toLowerCase() === animalName.toLowerCase());
        
        // 2. Wenn nicht: Automatisch erstellen
        if(idx === -1) {
            animals.push({ 
                name: animalName, // Den eingegebenen Namen nehmen (Gro√ü/Klein wie User will)
                emoji: 'üêæ', 
                imageId: null, 
                tags: [], 
                isFav: false 
            });
            idx = animals.length - 1;
            showErrorToast(`Neues Tier "${animalName}" erstellt!`, true);
            saveGlobals(); // Tier speichern
        }

        // 3. Eintrag schreiben
        const d = getEl('noteDate').value || todayStr();
        const data = { 
            time: getEl('noteTime').value, 
            location: getEl('noteLoc').value, 
            note: getEl('noteText').value 
        };
        
        playSound('pop');
        writeEntry(d, idx, data);
        
        closeModal('noteModal');
        render(); // Aktualisiert Liste & Dashboard
    };

    modal.style.display = 'block';
}


// STARTUP
loadGlobals(); render(); initSwipeGestures();


</script>
</body>
</html>
